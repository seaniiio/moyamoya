<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>모임 서비스</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Pretendard Font CDN -->
    <link
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css"
      rel="stylesheet" />
    <style>
      body {
        font-family: "Pretendard", sans-serif; /* Changed font to Pretendard */
        background-color: #f0f2f5; /* Light gray background */
        color: #333;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
      }
      .container {
        background-color: #ffffff;
        border-radius: 1.5rem; /* More rounded corners */
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); /* Softer, larger shadow */
        width: 100%;
        max-width: 960px; /* Max width for desktop */
        margin: 2rem;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 80vh;
      }
      header {
        background-color: #4285f4; /* Google Blue */
        color: white;
        padding: 1.5rem 2rem;
        border-top-left-radius: 1.5rem;
        border-top-right-radius: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        font-size: 1.5rem;
        flex-wrap: wrap; /* Allow header content to wrap */
        gap: 1rem; /* Gap between header sections */
      }
      header .back-button {
        background: none;
        border: none;
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0.5rem 1rem;
        border-radius: 0.75rem;
        transition: background-color 0.2s ease-in-out;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      header .back-button:hover {
        background-color: rgba(255, 255, 255, 0.2);
      }
      header .header-title-container {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-shrink: 0; /* Prevent shrinking too much */
      }
      header .header-right-section {
        display: flex;
        align-items: center;
        gap: 0.5rem; /* Reduced gap for better fit */
        flex-wrap: wrap; /* Allow wrapping on smaller screens */
        justify-content: flex-end; /* Align to end when wrapped */
        flex-grow: 1; /* Allow it to take available space */
        min-width: 0; /* Allow content to shrink */
      }
      header .header-right-section .welcome-message {
        font-size: 1rem; /* Default smaller font for welcome message */
        white-space: normal; /* Allow wrapping on small screens */
        flex-shrink: 0; /* Prevent welcome message from shrinking */
        text-align: right; /* Align text to right within its space */
      }
      @media (min-width: 768px) {
        /* Adjust for larger screens */
        header .header-right-section {
          gap: 1rem; /* Restore larger gap on larger screens */
        }
        header .header-right-section .welcome-message {
          font-size: 1.25rem; /* Larger font on larger screens */
          white-space: nowrap; /* Keep on one line for larger screens */
        }
      }

      nav {
        background-color: #e8f0fe; /* Light blue for nav */
        padding: 0.5rem 2rem;
        display: flex;
        gap: 1rem;
        border-bottom: 1px solid #d2e3fc;
      }
      nav button {
        padding: 0.75rem 1.25rem;
        border-radius: 0.75rem;
        font-weight: 500;
        color: #4285f4;
        background-color: transparent;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
      }
      nav button.active {
        background-color: #4285f4;
        color: white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      nav button:hover:not(.active) {
        background-color: #d2e3fc;
      }
      .content {
        padding: 2rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        /* Added for smooth transitions */
        transition: opacity 0.3s ease-in-out;
      }
      /* Styles for fade-out and fade-in animations */
      .content.fade-out {
        opacity: 0;
      }
      .content.fade-in {
        opacity: 0; /* Start from invisible for fade-in */
      }

      .card {
        background-color: #ffffff;
        border-radius: 1rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: transform 0.2s ease-in-out;
        cursor: pointer;
        border: 1px solid #e0e0e0;
      }
      .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
      }
      .card-title {
        font-weight: 600;
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
        color: #1a73e8; /* Google Blue */
      }
      .card-subtitle {
        font-size: 0.9rem;
        color: #616161;
        margin-bottom: 0.75rem;
      }
      .card-text {
        font-size: 1rem;
        color: #424242;
        line-height: 1.5;
      }

      /* Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
      }
      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }
      .modal-content {
        background-color: #ffffff;
        padding: 2rem;
        border-radius: 1.5rem;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        width: 90%;
        max-width: 500px;
        /* Flexbox for internal layout to allow scrolling body */
        display: flex;
        flex-direction: column;
        max-height: 90vh; /* Limit height to enable scrolling */
        transform: translateY(-20px);
        opacity: 0;
        transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        position: relative; /* For close button positioning */
      }
      .modal-overlay.show .modal-content {
        transform: translateY(0);
        opacity: 1;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-shrink: 0; /* Prevent header from shrinking */
      }
      .modal-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1a73e8;
      }
      .modal-close-button {
        background: none;
        border: none;
        font-size: 2rem;
        color: #616161;
        cursor: pointer;
        transition: color 0.2s ease-in-out;
      }
      .modal-close-button:hover {
        color: #333;
      }
      .modal-body {
        flex-grow: 1; /* Allow body to take available space */
        overflow-y: auto; /* Enable vertical scrolling for body content */
        padding-right: 0.5rem; /* Add some padding for scrollbar */
        margin-right: -0.5rem; /* Counteract scrollbar padding for full width */
      }
      .modal-body label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #424242;
      }
      .modal-body input[type="text"],
      .modal-body input[type="date"],
      .modal-body input[type="time"],
      .modal-body input[type="number"],
      .modal-body textarea,
      .modal-body select {
        width: 100%;
        padding: 0.75rem;
        margin-bottom: 1rem;
        border: 1px solid #ccc;
        border-radius: 0.75rem;
        font-size: 1rem;
        box-sizing: border-box;
        transition: border-color 0.2s ease-in-out;
      }
      .modal-body input:focus,
      .modal-body textarea:focus,
      .modal-body select:focus {
        outline: none;
        border-color: #4285f4;
        box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
      }
      .modal-body textarea {
        min-height: 100px;
        resize: vertical;
      }
      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 1.5rem;
        flex-shrink: 0; /* Prevent footer from shrinking */
      }
      .modal-footer button {
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out,
          box-shadow 0.2s ease-in-out;
        border: none;
      }
      .modal-footer .btn-primary {
        background-color: #4285f4;
        color: white;
        box-shadow: 0 4px 10px rgba(66, 133, 244, 0.3);
      }
      .modal-footer .btn-primary:hover {
        background-color: #357ae8;
        box-shadow: 0 6px 15px rgba(66, 133, 244, 0.4);
      }
      .modal-footer .btn-secondary {
        background-color: #e0e0e0;
        color: #424242;
      }
      .modal-footer .btn-secondary:hover {
        background-color: #c0c0c0;
      }

      /* General Buttons */
      .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out,
          box-shadow 0.2s ease-in-out;
        border: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }
      .btn-blue {
        background-color: #4285f4;
        color: white;
        box-shadow: 0 4px 10px rgba(66, 133, 244, 0.3);
      }
      .btn-blue:hover {
        background-color: #357ae8;
        box-shadow: 0 6px 15px rgba(66, 133, 244, 0.4);
      }
      .btn-red {
        background-color: #ea4335; /* Google Red */
        color: white;
        box-shadow: 0 4px 10px rgba(234, 67, 53, 0.3);
      }
      .btn-red:hover {
        background-color: #d1392c;
        box-shadow: 0 6px 15px rgba(234, 67, 53, 0.4);
      }
      .btn-green {
        background-color: #34a853; /* Google Green */
        color: white;
        box-shadow: 0 4px 10px rgba(52, 168, 83, 0.3);
      }
      .btn-green:hover {
        background-color: #2c8b46;
        box-shadow: 0 6px 15px rgba(52, 168, 83, 0.4);
      }
      /* Modified .btn-outline for always visible white background */
      .btn-outline {
        background-color: #ffffff; /* Default white background */
        color: #4285f4; /* Blue text */
        border: 1px solid #4285f4; /* Blue border */
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
      }
      .btn-outline:hover {
        background-color: #f0f0f0; /* Slightly darker white/light gray on hover */
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); /* Slightly more prominent shadow on hover */
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #eee;
      }
      .section-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: #333;
      }
      .detail-item {
        background-color: #f8f9fa;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border: 1px solid #e0e0e0;
      }
      .detail-item h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1a73e8;
        margin-bottom: 0.5rem;
      }
      .detail-item p {
        font-size: 1rem;
        color: #424242;
        margin-bottom: 0.5rem;
        white-space: pre-wrap; /* Preserve whitespace and line breaks */
      }
      .detail-item ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .detail-item ul li {
        padding: 0.25rem 0;
        color: #424242;
      }
      .detail-item ul li strong {
        color: #333;
      }
      .detail-item .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.85rem;
        font-weight: 500;
        margin-left: 0.5rem;
      }
      .status-badge.possible {
        background-color: #e6ffe6;
        color: #34a853;
      }
      .status-badge.impossible {
        background-color: #ffe6e6;
        color: #ea4335;
      }
      .status-badge.pending {
        background-color: #fffbe6;
        color: #fbbc04;
      }
      .status-badge.paid {
        background-color: #e6ffe6;
        color: #34a853;
      }
      .status-badge.unpaid {
        background-color: #ffe6e6;
        color: #ea4335;
      }
      .status-badge.assigned {
        background-color: #e8f0fe;
        color: #4285f4;
      }
      .status-badge.unassigned {
        background-color: #f0f2f5;
        color: #616161;
      }

      .role-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }
      .role-item {
        background-color: #e8f0fe;
        padding: 1rem;
        border-radius: 0.75rem;
        text-align: center;
        font-size: 0.9rem;
        color: #4285f4;
        font-weight: 500;
        border: 1px solid #d2e3fc;
      }
      .role-item strong {
        display: block;
        font-size: 1.1rem;
        color: #1a73e8;
        margin-bottom: 0.25rem;
      }

      /* Travel Notice Specific Style (Notion Callout like) */
      .travel-notice-callout {
        background-color: #e6f7ff; /* Light blue background */
        border-left: 4px solid #1890ff; /* Blue left border */
        border-radius: 0.75rem;
        padding: 1rem 1.5rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        font-size: 1rem;
        color: #333;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }
      .travel-notice-callout .pin-icon {
        font-size: 1.5rem;
        line-height: 1;
        color: #1890ff; /* Blue icon */
      }
      .travel-notice-callout .notice-content-wrapper {
        flex-grow: 1;
      }
      .travel-notice-callout .notice-text {
        white-space: pre-wrap;
      }
      .travel-notice-callout .edit-button-container {
        flex-shrink: 0;
        margin-left: auto; /* Push to the right */
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .container {
          margin: 1rem;
          border-radius: 1rem;
        }
        header {
          padding: 1rem 1.5rem;
          font-size: 1.25rem;
          border-top-left-radius: 1rem;
          border-top-right-radius: 1rem;
          flex-direction: column; /* Stack items vertically on small screens */
          align-items: flex-start; /* Align to start when stacked */
          gap: 0.5rem; /* Smaller gap when stacked */
        }
        header .header-title-container {
          width: 100%; /* Take full width */
          justify-content: flex-start; /* Align title to start */
        }
        header .header-right-section {
          width: 100%; /* Take full width */
          justify-content: flex-start; /* Align right section to start when stacked */
          flex-wrap: wrap; /* Ensure buttons/text wrap if needed */
          gap: 0.5rem; /* Smaller gap for wrapped items */
        }
        header .header-right-section .welcome-message {
          font-size: 0.9rem; /* Even smaller font on very small screens */
          white-space: normal; /* Allow welcome message to wrap */
        }
        nav {
          flex-wrap: wrap;
          padding: 0.5rem 1.5rem;
        }
        nav button {
          flex-grow: 1;
          text-align: center;
          padding: 0.6rem 1rem;
          font-size: 0.9rem;
        }
        .content {
          padding: 1.5rem;
        }
        .card {
          padding: 1rem;
        }
        .card-title {
          font-size: 1.1rem;
        }
        .modal-content {
          padding: 1.5rem;
          border-radius: 1rem;
        }
        .modal-title {
          font-size: 1.5rem;
        }
        .section-title {
          font-size: 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <div id="app" class="container">
      <!-- Header will be dynamically loaded -->
      <!-- Navigation will be dynamically loaded -->
      <div id="content" class="content">
        <!-- Content will be dynamically loaded -->
      </div>
    </div>

    <!-- Modals moved outside the #app container to ensure they are always in DOM -->
    <!-- Group Create Modal -->
    <div id="groupCreateModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">새 모임 생성</h2>
          <button
            class="modal-close-button"
            onclick="closeModal('groupCreateModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <label for="newGroupName">모임 이름</label>
          <input
            type="text"
            id="newGroupName"
            placeholder="예: 우테코 레벨1 리사조"
            required />

          <label for="newGroupPassword">모임 비밀번호</label>
          <input
            type="password"
            id="newGroupPassword"
            placeholder="모임에 참여할 때 필요합니다."
            required />

          <h3 class="font-semibold text-lg mt-4 mb-2 text-gray-700">
            카테고리 선택
          </h3>
          <div class="grid grid-cols-2 gap-2 mb-4">
            <label class="flex items-center">
              <input
                type="checkbox"
                id="category-meetings"
                value="meetings"
                checked
                class="mr-2" />
              약속
            </label>
            <label class="flex items-center">
              <input
                type="checkbox"
                id="category-travels"
                value="travels"
                checked
                class="mr-2" />
              여행
            </label>
            <label class="flex items-center">
              <input
                type="checkbox"
                id="category-birthdays"
                value="birthdays"
                checked
                class="mr-2" />
              생일
            </label>
            <label class="flex items-center">
              <input
                type="checkbox"
                id="category-expenses"
                value="expenses"
                checked
                class="mr-2" />
              회비
            </label>
          </div>
          <div id="customCategoriesContainer">
            <!-- Custom categories will be added here -->
          </div>
          <button
            class="btn btn-outline w-full mt-2"
            onclick="addCustomCategoryInput()">
            + 사용자 정의 카테고리 추가
          </button>
        </div>
        <div class="modal-footer">
          <button
            class="btn-secondary"
            onclick="closeModal('groupCreateModal')">
            취소
          </button>
          <button class="btn-primary" onclick="createNewGroup()">
            모임 생성
          </button>
        </div>
      </div>
    </div>

    <!-- Meeting Create Modal -->
    <div id="meetingCreateModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">새 약속 생성</h2>
          <button
            class="modal-close-button"
            onclick="closeModal('meetingCreateModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <label for="meetingName">약속 이름</label>
          <input
            type="text"
            id="meetingName"
            placeholder="예: 311 정기 모임"
            required />

          <label for="meetingDate">날짜</label>
          <input type="date" id="meetingDate" required />

          <label for="meetingTime">时间</label>
          <input type="time" id="meetingTime" required />

          <label for="meetingPlace">장소</label>
          <input
            type="text"
            id="meetingPlace"
            placeholder="예: 오목교 경성주막"
            required />

          <label for="meetingMemo">메모 (선택 사항)</label>
          <textarea
            id="meetingMemo"
            rows="3"
            placeholder="추가 설명"></textarea>
        </div>
        <div class="modal-footer">
          <button
            class="btn-secondary"
            onclick="closeModal('meetingCreateModal')">
            취소
          </button>
          <button class="btn-primary" onclick="createMeeting()">저장</button>
        </div>
      </div>
    </div>

    <!-- Meeting Participate/Decline Modal -->
    <div id="meetingParticipateModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="participateModalTitle">약속 참여/불참</h2>
          <button
            class="modal-close-button"
            onclick="closeModal('meetingParticipateModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <p id="participateMeetingName" class="text-lg font-semibold mb-4"></p>
          <label for="declineReason" class="hidden" id="declineReasonLabel"
            >불참 사유</label
          >
          <textarea
            id="declineReason"
            rows="3"
            placeholder="불참 사유를 입력해주세요."
            class="hidden"></textarea>
        </div>
        <div class="modal-footer" id="participateModalFooter">
          <!-- Buttons will be dynamically managed -->
          <button
            class="btn-red"
            id="declineButton"
            onclick="showDeclineReasonInput()">
            불참
          </button>
          <button
            class="btn-green"
            id="participateButton"
            onclick="handleMeetingParticipation('가능')">
            참여
          </button>
          <button
            class="btn-primary hidden"
            id="confirmDeclineButton"
            onclick="handleMeetingParticipation('불참')">
            확인
          </button>
          <button
            class="btn-secondary hidden"
            id="cancelDeclineButton"
            onclick="hideDeclineReasonInput()">
            취소
          </button>
        </div>
      </div>
    </div>

    <!-- Travel Create/Edit Form Modal (Renamed from travelCreateModal) -->
    <div id="travelFormModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="travelFormModalTitle">
            새 여행 일정 생성
          </h2>
          <button
            class="modal-close-button"
            onclick="closeModal('travelFormModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <label for="travelName">여행 제목</label>
          <input
            type="text"
            id="travelName"
            placeholder="예: 베트남 다낭"
            required />

          <label for="travelStartDate">시작 날짜</label>
          <input type="date" id="travelStartDate" required />

          <label for="travelEndDate">종료 날짜</label>
          <input type="date" id="travelEndDate" required />

          <label for="travelMemo">메모 (선택 사항)</label>
          <textarea id="travelMemo" rows="3" placeholder="추가 설명"></textarea>

          <h3 class="font-semibold text-lg mt-4 mb-2 text-gray-700">
            역할 분담
          </h3>
          <div id="roleAssignmentContainer">
            <!-- Roles will be dynamically added here -->
          </div>
          <button class="btn btn-outline w-full mt-4" onclick="addRoleInput()">
            + 역할 추가
          </button>
          <button
            class="btn btn-blue w-full mt-2"
            onclick="randomlyAssignRoles()">
            랜덤 분배
          </button>
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" onclick="closeModal('travelFormModal')">
            취소
          </button>
          <button
            class="btn-primary"
            id="saveTravelFormButton"
            onclick="saveTravelForm(false)">
            저장
          </button>
        </div>
      </div>
    </div>

    <!-- Travel Role Edit Content Modal (Existing for role content editing) -->
    <div id="travelRoleEditModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="travelRoleEditModalTitle">
            역할 내용 수정
          </h2>
          <button
            class="modal-close-button"
            onclick="closeModal('travelRoleEditModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <label for="travelRoleContent">内容</label>
          <textarea
            id="travelRoleContent"
            rows="10"
            placeholder="담당한 역할에 대한 내용을 입력해주세요."></textarea>
        </div>
        <div class="modal-footer">
          <button
            class="btn-secondary"
            onclick="closeModal('travelRoleEditModal')">
            취소
          </button>
          <button class="btn-primary" onclick="saveTravelRoleContent()">
            저장
          </button>
        </div>
      </div>
    </div>

    <!-- Travel Notice Edit Modal -->
    <div id="travelNoticeEditModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">여행 공지사항 수정</h2>
          <button
            class="modal-close-button"
            onclick="closeModal('travelNoticeEditModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <label for="travelNoticeContent">공지사항 내용</label>
          <textarea
            id="travelNoticeContent"
            rows="5"
            placeholder="공지사항을 입력해주세요."></textarea>
        </div>
        <div class="modal-footer">
          <button
            class="btn-secondary"
            onclick="closeModal('travelNoticeEditModal')">
            취소
          </button>
          <button class="btn-primary" onclick="saveTravelNoticeContent()">
            저장
          </button>
        </div>
      </div>
    </div>

    <!-- Birthday Assign Modal -->
    <div id="birthdayAssignModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">생일 담당자 지정</h2>
          <button
            class="modal-close-button"
            onclick="closeModal('birthdayAssignModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <p id="birthdayAssignInfo" class="text-lg font-semibold mb-4"></p>
          <p class="text-md text-gray-600">
            선택된 담당자: <strong id="assignedBirthdayPerson">미지정</strong>
          </p>
        </div>
        <div class="modal-footer">
          <button
            class="btn-secondary"
            onclick="closeModal('birthdayAssignModal')">
            취소
          </button>
          <button class="btn-primary" onclick="assignBirthdayHandler()">
            담당자 지정
          </button>
        </div>
      </div>
    </div>

    <!-- Birthday Prepare Modal -->
    <div id="birthdayPrepareModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="birthdayPrepareModalTitle">
            생일 준비 현황 공유
          </h2>
          <button
            class="modal-close-button"
            onclick="closeModal('birthdayPrepareModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <label for="birthdayPreparationContent">준비 현황</label>
          <textarea
            id="birthdayPreparationContent"
            rows="10"
            placeholder="선물 후보, 케이크 옵션 등을 공유해주세요."></textarea>
        </div>
        <div class="modal-footer">
          <button
            class="btn-secondary"
            onclick="closeModal('birthdayPrepareModal')">
            취소
          </button>
          <button class="btn-primary" onclick="saveBirthdayPreparation()">
            저장
          </button>
        </div>
      </div>
    </div>

    <!-- Expense Create Modal -->
    <div id="expenseCreateModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">새 회비 항목 생성</h2>
          <button
            class="modal-close-button"
            onclick="closeModal('expenseCreateModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <label for="expenseName">회비 항목 이름</label>
          <input
            type="text"
            id="expenseName"
            placeholder="예: 이번 여행 회비"
            required />

          <label for="expenseAmount">금액 (원)</label>
          <input
            type="number"
            id="expenseAmount"
            placeholder="예: 20000"
            required />

          <label for="expenseDeadline">마감일</label>
          <input type="date" id="expenseDeadline" required />

          <label for="expensePenalty">벌칙 (선택 사항)</label>
          <input
            type="text"
            id="expensePenalty"
            placeholder="예: 미납 시 다음 약속 커피 사기" />
        </div>
        <div class="modal-footer">
          <button
            class="btn-secondary"
            onclick="closeModal('expenseCreateModal')">
            취소
          </button>
          <button class="btn-primary" onclick="createExpense()">저장</button>
        </div>
      </div>
    </div>

    <!-- Leave Group Confirmation Modal -->
    <div id="leaveGroupConfirmModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="leaveGroupModalTitle">모임 나가기</h2>
          <button
            class="modal-close-button"
            onclick="closeModal('leaveGroupConfirmModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <p id="leaveGroupConfirmText" class="text-lg font-semibold mb-4">
            정말 이 모임을 나가시겠습니까?
          </p>
          <label class="flex items-center mt-4">
            <input type="checkbox" id="leaveQuietlyCheckbox" class="mr-2" />
            조용히 나가기
          </label>
        </div>
        <div class="modal-footer">
          <button
            class="btn-secondary"
            onclick="closeModal('leaveGroupConfirmModal')">
            취소
          </button>
          <button class="btn-red" onclick="confirmLeaveGroup()">나가기</button>
        </div>
      </div>
    </div>

    <!-- Message Box Modal (for alerts) -->
    <div id="messageBoxModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="messageBoxTitle">알림</h2>
          <button
            class="modal-close-button"
            onclick="closeModal('messageBoxModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <p id="messageBoxContent" class="text-lg text-gray-700"></p>
        </div>
        <div class="modal-footer">
          <button class="btn-primary" onclick="closeModal('messageBoxModal')">
            확인
          </button>
        </div>
      </div>
    </div>

    <script>
      // Mock Data
      const mockData = {
        currentUser: {
          id: "user-hangseong-i",
          name: "행성이",
          birthday: "2002-07-01", // Changed to 2002
        },
        users: [
          { id: "user-soorin", name: "김수린", birthday: "2002-11-05" }, // Changed to 2002
          { id: "user-siwon", name: "김시원", birthday: "2002-02-26" }, // Changed to 2002
          { id: "user-yujin", name: "이유진", birthday: "2002-10-30" }, // Changed to 2002
          { id: "user-boryeong", name: "남보령", birthday: "2002-03-17" }, // Changed to 2002
          { id: "user-hangseong-i", name: "행성이", birthday: "2002-08-20" }, // Changed to 2002, added birthday for testing
          { id: "user-gyeongmin", name: "고경민", birthday: "2002-01-01" }, // Changed to 2002
          { id: "user-hyeyun", name: "혜윤", birthday: "2002-01-02" }, // Changed to 2002
          { id: "user-jaeyi", name: "재이", birthday: "2002-01-03" }, // Changed to 2002
          { id: "user-jisu", name: "지수", birthday: "2002-01-04" }, // Changed to 2002
          // New users for '우테코 레벨1 리사조' (unchanged)
          { id: "user-may", name: "메이", birthday: "1999-04-10" },
          { id: "user-minggom", name: "밍곰", birthday: "1999-05-20" },
          { id: "user-pora", name: "포라", birthday: "1999-07-25" },
          { id: "user-meonggu", name: "멍구", birthday: "1999-08-15" },
          { id: "user-lisa", name: "리사", birthday: "1999-09-01" },
          { id: "user-dompu", name: "돔푸", birthday: "1999-10-10" },
          { id: "user-jensen", name: "젠슨", birthday: "1999-11-20" },
          { id: "user-popo", name: "포포", birthday: "1999-12-05" },
          { id: "user-jjanggu", name: "짱구", birthday: "1999-01-25" },
          { id: "user-gaion", name: "가이온", birthday: "1999-02-14" },
          { id: "user-flint", name: "플린트", birthday: "1999-03-03" },
        ],
        groups: [
          {
            id: "group-311",
            name: "311",
            password: "311password", // Added password
            members: [
              "user-soorin",
              "user-siwon",
              "user-yujin",
              "user-boryeong",
              "user-hangseong-i",
              "user-gyeongmin",
              "user-hyeyun",
              "user-jaeyi",
              "user-jisu",
            ],
            categories: [
              // Default categories
              { id: "dashboard", name: "대시보드", type: "system" },
              { id: "meetings", name: "약속", type: "default" },
              { id: "travels", name: "여행", type: "default" },
              { id: "birthdays", name: "생일", type: "default" },
              { id: "expenses", name: "회비", type: "default" },
              { id: "members", name: "멤버", type: "system" }, // Added members category
            ],
            meetings: [
              {
                id: "meeting-1",
                name: "311 정기 모임",
                date: "2025-07-05",
                time: "20:00",
                place: "오목교 경성주막",
                memo: "",
                creator: "김수린",
                participants: [
                  { userId: "user-soorin", status: "가능", reason: "" },
                  { userId: "user-boryeong", status: "가능", reason: "" },
                  { userId: "user-hangseong-i", status: "미정", reason: "" }, // Current user initial status
                ],
              },
              {
                id: "meeting-2",
                name: "연말 파티",
                date: "2025-12-28",
                time: "20:00",
                place: "홍대 파티룸",
                memo: "",
                creator: "김수린",
                participants: [
                  { userId: "user-soorin", status: "가능", reason: "" },
                  { userId: "user-boryeong", status: "가능", reason: "" },
                  { userId: "user-siwon", status: "가능", reason: "" },
                  { userId: "user-yujin", status: "가능", reason: "" },
                  { userId: "user-hangseong-i", status: "미정", reason: "" }, // Current user initial status
                ],
              },
            ],
            travels: [
              {
                id: "travel-1",
                name: "베트남 다낭",
                startDate: "2026-06-27", // Changed year to 2026
                endDate: "2026-07-01", // Changed year to 2026
                memo: "",
                notice:
                  "예산은 인당 40이고, 본인이 쇼핑할 만큼 추가적으로 환전해오기", // Added notice
                roles: [
                  {
                    name: "숙소",
                    assignedTo: ["user-soorin"],
                    content: `🏨 다낭 호텔 정리\n\n📍네스타호텔 6/27~28 (1박)\nhttps://maps.app.goo.gl/cDvcXLRYXCg6EBHJA?g_st=com.google.maps.preview.copy\n📍코지다낭 부티크 호텔 6/28~30 (2박)\nhttps://maps.app.goo.gl/zq9Q3Mt6SqVzhSBy8?g_st=com.google.maps.preview.copy\n\n✔️호텔은 2명씩 방 4개 예약\n✔️네스타는 해안쪽, 코지다낭은 도심쪽\n✔️아고다로 예약, 캐쉬백은 들어오는데로 환급 예정`,
                  },
                  {
                    name: "관광",
                    assignedTo: ["user-hangseong-i"],
                    content: `🚐인천공항까지 가는 콜벤🚐\n\n1) 당산역에서 오전 2시 (김시원, 고경민)\n2) 목동 41타워에서 오전 2시 10분 (남보령, 혜윤, 재이, 김수린, 지수)\n3) 목동고에서 오전 2시 20분 (이유진)\n\n*절대 늦지 말고 시간 엄수!! 2),3)에서 타는 사람들은 5분씩 일찍 와서 기다리자~!!\n\n* 금액: 175,000원 (1인당 21,875원)`,
                  },
                  { name: "장보기", assignedTo: ["user-yujin"], content: "" },
                  { name: "총무", assignedTo: ["user-siwon"], content: "" },
                  {
                    name: "맛집 찾기",
                    assignedTo: ["user-boryeong"],
                    content: "",
                  },
                ],
              },
            ],
            birthdays: [
              {
                userId: "user-soorin",
                date: "11-05",
                assignedTo: null,
                preparation: "",
              },
              {
                userId: "user-siwon",
                date: "02-26",
                assignedTo: null,
                preparation: "",
              },
              {
                userId: "user-yujin",
                date: "10-30",
                assignedTo: null,
                preparation: "",
              },
              {
                userId: "user-boryeong",
                date: "03-17",
                assignedTo: null,
                preparation: "",
              },
              {
                userId: "user-hangseong-i",
                date: "08-20",
                assignedTo: null,
                preparation: "",
              }, // Added 행성이's birthday
            ],
            expenses: [
              {
                id: "expense-1",
                name: "정기 회비",
                amount: 20000,
                deadline: "2025-07-31",
                penalty: "다음 약속 커피 사기",
                payers: [
                  { userId: "user-soorin", paid: true },
                  { userId: "user-boryeong", paid: true },
                  { userId: "user-hangseong-i", paid: false }, // Current user initial status
                ],
              },
            ],
            birthdayAssignmentHistory: [], // To track who has been assigned for birthdays
          },
          {
            id: "group-woowacourse-lisa",
            name: "우테코 레벨1 리사조",
            password: "lisa_password", // Added password
            members: [
              "user-hangseong-i",
              "user-may",
              "user-minggom",
              "user-pora",
              "user-meonggu",
              "user-lisa",
              "user-dompu",
              "user-jensen",
              "user-popo",
              "user-jjanggu",
              "user-gaion",
              "user-flint",
            ],
            categories: [
              // Default categories
              { id: "dashboard", name: "대시보드", type: "system" },
              { id: "meetings", name: "약속", type: "default" },
              { id: "travels", name: "여행", type: "default" },
              { id: "birthdays", name: "생일", type: "default" },
              { id: "expenses", name: "회비", type: "default" },
              { id: "members", name: "멤버", type: "system" }, // Added members category
            ],
            meetings: [
              {
                id: "meeting-level3-dinner",
                name: "레벨3 회식",
                date: "2025-07-15",
                time: "18:00",
                place: "잠실역",
                memo: "레벨3 우리 캠퍼스는 함께하지 못해도 회식은 함께해요.",
                creator: "돔푸",
                participants: [
                  { userId: "user-may", status: "가능", reason: "" },
                  { userId: "user-minggom", status: "가능", reason: "" },
                  { userId: "user-pora", status: "가능", reason: "" },
                  { userId: "user-meonggu", status: "가능", reason: "" },
                  {
                    userId: "user-lisa",
                    status: "불참",
                    reason: "대학원 issue..",
                  },
                  { userId: "user-hangseong-i", status: "미정", reason: "" }, // Current user
                  { userId: "user-dompu", status: "가능", reason: "" }, // Creator
                  { userId: "user-jensen", status: "미정", reason: "" },
                  { userId: "user-popo", status: "미정", reason: "" },
                  { userId: "user-jjanggu", status: "미정", reason: "" },
                  { userId: "user-gaion", status: "미정", reason: "" },
                  { userId: "user-flint", status: "미정", reason: "" },
                ],
              },
            ],
            travels: [
              {
                id: "travel-woowacourse-graduation",
                name: "우테코 졸업 여행",
                startDate: "2025-11-20",
                endDate: "2025-11-21",
                memo: "우테코 졸업 축하 기념 부산 여행",
                notice: "여행 장소가 국내 다른 지역으로 바뀔 수 있습니다~", // Added notice
                roles: [
                  { name: "숙소", assignedTo: ["user-minggom"], content: "" },
                  {
                    name: "관광",
                    assignedTo: ["user-may"],
                    content:
                      "롯데 자이언츠 vs 키움 히어로즈 야구를 보러 갑니다",
                  },
                  { name: "장보기", assignedTo: ["user-jensen"], content: "" },
                  { name: "총무", assignedTo: ["user-jjanggu"], content: "" },
                  {
                    name: "맛집 찾기",
                    assignedTo: ["user-meonggu", "user-pora"],
                    content: "",
                  }, // Multiple assignees
                ],
              },
            ],
            birthdays: [
              {
                userId: "user-pora",
                date: "07-25",
                assignedTo: "user-minggom",
                preparation:
                  "포라 생일 🤙🏽 콜고(콜미고수) 초고(초딩고수) 생일 축하해요",
              },
            ],
            expenses: [
              {
                id: "expense-dinner-settlement",
                name: "회식 정산",
                amount: 20000,
                deadline: "2025-07-20",
                penalty: "릴스 찍어서 크루위키에 올리기",
                payers: [
                  { userId: "user-hangseong-i", paid: true },
                  { userId: "user-may", paid: true },
                  { userId: "user-minggom", paid: true },
                  { userId: "user-pora", paid: true },
                  { userId: "user-meonggu", paid: true },
                  { userId: "user-lisa", paid: true },
                  { userId: "user-dompu", paid: true },
                  { userId: "user-jensen", paid: true },
                  { userId: "user-popo", paid: true },
                  { userId: "user-jjanggu", paid: true },
                  { userId: "user-gaion", paid: true },
                  { userId: "user-flint", paid: false }, // 플린트 빼고 모두 제출
                ],
              },
            ],
            birthdayAssignmentHistory: [],
          },
        ],
      };

      // Global state variables
      let currentGroup = null;
      let currentTab = "dashboard"; // Default tab changed to dashboard
      let selectedMeetingId = null; // For meeting participation modal
      let selectedTravelId = null; // For travel form modal (for edit mode)
      let selectedTravelRoleName = null; // For travel role edit modal
      let selectedBirthdayUserId = null; // For birthday prepare modal
      let selectedExpenseId = null; // For expense submission

      // Global object to store last nag times for cooldown
      const lastNagTimes = {};
      const COOLDOWN_DURATION = 5 * 60 * 1000; // 5 minutes in milliseconds

      // Utility function to get user name by ID
      function getUserNameById(userId) {
        const user = mockData.users.find((u) => u.id === userId);
        return user ? user.name : "알 수 없음";
      }

      // Utility function to get user ID by name
      function getUserIdByName(userName) {
        const user = mockData.users.find((u) => u.name === userName);
        return user ? user.id : null;
      }

      // Utility function to generate unique IDs
      function generateUniqueId(prefix) {
        return (
          prefix +
          "-" +
          Date.now() +
          "-" +
          Math.random().toString(36).substr(2, 9)
        );
      }

      // --- Modal Functions ---
      function openModal(modalId, callback = null) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.classList.add("show");
          if (callback) callback();
        }
      }

      function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.classList.remove("show");
        }
      }

      function showMessageBox(title, message) {
        document.getElementById("messageBoxTitle").textContent = title;
        document.getElementById("messageBoxContent").textContent = message;
        openModal("messageBoxModal");
      }

      // --- View Rendering Functions ---

      // Renders the initial group list page
      function renderGroupList() {
        const appDiv = document.getElementById("app");
        appDiv.innerHTML = `
                <header>
                    <h1>모임 서비스</h1>
                    <span class="text-xl">환영합니다, ${mockData.currentUser.name}님!</span>
                </header>
                <div id="content" class="content fade-in">
                    <h2 class="section-title mb-6">내 모임</h2>
                    <div id="groupList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Group cards will be rendered here -->
                    </div>
                    <button class="btn btn-blue mt-6 w-full" onclick="openModal('groupCreateModal')">새 모임 생성</button>
                </div>
            `;

        const groupListDiv = document.getElementById("groupList");
        // Filter groups to only show those the current user is a member of
        const userGroups = mockData.groups.filter((group) =>
          group.members.includes(mockData.currentUser.id)
        );

        if (userGroups.length === 0) {
          groupListDiv.innerHTML =
            '<p class="text-gray-600">참여 중인 모임이 없습니다. 새로운 모임을 생성하거나 초대받으세요!</p>';
        } else {
          userGroups.forEach((group) => {
            const memberNames = group.members.map((id) => getUserNameById(id));
            const membersDisplay =
              memberNames.length > 5
                ? `${memberNames.slice(0, 5).join(", ")} 외 ${
                    memberNames.length - 5
                  }명`
                : memberNames.join(", ") || "없음";

            const groupCard = document.createElement("div");
            groupCard.className = "card cursor-pointer";
            groupCard.innerHTML = `
                        <div class="card-title">${group.name}</div>
                        <div class="card-subtitle">멤버 수: ${group.members.length}명</div>
                        <p class="card-text"><strong>멤버:</strong> ${membersDisplay}</p>
                        <p class="card-text">친구들과의 약속, 여행, 생일, 회비를 한 곳에서 관리하세요!</p>
                    `;
            groupCard.onclick = () => selectGroup(group.id);
            groupListDiv.appendChild(groupCard);
          });
        }

        // Trigger fade-in for the initial content
        const contentDiv = document.getElementById("content");
        setTimeout(() => {
          contentDiv.classList.remove("fade-in");
        }, 10); // Small delay to ensure transition applies
      }

      // Selects a group and renders its detail page
      function selectGroup(groupId) {
        currentGroup = mockData.groups.find((g) => g.id === groupId);
        if (currentGroup) {
          // Set default tab to dashboard when entering a group
          currentTab = "dashboard";
          renderGroupDetail();
        } else {
          showMessageBox("오류", "모임을 찾을 수 없습니다.");
        }
      }

      // Renders the group detail page with tabs
      function renderGroupDetail() {
        const appDiv = document.getElementById("app");
        let navButtonsHtml = "";
        currentGroup.categories.forEach((category) => {
          navButtonsHtml += `<button id="nav-${category.id}" onclick="changeTab('${category.id}')">`;
          switch (category.id) {
            case "dashboard":
              navButtonsHtml += "📊 대시보드";
              break;
            case "meetings":
              navButtonsHtml += "🗓️ 약속";
              break;
            case "travels":
              navButtonsHtml += "✈️ 여행";
              break;
            case "birthdays":
              navButtonsHtml += "🎁 생일";
              break;
            case "expenses":
              navButtonsHtml += "💰 회비";
              break;
            case "members":
              navButtonsHtml += "👥 멤버";
              break; // Added members tab
            default:
              navButtonsHtml += category.name; // For custom categories
          }
          navButtonsHtml += `</button>`;
        });

        appDiv.innerHTML = `
                <header>
                    <div class="header-title-container">
                        <button class="back-button" onclick="renderGroupList()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home">
                                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                <polyline points="9 22 9 12 15 12 15 22"/>
                            </svg>
                            홈
                        </button>
                        <h1>${currentGroup.name} 모임</h1>
                    </div>
                    <div class="header-right-section">
                        <button class="btn btn-outline text-sm py-1 px-3 whitespace-nowrap" onclick="copyInviteLink()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07L10 6.58"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07L14 17.42"/></svg>
                            초대 링크 복사
                        </button>
                        <button class="btn btn-red text-sm py-1 px-3 whitespace-nowrap" onclick="openLeaveGroupModal('${currentGroup.id}')">모임 나가기</button>
                        <span class="welcome-message">환영합니다, ${mockData.currentUser.name}님!</span>
                    </div>
                </header>
                <nav id="mainNav">
                    ${navButtonsHtml}
                </nav>
                <div id="content" class="content fade-in">
                    <!-- Tab content will be rendered here -->
                </div>
            `;
        changeTab(currentTab); // Render the initial tab content

        // Trigger fade-in for the group detail content
        const contentDiv = document.getElementById("content");
        setTimeout(() => {
          contentDiv.classList.remove("fade-in");
        }, 10); // Small delay to ensure transition applies
      }

      // Changes the active tab and renders its content with fade animation
      function changeTab(tabName) {
        currentTab = tabName;
        const navButtons = document.querySelectorAll("#mainNav button");
        navButtons.forEach((button) => {
          button.classList.remove("active");
        });
        const activeNavButton = document.getElementById(`nav-${tabName}`);
        if (activeNavButton) {
          activeNavButton.classList.add("active");
        }

        const contentDiv = document.getElementById("content");

        // Add fade-out effect
        contentDiv.classList.add("fade-out");

        // Use a small timeout to ensure fade-out transition starts before content replacement
        setTimeout(() => {
          // Clear previous content
          contentDiv.innerHTML = "";

          // Render new content based on the selected tab
          switch (tabName) {
            case "dashboard":
              renderDashboard();
              break;
            case "meetings":
              renderMeetings();
              break;
            case "travels":
              renderTravels();
              break;
            case "birthdays":
              renderBirthdays();
              break;
            case "expenses":
              renderExpenses();
              break;
            case "members": // New case for members tab
              renderMembers();
              break;
            default: // For custom categories
              renderCustomCategoryContent(tabName);
              break;
          }

          // Ensure new content starts invisible for fade-in
          contentDiv.classList.add("fade-in");

          // Force reflow for the newly rendered content
          void contentDiv.offsetWidth;

          // Remove fade-out and trigger fade-in
          contentDiv.classList.remove("fade-out");
          contentDiv.classList.remove("fade-in"); // This will trigger the transition to opacity: 1
        }, 300); // Match this timeout with the CSS transition duration (0.3s)
      }

      // --- Dashboard Tab Function ---
      function renderDashboard() {
        const contentDiv = document.getElementById("content");
        let dashboardHtml = `
                <h2 class="section-title">📊 대시보드</h2>
            `;

        // Normalize today's date to midnight for consistent comparisons
        const todayNormalized = new Date();
        todayNormalized.setHours(0, 0, 0, 0);

        // 5. My Pending Tasks (New Section - moved to top)
        let myPendingTasksHtml = "";
        const myUnrespondedMeetings = currentGroup.meetings.filter((m) => {
          const participant = m.participants.find(
            (p) => p.userId === mockData.currentUser.id
          );
          return participant && participant.status === "미정";
        });

        const myUnfinishedTravelRoles = currentGroup.travels.flatMap((t) =>
          t.roles
            .filter(
              (r) =>
                r.assignedTo.includes(mockData.currentUser.id) &&
                r.content === ""
            )
            .map((r) => ({
              travelName: t.name,
              roleName: r.name,
              travelId: t.id,
            }))
        );

        const myUnpaidExpenses = currentGroup.expenses.filter((e) => {
          const payer = e.payers.find(
            (p) => p.userId === mockData.currentUser.id
          );
          return payer && !payer.paid;
        });

        if (
          myUnrespondedMeetings.length > 0 ||
          myUnfinishedTravelRoles.length > 0 ||
          myUnpaidExpenses.length > 0
        ) {
          myPendingTasksHtml += `
                    <div class="card md:col-span-2 mb-6"> <!-- Span full width on medium screens, added mb-6 for spacing -->
                        <div class="card-title">🚨 내가 해야 할 일</div>
                        <ul class="list-disc pl-5 text-gray-700">
                `;
          myUnrespondedMeetings.forEach((m) => {
            myPendingTasksHtml += `<li>약속: <strong>${m.name}</strong> 참여 여부 결정 <button class="btn btn-outline text-xs py-1 px-2 ml-2" onclick="openMeetingParticipateModal('${m.id}')">바로가기</button></li>`;
          });
          myUnfinishedTravelRoles.forEach((r) => {
            myPendingTasksHtml += `<li>여행: <strong>${r.travelName}</strong>의 <strong>${r.roleName}</strong> 업무 업데이트 <button class="btn btn-outline text-xs py-1 px-2 ml-2" onclick="openTravelRoleEditModal('${r.travelId}', '${r.roleName}')">바로가기</button></li>`;
          });
          myUnpaidExpenses.forEach((e) => {
            myPendingTasksHtml += `<li>회비: <strong>${
              e.name
            }</strong> ${e.amount.toLocaleString()}원 납부 <button class="btn btn-outline text-xs py-1 px-2 ml-2" onclick="viewExpenseDetails('${
              e.id
            }')">바로가기</button></li>`;
          });
          myPendingTasksHtml += `
                        </ul>
                    </div>
                `;
        } else {
          myPendingTasksHtml += `
                    <div class="card md:col-span-2 mb-6"> <!-- Added mb-6 for spacing -->
                        <div class="card-title">✨ 내가 해야 할 일</div>
                        <p class="card-text">현재 해야 할 일이 없습니다. 모든 것이 완료되었습니다!</p>
                    </div>
                `;
        }
        dashboardHtml += myPendingTasksHtml; // Insert pending tasks at the top

        dashboardHtml += `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">`; // Start new grid for other cards

        // 1. Upcoming Meetings Summary
        const upcomingMeetings = currentGroup.meetings
          .filter((m) => {
            const meetingDate = new Date(m.date);
            meetingDate.setHours(0, 0, 0, 0); // Normalize meeting date to midnight
            return meetingDate >= todayNormalized;
          })
          .sort((a, b) => new Date(a.date) - new Date(b.date))
          .slice(0, 3); // Show up to 3 upcoming meetings

        dashboardHtml += `
                <div class="card">
                    <div class="card-title">🗓️ 다가오는 약속</div>
                    ${
                      upcomingMeetings.length > 0
                        ? `
                        <ul class="list-disc pl-5 text-gray-700">
                            ${upcomingMeetings
                              .map(
                                (m) => `
                                <li><strong>${m.name}</strong>: ${m.date} ${m.time} (${m.place})</li>
                            `
                              )
                              .join("")}
                        </ul>
                    `
                        : `<p class="card-text">다가오는 약속이 없습니다.</p>`
                    }
                    <button class="btn btn-outline mt-4" onclick="changeTab('meetings')">약속 전체 보기</button>
                </div>
            `;

        // 2. Planned Travels Summary (Includes current and upcoming)
        const plannedTravels = currentGroup.travels
          .filter((t) => {
            const endDate = new Date(t.endDate);
            endDate.setHours(0, 0, 0, 0); // Normalize end date to midnight
            return endDate >= todayNormalized; // Travel is relevant if its end date is today or in the future
          })
          .sort((a, b) => {
            // Sort by start date, so the nearest upcoming or current travel appears first
            const startDateA = new Date(a.startDate);
            const startDateB = new Date(b.startDate);
            return startDateA - startDateB;
          })
          .slice(0, 1); // Show only the next relevant travel for brevity on dashboard

        dashboardHtml += `
                <div class="card">
                    <div class="card-title">✈️ 계획된 여행</div>
                    ${
                      plannedTravels.length > 0
                        ? `
                        ${plannedTravels
                          .map(
                            (t) => `
                            <p class="card-subtitle">${t.name} (${
                              t.startDate
                            } ~ ${t.endDate})</p>
                            <p class="card-text">역할: ${t.roles
                              .map(
                                (r) =>
                                  `${r.name} (${r.assignedTo
                                    .map((id) => getUserNameById(id))
                                    .join(", ")})`
                              )
                              .join(", ")}</p>
                        `
                          )
                          .join('<hr class="my-4"/>')}
                    `
                        : `<p class="card-text">계획된 여행이 없습니다.</p>`
                    }
                    <button class="btn btn-outline mt-4" onclick="changeTab('travels')">여행 전체 보기</button>
                </div>
            `;

        // 3. Upcoming Birthdays Summary
        const upcomingBirthdays = currentGroup.birthdays
          .filter((b) => {
            const bDateThisYear = new Date(
              `${todayNormalized.getFullYear()}-${b.date}`
            );
            // If birthday has passed this year, consider it for next year
            if (bDateThisYear < todayNormalized) {
              bDateThisYear.setFullYear(todayNormalized.getFullYear() + 1);
            }
            return bDateThisYear >= todayNormalized; // Only show birthdays that are today or in the future
          })
          .sort((a, b) => {
            const dateA = new Date(
              `${todayNormalized.getFullYear()}-${a.date}`
            );
            const dateB = new Date(
              `${todayNormalized.getFullYear()}-${b.date}`
            );
            if (dateA < todayNormalized)
              dateA.setFullYear(todayNormalized.getFullYear() + 1);
            if (dateB < todayNormalized)
              dateB.setFullYear(todayNormalized.getFullYear() + 1);
            return dateA - dateB;
          })
          .slice(0, 3); // Show up to 3 nearest birthdays

        dashboardHtml += `
                <div class="card">
                    <div class="card-title">🎁 다가오는 생일</div>
                    ${
                      upcomingBirthdays.length > 0
                        ? `
                        <ul class="list-disc pl-5 text-gray-700">
                            ${upcomingBirthdays
                              .map(
                                (b) => `
                                <li><strong>${getUserNameById(
                                  b.userId
                                )}</strong>: ${b.date} (${
                                  b.assignedTo
                                    ? getUserNameById(b.assignedTo) + " 담당"
                                    : "담당자 미지정"
                                })</li>
                            `
                              )
                              .join("")}
                        </ul>
                    `
                        : `<p class="card-text">다가오는 생일이 없습니다.</p>`
                    }
                    <button class="btn btn-outline mt-4" onclick="changeTab('birthdays')">생일 전체 보기</button>
                </div>
            `;

        // 4. Pending Expenses Summary
        const pendingExpenses = currentGroup.expenses.filter((e) => {
          const currentUserPayer = e.payers.find(
            (p) => p.userId === mockData.currentUser.id
          );
          return currentUserPayer && !currentUserPayer.paid;
        });

        dashboardHtml += `
                <div class="card">
                    <div class="card-title">💰 미납 회비</div>
                    ${
                      pendingExpenses.length > 0
                        ? `
                        <ul class="list-disc pl-5 text-gray-700">
                            ${pendingExpenses
                              .map(
                                (e) => `
                                <li><strong>${
                                  e.name
                                }</strong>: ${e.amount.toLocaleString()}원 (마감일: ${
                                  e.deadline
                                })</li>
                            `
                              )
                              .join("")}
                        </ul>
                    `
                        : `<p class="card-text">미납된 회비가 없습니다.</p>`
                    }
                    <button class="btn btn-outline mt-4" onclick="changeTab('expenses')">회비 전체 보기</button>
                </div>
            `;

        dashboardHtml += `</div>`; // Close grid
        contentDiv.innerHTML = dashboardHtml;
      }

      // --- Members Tab Function ---
      function renderMembers() {
        const contentDiv = document.getElementById("content");
        let membersHtml = `
                <h2 class="section-title">👥 멤버 목록</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-6">
            `;

        currentGroup.members.forEach((memberId) => {
          const userName = getUserNameById(memberId);
          const userBirthday =
            mockData.users.find((u) => u.id === memberId)?.birthday ||
            "정보 없음";
          membersHtml += `
                    <div class="card p-4 text-center">
                        <p class="font-semibold text-lg text-blue-700">${userName}</p>
                        <p class="text-gray-600 text-sm">생일: ${userBirthday}</p>
                    </div>
                `;
        });

        membersHtml += `</div>`; // Close grid
        contentDiv.innerHTML = membersHtml;
      }

      // --- Meetings Tab Functions ---
      function renderMeetings() {
        const contentDiv = document.getElementById("content");
        contentDiv.innerHTML = `
                <div class="section-header">
                    <h2 class="section-title">🗓️ 약속 목록</h2>
                    <button class="btn btn-blue" onclick="openModal('meetingCreateModal')">약속 생성</button>
                </div>
                <div id="meetingsList">
                    <!-- Meetings will be listed here -->
                </div>
            `;

        const meetingsListDiv = document.getElementById("meetingsList");
        if (currentGroup.meetings.length === 0) {
          meetingsListDiv.innerHTML =
            '<p class="text-gray-600">아직 등록된 약속이 없습니다.</p>';
          return;
        }

        currentGroup.meetings.forEach((meeting) => {
          const userParticipation = meeting.participants.find(
            (p) => p.userId === mockData.currentUser.id
          );
          const statusText = userParticipation
            ? userParticipation.status
            : "미정";
          const statusClass = {
            가능: "possible",
            불참: "impossible",
            미정: "pending",
          }[statusText];

          const meetingCard = document.createElement("div");
          meetingCard.className = "card";
          let participantsHtml = "";
          currentGroup.members.forEach((memberId) => {
            const participant = meeting.participants.find(
              (p) => p.userId === memberId
            );
            const pStatus = participant ? participant.status : "미정";
            const pReason =
              participant && pStatus === "불참"
                ? ` (사유: ${participant.reason})`
                : ""; // Only show reason for '불참'
            const pStatusClass = {
              가능: "possible",
              불참: "impossible",
              미정: "pending",
            }[pStatus];
            const nagKey = `nag-meeting-${meeting.id}-${memberId}`;
            const canNag =
              !lastNagTimes[nagKey] ||
              Date.now() - lastNagTimes[nagKey] > COOLDOWN_DURATION;
            const nagButtonHtml =
              pStatus === "미정" && canNag
                ? `<button class="btn btn-outline text-xs py-1 px-2 ml-2" onclick="nagParticipant('${meeting.id}', '${memberId}')">🛎️ 재촉</button>`
                : pStatus === "미정" && !canNag
                ? `<button class="btn btn-outline text-xs py-1 px-2 ml-2 opacity-50 cursor-not-allowed" disabled>🛎️ 재촉 (쿨다운)</button>`
                : "";

            participantsHtml += `<li><strong>${getUserNameById(
              memberId
            )}</strong>: <span class="status-badge ${pStatusClass}">${pStatus}</span>${pReason}${nagButtonHtml}</li>`;
          });

          meetingCard.innerHTML = `
                    <div class="card-title">${meeting.name}</div>
                    <div class="card-subtitle">${meeting.date} ${
            meeting.time
          } | ${meeting.place}</div>
                    <p class="card-text">
                        참여 현황: ${
                          meeting.participants
                            .filter((p) => p.status === "가능")
                            .map((p) => getUserNameById(p.userId))
                            .join(", ") || "없음"
                        }
                        <span class="status-badge ${statusClass}">내 상태: ${statusText}</span>
                    </p>
                    <div class="flex gap-2 mt-4">
                        <button class="btn btn-outline" onclick="viewMeetingDetails('${
                          meeting.id
                        }')">상세 보기</button>
                        <button class="btn btn-green" onclick="openMeetingParticipateModal('${
                          meeting.id
                        }')">참여/불참</button>
                    </div>
                `;
          meetingsListDiv.appendChild(meetingCard);
        });
      }

      function viewMeetingDetails(meetingId) {
        const meeting = currentGroup.meetings.find((m) => m.id === meetingId);
        if (!meeting) {
          showMessageBox("오류", "약속을 찾을 수 없습니다.");
          return;
        }

        let participantsHtml = "<ul>";
        currentGroup.members.forEach((memberId) => {
          const participant = meeting.participants.find(
            (p) => p.userId === memberId
          );
          const status = participant ? participant.status : "미정";
          const reason =
            participant && status === "불참"
              ? ` (사유: ${participant.reason})`
              : ""; // Only show reason for '불참'
          const statusClass = {
            가능: "possible",
            불참: "impossible",
            미정: "pending",
          }[status];
          const nagKey = `nag-meeting-${meetingId}-${memberId}`;
          const canNag =
            !lastNagTimes[nagKey] ||
            Date.now() - lastNagTimes[nagKey] > COOLDOWN_DURATION;
          const nagButtonHtml =
            status === "미정" && canNag
              ? `<button class="btn btn-outline text-xs py-1 px-2 ml-2" onclick="nagParticipant('${meetingId}', '${memberId}')">🛎️ 재촉</button>`
              : status === "미정" && !canNag
              ? `<button class="btn btn-outline text-xs py-1 px-2 ml-2 opacity-50 cursor-not-allowed" disabled>🛎️ 재촉 (쿨다운)</button>`
              : "";

          participantsHtml += `<li><strong>${getUserNameById(
            memberId
          )}</strong>: <span class="status-badge ${statusClass}">${status}</span>${reason}${nagButtonHtml}</li>`;
        });
        participantsHtml += "</ul>";

        const contentDiv = document.getElementById("content");
        contentDiv.innerHTML = `
                <div class="section-header">
                    <h2 class="section-title">🗓️ ${meeting.name} 상세</h2>
                    <button class="btn btn-outline" onclick="changeTab('meetings')">목록으로 돌아가기</button>
                </div>
                <div class="detail-item">
                    <h3>약속 정보</h3>
                    <p><strong>날짜:</strong> ${meeting.date}</p>
                    <p><strong>시간:</strong> ${meeting.time}</p>
                    <p><strong>장소:</strong> ${meeting.place}</p>
                    <p><strong>생성자:</strong> ${meeting.creator}</p>
                    <p><strong>메모:</strong> ${meeting.memo || "없음"}</p>
                </div>
                <div class="detail-item">
                    <h3>참여 현황</h3>
                    ${participantsHtml}
                </div>
                <div class="flex gap-2 mt-4">
                    <button class="btn btn-green" onclick="openMeetingParticipateModal('${
                      meeting.id
                    }')">내 참여 상태 변경</button>
                </div>
            `;
      }

      function createMeeting() {
        const name = document.getElementById("meetingName").value;
        const date = document.getElementById("meetingDate").value;
        const time = document.getElementById("meetingTime").value;
        const place = document.getElementById("meetingPlace").value;
        const memo = document.getElementById("meetingMemo").value;

        if (!name || !date || !time || !place) {
          showMessageBox(
            "필수 정보 누락",
            "약속 이름, 날짜, 시간, 장소는 필수 입력 사항입니다."
          );
          return;
        }

        const newMeeting = {
          id: generateUniqueId("meeting"),
          name,
          date,
          time,
          place,
          memo,
          creator: mockData.currentUser.name,
          participants: currentGroup.members.map((userId) => ({
            userId: userId,
            status: userId === mockData.currentUser.id ? "가능" : "미정", // Default current user to '가능'
            reason: "",
          })),
        };

        currentGroup.meetings.push(newMeeting);
        closeModal("meetingCreateModal");
        showMessageBox("성공", "새 약속이 생성되었습니다.");
        renderMeetings();
      }

      function openMeetingParticipateModal(meetingId) {
        selectedMeetingId = meetingId;
        const meeting = currentGroup.meetings.find((m) => m.id === meetingId);
        if (!meeting) {
          showMessageBox("오류", "약속을 찾을 수 없습니다.");
          return;
        }

        // Ensure all elements exist before trying to access them
        const participateModalTitle = document.getElementById(
          "participateModalTitle"
        );
        const participateMeetingName = document.getElementById(
          "participateMeetingName"
        );
        const declineReasonLabel =
          document.getElementById("declineReasonLabel");
        const declineReasonTextarea = document.getElementById("declineReason");
        const declineButton = document.getElementById("declineButton");
        const participateButton = document.getElementById("participateButton");
        const confirmDeclineButton = document.getElementById(
          "confirmDeclineButton"
        );
        const cancelDeclineButton = document.getElementById(
          "cancelDeclineButton"
        );

        if (
          !participateModalTitle ||
          !participateMeetingName ||
          !declineReasonLabel ||
          !declineReasonTextarea ||
          !declineButton ||
          !participateButton ||
          !confirmDeclineButton ||
          !cancelDeclineButton
        ) {
          showMessageBox(
            "오류",
            "모달 요소를 찾을 수 없습니다. 페이지를 새로고침 해주세요."
          );
          return;
        }

        participateModalTitle.textContent = `"${meeting.name}" 약속 참여/불참`;
        participateMeetingName.textContent = `"${meeting.name}" 약속에 대한 참여 여부`;

        // Reset modal state
        declineReasonLabel.classList.add("hidden");
        declineReasonTextarea.classList.add("hidden");
        declineReasonTextarea.value = "";

        declineButton.classList.remove("hidden");
        participateButton.classList.remove("hidden");
        confirmDeclineButton.classList.add("hidden");
        cancelDeclineButton.classList.add("hidden");

        openModal("meetingParticipateModal");
      }

      // New function to show decline reason input
      function showDeclineReasonInput() {
        const declineReasonLabel =
          document.getElementById("declineReasonLabel");
        const declineReasonTextarea = document.getElementById("declineReason");
        const declineButton = document.getElementById("declineButton");
        const participateButton = document.getElementById("participateButton");
        const confirmDeclineButton = document.getElementById(
          "confirmDeclineButton"
        );
        const cancelDeclineButton = document.getElementById(
          "cancelDeclineButton"
        );

        declineReasonLabel.classList.remove("hidden");
        declineReasonTextarea.classList.remove("hidden");

        declineButton.classList.add("hidden");
        participateButton.classList.add("hidden");
        confirmDeclineButton.classList.remove("hidden");
        cancelDeclineButton.classList.remove("hidden");
      }

      // New function to hide decline reason input (if user cancels)
      function hideDeclineReasonInput() {
        const declineReasonLabel =
          document.getElementById("declineReasonLabel");
        const declineReasonTextarea = document.getElementById("declineReason");
        const declineButton = document.getElementById("declineButton");
        const participateButton = document.getElementById("participateButton");
        const confirmDeclineButton = document.getElementById(
          "confirmDeclineButton"
        );
        const cancelDeclineButton = document.getElementById(
          "cancelDeclineButton"
        );

        declineReasonLabel.classList.add("hidden");
        declineReasonTextarea.classList.add("hidden");
        declineReasonTextarea.value = ""; // Clear input

        declineButton.classList.remove("hidden");
        participateButton.classList.remove("hidden");
        confirmDeclineButton.classList.add("hidden");
        cancelDeclineButton.classList.add("hidden");
      }

      function handleMeetingParticipation(status) {
        if (!selectedMeetingId) return;

        const meeting = currentGroup.meetings.find(
          (m) => m.id === selectedMeetingId
        );
        if (!meeting) return;

        let currentUserParticipation = meeting.participants.find(
          (p) => p.userId === mockData.currentUser.id
        );

        if (!currentUserParticipation) {
          currentUserParticipation = {
            userId: mockData.currentUser.id,
            status: "미정",
            reason: "",
          };
          meeting.participants.push(currentUserParticipation);
        }

        currentUserParticipation.status = status;
        if (status === "불참") {
          const reason = document.getElementById("declineReason").value;
          if (!reason) {
            showMessageBox("필수 입력", "불참 사유를 입력해주세요.");
            return;
          }
          currentUserParticipation.reason = reason;
        } else {
          currentUserParticipation.reason = "";
        }

        closeModal("meetingParticipateModal");
        showMessageBox(
          "성공",
          `약속 참여 상태가 "${status}"으로 업데이트되었습니다.`
        );
        renderMeetings(); // Re-render to reflect changes
        selectedMeetingId = null; // Clear selected ID
      }

      // --- Travels Tab Functions ---
      function renderTravels() {
        const contentDiv = document.getElementById("content");
        contentDiv.innerHTML = `
                <div class="section-header">
                    <h2 class="section-title">✈️ 여행 목록</h2>
                    <button class="btn btn-blue" onclick="openTravelFormModal()">여행 일정 생성</button>
                </div>
                <div id="travelsList">
                    <!-- Travels will be listed here -->
                </div>
            `;

        const travelsListDiv = document.getElementById("travelsList");
        if (currentGroup.travels.length === 0) {
          travelsListDiv.innerHTML =
            '<p class="text-gray-600">아직 등록된 여행이 없습니다.</p>';
          return;
        }

        currentGroup.travels.forEach((travel) => {
          // Display multiple assignees for roles
          let rolesSummary = travel.roles
            .map((role) => {
              const assignedNames = role.assignedTo
                .map((id) => getUserNameById(id))
                .join(", ");
              return `${role.name} - ${assignedNames || "미지정"}`;
            })
            .join(" / ");

          if (rolesSummary.length > 100) {
            // Truncate for display
            rolesSummary = rolesSummary.substring(0, 97) + "...";
          }

          const travelCard = document.createElement("div");
          travelCard.className = "card";
          travelCard.innerHTML = `
                    <div class="card-title">${travel.name}</div>
                    <div class="card-subtitle">${travel.startDate} ~ ${travel.endDate}</div>
                    <p class="card-text">역할 분담: ${rolesSummary}</p>
                    <div class="flex gap-2 mt-4">
                        <button class="btn btn-outline" onclick="viewTravelDetails('${travel.id}')">상세 보기</button>
                    </div>
                `;
          travelsListDiv.appendChild(travelCard);
        });
      }

      function viewTravelDetails(travelId) {
        const travel = currentGroup.travels.find((t) => t.id === travelId);
        if (!travel) {
          showMessageBox("오류", "여행을 찾을 수 없습니다.");
          return;
        }

        const currentUserRole = travel.roles.find((role) =>
          role.assignedTo.includes(mockData.currentUser.id)
        ); // Check if current user is assigned to any role
        const editButtonHtml = currentUserRole
          ? `<button class="btn btn-blue" onclick="openTravelRoleEditModal('${travel.id}', '${currentUserRole.name}')">내 역할 내용 수정</button>`
          : "";

        const noticeHtml = travel.notice
          ? `
                <div class="travel-notice-callout">
                    <span class="pin-icon">📌</span>
                    <div class="notice-content-wrapper">
                        <p class="font-semibold mb-1">공지사항</p>
                        <p class="notice-text">${travel.notice.replace(
                          /\n/g,
                          "<br>"
                        )}</p>
                    </div>
                    <div class="edit-button-container">
                        <button class="btn btn-outline text-sm py-1 px-3" onclick="openTravelNoticeEditModal('${
                          travel.id
                        }')">수정</button>
                    </div>
                </div>
            `
          : `
                <div class="travel-notice-callout">
                    <span class="pin-icon">📌</span>
                    <div class="notice-content-wrapper">
                        <p class="font-semibold mb-1">공지사항</p>
                        <p class="notice-text">아직 등록된 공지사항이 없습니다.</p>
                    </div>
                    <div class="edit-button-container">
                        <button class="btn btn-outline text-sm py-1 px-3" onclick="openTravelNoticeEditModal('${travel.id}')">등록</button>
                    </div>
                </div>
            `;

        let rolesHtml = '<div class="role-grid">';
        travel.roles.forEach((role) => {
          const assignedNames =
            role.assignedTo.map((id) => getUserNameById(id)).join(", ") ||
            "미지정";
          const nagKey = `nag-travel-role-${travel.id}-${role.name}`;
          const canNag =
            !lastNagTimes[nagKey] ||
            Date.now() - lastNagTimes[nagKey] > COOLDOWN_DURATION;
          const nagButtonHtml =
            role.content === "" && role.assignedTo.length > 0 && canNag // Nag if content is empty AND someone is assigned
              ? `<button class="btn btn-outline text-xs py-1 px-2 ml-2" onclick="nagRole('${
                  travel.id
                }', '${role.name}', '${role.assignedTo.join(
                  ","
                )}')">🛎️ 재촉</button>`
              : role.content === "" && role.assignedTo.length > 0 && !canNag
              ? `<button class="btn btn-outline text-xs py-1 px-2 ml-2 opacity-50 cursor-not-allowed" disabled>🛎️ 재촉 (쿨다운)</button>`
              : "";

          rolesHtml += `
                    <div class="role-item">
                        <strong>${role.name}</strong>
                        <span>${assignedNames}${nagButtonHtml}</span>
                    </div>
                `;
        });
        rolesHtml += "</div>";

        const contentDiv = document.getElementById("content");
        contentDiv.innerHTML = `
                <div class="section-header">
                    <h2 class="section-title">✈️ ${travel.name} 상세</h2>
                    <button class="btn btn-blue" onclick="openTravelFormModal('${
                      travel.id
                    }')">여행 수정</button> <!-- Changed button text -->
                    <button class="btn btn-outline" onclick="changeTab('travels')">목록으로 돌아가기</button>
                </div>
                ${noticeHtml}
                <div class="detail-item">
                    <h3>여행 정보</h3>
                    <p><strong>기간:</strong> ${travel.startDate} ~ ${
          travel.endDate
        }</p>
                    <p><strong>메모:</strong> ${travel.memo || "없음"}</p>
                </div>
                <div class="detail-item">
                    <h3>역할 분담 현황</h3>
                    ${rolesHtml}
                </div>
                <div class="detail-item mt-4">
                    <h3>준비 현황판</h3>
                    ${travel.roles
                      .map(
                        (role) => `
                        <div class="mb-4 p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                            <h4 class="font-semibold text-lg text-blue-700">${
                              role.name
                            } (${
                          role.assignedTo
                            .map((id) => getUserNameById(id))
                            .join(", ") || "미지정"
                        })</h4>
                            <p class="text-gray-700 mt-2">${
                              role.content
                                ? role.content.replace(/\n/g, "<br>")
                                : "아직 준비 내용이 없습니다."
                            }</p>
                        </div>
                    `
                      )
                      .join("")}
                </div>
                <div class="flex gap-2 mt-4">
                    ${editButtonHtml}
                </div>
            `;
      }

      // Renamed from openTravelCreateModal to handle both create and edit
      function openTravelFormModal(travelId = null) {
        selectedTravelId = travelId; // Store travelId for edit mode

        const travelFormModalTitle = document.getElementById(
          "travelFormModalTitle"
        );
        const saveTravelFormButton = document.getElementById(
          "saveTravelFormButton"
        );
        const travelNameInput = document.getElementById("travelName");
        const travelStartDateInput = document.getElementById("travelStartDate");
        const travelEndDateInput = document.getElementById("travelEndDate");
        const travelMemoInput = document.getElementById("travelMemo");
        const roleAssignmentContainer = document.getElementById(
          "roleAssignmentContainer"
        );

        // Reset form and role inputs
        travelNameInput.value = "";
        travelStartDateInput.value = "";
        travelEndDateInput.value = "";
        travelMemoInput.value = "";
        roleAssignmentContainer.innerHTML = "";
        roleInputCounter = 0; // Reset counter for new inputs

        if (travelId) {
          // Edit mode
          const travel = currentGroup.travels.find((t) => t.id === travelId);
          if (travel) {
            travelFormModalTitle.textContent = "여행 수정"; // Changed title
            saveTravelFormButton.onclick = () => saveTravelForm(true); // Set to edit mode
            travelNameInput.value = travel.name;
            travelStartDateInput.value = travel.startDate;
            travelEndDateInput.value = travel.endDate;
            travelMemoInput.value = travel.memo;
            travel.roles.forEach((role) => {
              addRoleInput(role.name, role.assignedTo); // Populate existing roles
            });
          } else {
            showMessageBox("오류", "수정할 여행을 찾을 수 없습니다.");
            return;
          }
        } else {
          // Create mode
          travelFormModalTitle.textContent = "새 여행 일정 생성";
          saveTravelFormButton.onclick = () => saveTravelForm(false); // Set to create mode
          addRoleInput(); // Add initial empty role input for new creation
        }
        openModal("travelFormModal");
      }

      let roleInputCounter = 0;
      function addRoleInput(roleName = "", assignedToIds = []) {
        // assignedToIds is now an array
        const container = document.getElementById("roleAssignmentContainer");
        const newRoleIndex = roleInputCounter++;

        const roleDiv = document.createElement("div");
        roleDiv.className = "flex items-center gap-2 mb-2";
        // Add 'multiple' attribute to the select
        roleDiv.innerHTML = `
                <input type="text" id="roleName-${newRoleIndex}" placeholder="역할 이름 (예: 숙소)" class="flex-1" value="${roleName}">
                <select id="roleAssignee-${newRoleIndex}" class="flex-1 p-2 border rounded-lg" multiple size="3">
                    <option value="">담당자 선택 (Ctrl/Cmd + 클릭으로 다중 선택)</option>
                    ${currentGroup.members
                      .map((memberId) => {
                        const userName = getUserNameById(memberId);
                        const isSelected = assignedToIds.includes(memberId)
                          ? "selected"
                          : "";
                        return `<option value="${memberId}" ${isSelected}>${userName}</option>`;
                      })
                      .join("")}
                </select>
                <button class="btn btn-red px-3 py-2 text-sm" onclick="this.parentNode.remove()">삭제</button>
            `;
        container.appendChild(roleDiv);
      }

      // Function to handle random assignment
      function randomlyAssignRoles() {
        const allMembers = [...currentGroup.members]; // Get all members of the current group
        const shuffledMembers = allMembers.sort(() => Math.random() - 0.5); // Shuffle members
        const roleInputs = document.querySelectorAll(
          "#roleAssignmentContainer .flex.items-center.gap-2.mb-2"
        );

        if (roleInputs.length === 0) {
          showMessageBox(
            "오류",
            "역할이 정의되지 않았습니다. 먼저 역할을 추가해주세요."
          );
          return;
        }

        // Clear existing selections in all role selects
        roleInputs.forEach((roleDiv) => {
          const selectElement = roleDiv.querySelector("select");
          if (selectElement) {
            Array.from(selectElement.options).forEach((option) => {
              option.selected = false;
            });
          }
        });

        let memberIndex = 0;
        // Distribute members to roles in a round-robin fashion
        for (let i = 0; i < roleInputs.length; i++) {
          const roleDiv = roleInputs[i];
          const selectElement = roleDiv.querySelector("select");
          if (!selectElement) continue;

          // Assign at least one member if available
          if (memberIndex < shuffledMembers.length) {
            const memberToAssign = shuffledMembers[memberIndex];
            Array.from(selectElement.options).forEach((option) => {
              if (option.value === memberToAssign) {
                option.selected = true;
              }
            });
            memberIndex++;
          }
        }

        // If there are still unassigned members, distribute them to roles that have capacity
        // This is a simplified approach; a more robust one might consider role "capacity"
        while (memberIndex < shuffledMembers.length) {
          for (let i = 0; i < roleInputs.length; i++) {
            if (memberIndex >= shuffledMembers.length) break;

            const roleDiv = roleInputs[i];
            const selectElement = roleDiv.querySelector("select");
            if (!selectElement) continue;

            const memberToAssign = shuffledMembers[memberIndex];
            Array.from(selectElement.options).forEach((option) => {
              if (option.value === memberToAssign) {
                option.selected = true;
              }
            });
            memberIndex++;
          }
        }
        showMessageBox(
          "랜덤 분배 완료",
          "모든 멤버가 역할에 랜덤으로 분배되었습니다."
        );
      }

      // Renamed from createTravel to handle both create and update
      function saveTravelForm(isEditMode) {
        const name = document.getElementById("travelName").value;
        const startDate = document.getElementById("travelStartDate").value;
        const endDate = document.getElementById("travelEndDate").value;
        const memo = document.getElementById("travelMemo").value;

        // Fixed validation logic for endDate
        if (!name || !startDate || !endDate) {
          showMessageBox(
            "필수 정보 누락",
            "여행 제목, 시작 날짜, 종료 날짜는 필수 입력 사항입니다."
          );
          return;
        }

        const roles = [];
        const roleInputElements = document.querySelectorAll(
          "#roleAssignmentContainer .flex.items-center.gap-2.mb-2"
        );
        roleInputElements.forEach((roleDiv) => {
          const roleNameInput = roleDiv.querySelector('input[type="text"]');
          const roleAssigneeSelect = roleDiv.querySelector("select");
          if (roleNameInput && roleAssigneeSelect) {
            const roleName = roleNameInput.value.trim();
            // Get all selected options for multi-select
            const assignedToIds = Array.from(
              roleAssigneeSelect.selectedOptions
            ).map((option) => option.value);

            if (roleName) {
              // Role name is mandatory
              roles.push({
                name: roleName,
                assignedTo: assignedToIds,
                content: "",
              });
            }
          }
        });

        if (roles.length === 0) {
          showMessageBox(
            "역할 분담 누락",
            "최소 하나 이상의 역할을 지정해야 합니다."
          );
          return;
        }

        if (isEditMode) {
          const travel = currentGroup.travels.find(
            (t) => t.id === selectedTravelId
          );
          if (travel) {
            travel.name = name;
            travel.startDate = startDate;
            travel.endDate = endDate;
            travel.memo = memo;
            // Preserve existing content for roles if they still exist
            const updatedRoles = roles.map((newRole) => {
              const existingRole = travel.roles.find(
                (oldRole) => oldRole.name === newRole.name
              );
              return {
                ...newRole,
                content: existingRole ? existingRole.content : "", // Keep old content if role name matches
              };
            });
            travel.roles = updatedRoles;
            showMessageBox("성공", "여행 정보가 수정되었습니다."); // Changed message
          }
        } else {
          const newTravel = {
            id: generateUniqueId("travel"),
            name,
            startDate,
            endDate,
            memo,
            notice: "", // Initialize with empty notice
            roles,
          };
          currentGroup.travels.push(newTravel);
          showMessageBox("성공", "새 여행 일정이 생성되었습니다.");
        }

        closeModal("travelFormModal");
        renderTravels(); // Re-render to reflect changes
        selectedTravelId = null; // Clear selected ID
      }

      function openTravelRoleEditModal(travelId, roleName) {
        selectedTravelId = travelId;
        selectedTravelRoleName = roleName;

        const travel = currentGroup.travels.find((t) => t.id === travelId);
        if (travel) {
          // Find the specific role for the current user
          const role = travel.roles.find(
            (r) =>
              r.name === roleName &&
              r.assignedTo.includes(mockData.currentUser.id)
          );
          if (role) {
            document.getElementById(
              "travelRoleEditModalTitle"
            ).textContent = `${travel.name} - ${roleName} 역할 내용 수정`;
            document.getElementById("travelRoleContent").value = role.content;
            openModal("travelRoleEditModal");
          } else {
            showMessageBox(
              "권한 없음",
              "이 역할의 담당자가 아니거나 역할을 찾을 수 없습니다."
            );
          }
        }
      }

      function saveTravelRoleContent() {
        const travel = currentGroup.travels.find(
          (t) => t.id === selectedTravelId
        );
        if (travel) {
          // Find the specific role for the current user
          const role = travel.roles.find(
            (r) =>
              r.name === selectedTravelRoleName &&
              r.assignedTo.includes(mockData.currentUser.id)
          );
          if (role) {
            role.content = document.getElementById("travelRoleContent").value;
            closeModal("travelRoleEditModal");
            showMessageBox("성공", "역할 내용이 저장되었습니다.");
            viewTravelDetails(selectedTravelId); // Re-render details to show updated notice
          }
        }
      }

      // --- Travel Notice Functions ---
      function openTravelNoticeEditModal(travelId) {
        selectedTravelId = travelId;
        const travel = currentGroup.travels.find((t) => t.id === travelId);
        if (travel) {
          document.getElementById("travelNoticeContent").value =
            travel.notice || "";
          openModal("travelNoticeEditModal");
        } else {
          showMessageBox("오류", "여행 정보를 찾을 수 없습니다.");
        }
      }

      function saveTravelNoticeContent() {
        const travel = currentGroup.travels.find(
          (t) => t.id === selectedTravelId
        );
        if (travel) {
          travel.notice = document.getElementById("travelNoticeContent").value;
          closeModal("travelNoticeEditModal");
          showMessageBox("성공", "공지사항이 저장되었습니다.");
          viewTravelDetails(selectedTravelId); // Re-render details to show updated notice
        }
      }

      // --- Birthdays Tab Functions ---
      function renderBirthdays() {
        const contentDiv = document.getElementById("content");
        contentDiv.innerHTML = `
                <div class="section-header">
                    <h2 class="section-title">🎁 생일 목록</h2>
                    <button class="btn btn-blue" onclick="openBirthdayAssignModal()">생일 담당자 지정</button>
                </div>
                <div id="birthdaysList">
                    <!-- Birthdays will be listed here -->
                </div>
            `;

        const birthdaysListDiv = document.getElementById("birthdaysList");
        if (currentGroup.birthdays.length === 0) {
          birthdaysListDiv.innerHTML =
            '<p class="text-gray-600">아직 등록된 생일이 없습니다.</p>';
          return;
        }

        // Sort birthdays by upcoming date
        const sortedBirthdays = [...currentGroup.birthdays].sort((a, b) => {
          const today = new Date();
          const currentYear = today.getFullYear();

          const dateA = new Date(`${currentYear}-${a.date}`);
          const dateB = new Date(`${currentYear}-${b.date}`);

          // If birthday has passed this year, consider it for next year
          if (dateA < today) dateA.setFullYear(today.getFullYear() + 1);
          if (dateB < today) dateB.setFullYear(today.getFullYear() + 1);

          return dateA - dateB;
        });

        sortedBirthdays.forEach((birthday) => {
          const userName = getUserNameById(birthday.userId);
          const assignedToName = birthday.assignedTo
            ? getUserNameById(birthday.assignedTo)
            : "미지정";
          const statusClass = birthday.assignedTo ? "assigned" : "unassigned";

          const birthdayCard = document.createElement("div");
          birthdayCard.className = "card";
          birthdayCard.innerHTML = `
                    <div class="card-title">${userName}의 생일</div>
                    <div class="card-subtitle">날짜: ${birthday.date}</div>
                    <p class="card-text">
                        담당자: <span class="status-badge ${statusClass}">${assignedToName}</span>
                    </p>
                    <div class="flex gap-2 mt-4">
                        <button class="btn btn-outline" onclick="viewBirthdayDetails('${
                          birthday.userId
                        }')">상세 보기</button>
                        ${
                          birthday.assignedTo === mockData.currentUser.id &&
                          birthday.userId !== mockData.currentUser.id
                            ? `<button class="btn btn-green" onclick="openBirthdayPrepareModal('${birthday.userId}')">준비 현황 공유</button>`
                            : ""
                        }
                    </div>
                `;
          birthdaysListDiv.appendChild(birthdayCard);
        });
      }

      function viewBirthdayDetails(userId) {
        const birthday = currentGroup.birthdays.find(
          (b) => b.userId === userId
        );
        if (!birthday) {
          showMessageBox("오류", "생일 정보를 찾을 수 없습니다.");
          return;
        }

        // If the current user is the birthday person, prevent viewing details
        if (userId === mockData.currentUser.id) {
          showMessageBox(
            "접근 제한",
            "자신의 생일 준비 현황은 확인할 수 없습니다."
          );
          changeTab("birthdays"); // Go back to the birthdays list
          return;
        }

        const userName = getUserNameById(birthday.userId);
        const assignedToName = birthday.assignedTo
          ? getUserNameById(birthday.assignedTo)
          : "미지정";
        const statusClass = birthday.assignedTo ? "assigned" : "unassigned";

        const contentDiv = document.getElementById("content");
        contentDiv.innerHTML = `
                <div class="section-header">
                    <h2 class="section-title">🎁 ${userName}의 생일 상세</h2>
                    <button class="btn btn-outline" onclick="changeTab('birthdays')">목록으로 돌아가기</button>
                </div>
                <div class="detail-item">
                    <h3>생일 정보</h3>
                    <p><strong>이름:</strong> ${userName}</p>
                    <p><strong>날짜:</strong> ${birthday.date}</p>
                    <p><strong>담당자:</strong> <span class="status-badge ${statusClass}">${assignedToName}</span></p>
                </div>
                <div class="detail-item mt-4">
                    <h3>준비 현황</h3>
                    <p>${
                      birthday.preparation
                        ? birthday.preparation.replace(/\n/g, "<br>")
                        : "아직 준비 내용이 없습니다."
                    }</p>
                </div>
                <div class="flex gap-2 mt-4">
                    ${
                      birthday.assignedTo === mockData.currentUser.id &&
                      birthday.userId !== mockData.currentUser.id
                        ? `<button class="btn btn-green" onclick="openBirthdayPrepareModal('${birthday.userId}')">준비 현황 공유</button>`
                        : ""
                    }
                </div>
            `;
      }

      function openBirthdayAssignModal() {
        // Find the next upcoming birthday that doesn't have an assigned person yet
        const unassignedBirthdays = currentGroup.birthdays.filter(
          (b) => !b.assignedTo
        );

        if (unassignedBirthdays.length === 0) {
          // If all birthdays have been assigned, reset the assignment history for a new cycle
          // The current user (행성이) is excluded from being assigned their own birthday.
          // So, the number of assignable members is `currentGroup.members.length - 1`.
          const assignableMembersCount = currentGroup.members.length - 1;
          if (
            currentGroup.birthdayAssignmentHistory.length >=
            assignableMembersCount
          ) {
            currentGroup.birthdayAssignmentHistory = [];
            showMessageBox(
              "알림",
              "모든 생일 담당자 지정이 완료되어, 새로운 담당자 지정 주기가 시작됩니다!"
            );
          } else {
            showMessageBox(
              "알림",
              "모든 생일 담당자가 지정되었습니다. 새로운 담당자 지정은 다음 주기에 가능합니다."
            );
            return;
          }
        }

        const sortedUnassignedBirthdays = [...unassignedBirthdays].sort(
          (a, b) => {
            const today = new Date();
            const currentYear = today.getFullYear();

            const dateA = new Date(`${currentYear}-${a.date}`);
            const dateB = new Date(`${currentYear}-${b.date}`);

            // If birthday has passed this year, consider it for next year
            if (dateA < today) dateA.setFullYear(today.getFullYear() + 1);
            if (dateB < today) dateB.setFullYear(today.getFullYear() + 1);

            return dateA - dateB;
          }
        );

        const nextBirthday = sortedUnassignedBirthdays[0];

        if (!nextBirthday) {
          showMessageBox("알림", "현재 지정할 수 있는 생일이 없습니다.");
          return;
        }

        selectedBirthdayUserId = nextBirthday.userId;
        document.getElementById(
          "birthdayAssignInfo"
        ).textContent = `다음 생일: ${getUserNameById(nextBirthday.userId)} (${
          nextBirthday.date
        })`;
        document.getElementById("assignedBirthdayPerson").textContent =
          "미지정"; // Reset display

        openModal("birthdayAssignModal");
      }

      function assignBirthdayHandler() {
        if (!selectedBirthdayUserId) {
          showMessageBox("오류", "생일을 선택해주세요.");
          return;
        }

        const birthdayToAssign = currentGroup.birthdays.find(
          (b) => b.userId === selectedBirthdayUserId
        );
        if (!birthdayToAssign) return;

        const potentialAssignees = currentGroup.members.filter(
          (memberId) =>
            memberId !== birthdayToAssign.userId && // Exclude the birthday person
            !currentGroup.birthdayAssignmentHistory.includes(memberId) // Exclude those already assigned in this cycle
        );

        if (potentialAssignees.length === 0) {
          // If all eligible members have been assigned in this cycle, reset history and try again
          currentGroup.birthdayAssignmentHistory = [];
          showMessageBox(
            "알림",
            "모든 친구가 한 번씩 생일 담당을 했습니다. 새로운 담당자 지정 주기가 시작됩니다!"
          );
          // After resetting history, try to assign again. This handles the case where all members *except* the birthday person have been assigned.
          // We need to re-filter potential assignees after resetting history.
          const newPotentialAssignees = currentGroup.members.filter(
            (memberId) =>
              memberId !== birthdayToAssign.userId &&
              !currentGroup.birthdayAssignmentHistory.includes(memberId)
          );
          if (newPotentialAssignees.length === 0) {
            showMessageBox(
              "알림",
              "현재 담당자로 지정할 수 있는 친구가 없습니다. 모든 친구가 이미 담당했습니다."
            );
            closeModal("birthdayAssignModal");
            return;
          }
          const randomIndex = Math.floor(
            Math.random() * newPotentialAssignees.length
          );
          const assignedUserId = newPotentialAssignees[randomIndex];
          birthdayToAssign.assignedTo = assignedUserId;
          currentGroup.birthdayAssignmentHistory.push(assignedUserId);
          document.getElementById("assignedBirthdayPerson").textContent =
            getUserNameById(assignedUserId);
          closeModal("birthdayAssignModal");
          showMessageBox(
            "성공",
            `${getUserNameById(
              birthdayToAssign.userId
            )}의 생일 담당자로 ${getUserNameById(
              assignedUserId
            )}님이 지정되었습니다. (새 주기 시작)`
          );
          renderBirthdays();
          selectedBirthdayUserId = null;
          return;
        }

        const randomIndex = Math.floor(
          Math.random() * potentialAssignees.length
        );
        const assignedUserId = potentialAssignees[randomIndex];

        birthdayToAssign.assignedTo = assignedUserId;
        currentGroup.birthdayAssignmentHistory.push(assignedUserId); // Add to history for this cycle

        document.getElementById("assignedBirthdayPerson").textContent =
          getUserNameById(assignedUserId);
        closeModal("birthdayAssignModal");
        showMessageBox(
          "성공",
          `${getUserNameById(
            birthdayToAssign.userId
          )}의 생일 담당자로 ${getUserNameById(
            assignedUserId
          )}님이 지정되었습니다.`
        );
        renderBirthdays();
        selectedBirthdayUserId = null;
      }

      function openBirthdayPrepareModal(userId) {
        selectedBirthdayUserId = userId;
        const birthday = currentGroup.birthdays.find(
          (b) => b.userId === userId
        );
        if (birthday && birthday.assignedTo === mockData.currentUser.id) {
          document.getElementById(
            "birthdayPrepareModalTitle"
          ).textContent = `${getUserNameById(userId)} 생일 준비 현황 공유`;
          document.getElementById("birthdayPreparationContent").value =
            birthday.preparation;
          openModal("birthdayPrepareModal");
        } else {
          showMessageBox(
            "권한 없음",
            "이 생일의 담당자가 아니거나 정보를 찾을 수 없습니다."
          );
        }
      }

      function saveBirthdayPreparation() {
        const birthday = currentGroup.birthdays.find(
          (b) => b.userId === selectedBirthdayUserId
        );
        if (birthday && birthday.assignedTo === mockData.currentUser.id) {
          birthday.preparation = document.getElementById(
            "birthdayPreparationContent"
          ).value;
          closeModal("birthdayPrepareModal");
          showMessageBox("성공", "생일 준비 현황이 저장되었습니다.");
          viewBirthdayDetails(selectedBirthdayUserId); // Re-render details
        }
      }

      // --- Expenses Tab Functions ---
      function renderExpenses() {
        const contentDiv = document.getElementById("content");
        contentDiv.innerHTML = `
                <div class="section-header">
                    <h2 class="section-title">💰 회비 목록</h2>
                    <button class="btn btn-blue" onclick="openModal('expenseCreateModal')">회비 항목 생성</button>
                </div>
                <div id="expensesList">
                    <!-- Expenses will be listed here -->
                </div>
            `;

        const expensesListDiv = document.getElementById("expensesList");
        if (currentGroup.expenses.length === 0) {
          expensesListDiv.innerHTML =
            '<p class="text-gray-600">아직 등록된 회비 항목이 없습니다.</p>';
          return;
        }

        currentGroup.expenses.forEach((expense) => {
          const currentUserPaid = expense.payers.find(
            (p) => p.userId === mockData.currentUser.id
          )?.paid;
          const paidStatusText = currentUserPaid ? "제출 완료" : "미제출";
          const paidStatusClass = currentUserPaid ? "paid" : "unpaid";

          const expenseCard = document.createElement("div");
          expenseCard.className = "card";
          let payersHtml = "";
          currentGroup.members.forEach((memberId) => {
            const payer = expense.payers.find((p) => p.userId === memberId);
            const pPaidStatus = payer ? payer.paid : false;
            const pStatusText = pPaidStatus ? "제출 완료" : "미제출";
            const pStatusClass = pPaidStatus ? "paid" : "unpaid";
            const nagKey = `nag-expense-${expense.id}-${memberId}`;
            const canNag =
              !lastNagTimes[nagKey] ||
              Date.Now() - lastNagTimes[nagKey] > COOLDOWN_DURATION;
            const nagButtonHtml =
              !pPaidStatus && canNag
                ? `<button class="btn btn-outline text-xs py-1 px-2 ml-2" onclick="nagPayer('${expense.id}', '${memberId}')">🛎️ 재촉</button>`
                : !pPaidStatus && !canNag
                ? `<button class="btn btn-outline text-xs py-1 px-2 ml-2 opacity-50 cursor-not-allowed" disabled>🛎️ 재촉 (쿨다운)</button>`
                : "";
            payersHtml += `<li><strong>${getUserNameById(
              memberId
            )}</strong>: <span class="status-badge ${pStatusClass}">${pStatusText}</span>${nagButtonHtml}</li>`;
          });

          expenseCard.innerHTML = `
                    <div class="card-title">${expense.name}</div>
                    <div class="card-subtitle">금액: ${expense.amount.toLocaleString()}원 | 마감일: ${
            expense.deadline
          }</div>
                    <p class="card-text">
                        내 상태: <span class="status-badge ${paidStatusClass}">${paidStatusText}</span>
                    </p>
                    <div class="flex gap-2 mt-4">
                        <button class="btn btn-outline" onclick="viewExpenseDetails('${
                          expense.id
                        }')">상세 보기</button>
                        ${
                          !currentUserPaid
                            ? `<button class="btn btn-green" onclick="markExpensePaid('${expense.id}')">제출 완료</button>`
                            : ""
                        }
                    </div>
                `;
          expensesListDiv.appendChild(expenseCard);
        });
      }

      function viewExpenseDetails(expenseId) {
        const expense = currentGroup.expenses.find((e) => e.id === expenseId);
        if (!expense) {
          showMessageBox("오류", "회비 항목을 찾을 수 없습니다.");
          return;
        }

        let payersHtml = "<ul>";
        currentGroup.members.forEach((memberId) => {
          const payer = expense.payers.find((p) => p.userId === memberId);
          const paidStatus = payer ? payer.paid : false; // Default to false if not found
          const statusText = paidStatus ? "제출 완료" : "미제출"; // Defined statusText here
          const statusClass = paidStatus ? "paid" : "unpaid";
          const nagKey = `nag-expense-${expense.id}-${memberId}`;
          const canNag =
            !lastNagTimes[nagKey] ||
            Date.now() - lastNagTimes[nagKey] > COOLDOWN_DURATION;
          const nagButtonHtml =
            !paidStatus && canNag
              ? `<button class="btn btn-outline text-xs py-1 px-2 ml-2" onclick="nagPayer('${expense.id}', '${memberId}')">🛎️ 재촉</button>`
              : !paidStatus && !canNag
              ? `<button class="btn btn-outline text-xs py-1 px-2 ml-2 opacity-50 cursor-not-allowed" disabled>🛎️ 재촉 (쿨다운)</button>`
              : "";
          payersHtml += `<li><strong>${getUserNameById(
            memberId
          )}</strong>: <span class="status-badge ${statusClass}">${statusText}</span>${nagButtonHtml}</li>`; // Used statusText
        });
        payersHtml += "</ul>";

        const currentUserPaid = expense.payers.find(
          (p) => p.userId === mockData.currentUser.id
        )?.paid;
        const markPaidButtonHtml = !currentUserPaid
          ? `<button class="btn btn-green" onclick="markExpensePaid('${expense.id}')">제출 완료</button>`
          : "";

        const contentDiv = document.getElementById("content");
        contentDiv.innerHTML = `
                <div class="section-header">
                    <h2 class="section-title">💰 ${expense.name} 상세</h2>
                    <button class="btn btn-outline" onclick="changeTab('expenses')">목록으로 돌아가기</button>
                </div>
                <div class="detail-item">
                    <h3>회비 정보</h3>
                    <p><strong>금액:</strong> ${expense.amount.toLocaleString()}원</p>
                    <p><strong>마감일:</strong> ${expense.deadline}</p>
                    <p><strong>벌칙:</strong> ${expense.penalty || "없음"}</p>
                </div>
                <div class="detail-item">
                    <h3>제출 현황</h3>
                    ${payersHtml}
                </div>
                <div class="flex gap-2 mt-4">
                    ${markPaidButtonHtml}
                </div>
            `;
      }

      function createExpense() {
        const name = document.getElementById("expenseName").value;
        const amount = parseInt(document.getElementById("expenseAmount").value);
        const deadline = document.getElementById("expenseDeadline").value;
        const penalty = document.getElementById("expensePenalty").value;

        if (!name || isNaN(amount) || !deadline) {
          showMessageBox(
            "필수 정보 누락",
            "회비 항목 이름, 금액, 마감일은 필수 입력 사항입니다."
          );
          return;
        }

        const newExpense = {
          id: generateUniqueId("expense"),
          name,
          amount,
          deadline,
          penalty,
          payers: currentGroup.members.map((userId) => ({
            userId: userId,
            paid: false,
          })),
        };

        // Set current user as paid by default if they are the creator or if it's a new expense they create.
        // For simplicity, let's assume they are not automatically paid on creation unless specified.
        // The scenario implies "김수린이 회비 항목 생성" 후 "김시원이 제출 완료" 이므로, 생성 시에는 모두 미납으로 둡니다.

        currentGroup.expenses.push(newExpense);
        closeModal("expenseCreateModal");
        showMessageBox("성공", "새 회비 항목이 생성되었습니다.");
        renderExpenses();
      }

      function markExpensePaid(expenseId) {
        const expense = currentGroup.expenses.find((e) => e.id === expenseId);
        if (expense) {
          let payer = expense.payers.find(
            (p) => p.userId === mockData.currentUser.id
          );
          if (!payer) {
            payer = { userId: mockData.currentUser.id, paid: false };
            expense.payers.push(payer);
          }
          payer.paid = true;
          showMessageBox("성공", "회비 제출이 완료되었습니다.");
          renderExpenses(); // Re-render to reflect changes
        }
      }

      // --- Nag Functions ---
      function nagParticipant(meetingId, userId) {
        const nagKey = `nag-meeting-${meetingId}-${userId}`;
        if (Date.now() - (lastNagTimes[nagKey] || 0) < COOLDOWN_DURATION) {
          showMessageBox("알림", "잠시 후 다시 시도해주세요. (5분 쿨다운)");
          return;
        }
        lastNagTimes[nagKey] = Date.now();
        const userName = getUserNameById(userId);
        const meeting = currentGroup.meetings.find((m) => m.id === meetingId);
        showMessageBox(
          "재촉 완료",
          `🛎️ ${userName}님에게 "${meeting.name}" 약속 참여를 재촉했습니다.`
        );
        // Re-render to update button state (disabled)
        if (currentTab === "meetings") {
          // Only re-render if on the meetings tab
          renderMeetings();
        } else if (document.getElementById("meetingDetailsView")) {
          // If on detail view
          viewMeetingDetails(meetingId);
        }
      }

      function nagRole(travelId, roleName, assignedToIdsString) {
        // assignedToIdsString is comma-separated
        const assignedToIds = assignedToIdsString.split(",");
        const nagKey = `nag-travel-role-${travelId}-${roleName}`;
        if (Date.now() - (lastNagTimes[nagKey] || 0) < COOLDOWN_DURATION) {
          showMessageBox("알림", "잠시 후 다시 시도해주세요. (5분 쿨다운)");
          return;
        }
        lastNagTimes[nagKey] = Date.now();
        const travel = currentGroup.travels.find((t) => t.id === travelId);
        const assignedNames = assignedToIds
          .map((id) => getUserNameById(id))
          .join(", ");
        showMessageBox(
          "재촉 완료",
          `🛎️ ${assignedNames}님에게 "${travel.name}" 여행의 "${roleName}" 업무를 재촉했습니다.`
        );
        // Re-render to update button state (disabled)
        if (currentTab === "travels") {
          // Only re-render if on the travels tab
          viewTravelDetails(travelId);
        }
      }

      function nagPayer(expenseId, userId) {
        const nagKey = `nag-expense-${expenseId}-${userId}`;
        if (Date.now() - (lastNagTimes[nagKey] || 0) < COOLDOWN_DURATION) {
          showMessageBox("알림", "잠시 후 다시 시도해주세요. (5분 쿨다운)");
          return;
        }
        lastNagTimes[nagKey] = Date.now();
        const userName = getUserNameById(userId);
        const expense = currentGroup.expenses.find((e) => e.id === expenseId);
        showMessageBox(
          "재촉 완료",
          `🛎️ ${userName}님에게 "${expense.name}" 회비 제출을 재촉했습니다.`
        );
        // Re-render to update button state (disabled)
        if (currentTab === "expenses") {
          // Only re-render if on the expenses tab
          renderExpenses();
        } else if (document.getElementById("expenseDetailsView")) {
          // If on detail view
          viewExpenseDetails(expenseId);
        }
      }

      // --- New Group Functions ---
      let customCategoryCounter = 0; // To ensure unique IDs for custom category inputs
      function addCustomCategoryInput() {
        const container = document.getElementById("customCategoriesContainer");
        const newIndex = customCategoryCounter++;
        const div = document.createElement("div");
        div.className = "flex items-center gap-2 mb-2";
        div.innerHTML = `
                <input type="text" id="customCategoryName-${newIndex}" placeholder="새 카테고리 이름 (예: 마라톤)" class="flex-1" required>
                <button class="btn btn-red px-3 py-2 text-sm" onclick="this.parentNode.remove()">삭제</button>
            `;
        container.appendChild(div);
      }

      function createNewGroup() {
        const newGroupName = document.getElementById("newGroupName").value;
        const newGroupPassword =
          document.getElementById("newGroupPassword").value;

        if (!newGroupName || !newGroupPassword) {
          showMessageBox(
            "필수 정보 누락",
            "모임 이름과 비밀번호는 필수 입력 사항입니다."
          );
          return;
        }

        // Get selected default categories
        const selectedCategories = [];
        const defaultCategoryCheckboxes = [
          "category-meetings",
          "category-travels",
          "category-birthdays",
          "category-expenses",
        ];
        selectedCategories.push({
          id: "dashboard",
          name: "대시보드",
          type: "system",
        }); // Dashboard is always included
        selectedCategories.push({
          id: "members",
          name: "멤버",
          type: "system",
        }); // Members is always included
        defaultCategoryCheckboxes.forEach((checkboxId) => {
          const checkbox = document.getElementById(checkboxId);
          if (checkbox && checkbox.checked) {
            selectedCategories.push({
              id: checkbox.value,
              name: checkbox.labels[0].textContent.trim(),
              type: "default",
            });
          }
        });

        // Get custom categories
        for (let i = 0; i < customCategoryCounter; i++) {
          const customCategoryInput = document.getElementById(
            `customCategoryName-${i}`
          );
          if (customCategoryInput && customCategoryInput.value.trim() !== "") {
            const customName = customCategoryInput.value.trim();
            const customId = customName.replace(/\s+/g, "-").toLowerCase(); // Simple ID generation
            selectedCategories.push({
              id: customId,
              name: customName,
              type: "custom",
            });
          }
        }

        if (selectedCategories.length === 2) {
          // Only dashboard and members selected
          showMessageBox(
            "카테고리 선택",
            "최소 하나 이상의 카테고리를 선택하거나 추가해야 합니다."
          );
          return;
        }

        const newGroup = {
          id: generateUniqueId("group"),
          name: newGroupName,
          password: newGroupPassword,
          members: [mockData.currentUser.id], // Creator is the first member
          categories: selectedCategories,
          meetings: [],
          travels: [],
          birthdays: [],
          expenses: [],
          birthdayAssignmentHistory: [],
          // Custom category data will be added dynamically if needed
        };

        // Initialize data structures for selected categories
        selectedCategories.forEach((cat) => {
          if (cat.type === "default" || cat.type === "custom") {
            // For simplicity, custom categories will also be initialized as empty arrays
            // More complex logic would be needed here to define their specific data structure
            if (!newGroup[cat.id]) {
              newGroup[cat.id] = [];
            }
          }
        });

        mockData.groups.push(newGroup);
        closeModal("groupCreateModal");
        showMessageBox(
          "모임 생성 완료",
          `'${newGroupName}' 모임이 성공적으로 생성되었습니다!`
        );
        renderGroupList(); // Re-render group list to show new group
        // Reset modal inputs
        document.getElementById("newGroupName").value = "";
        document.getElementById("newGroupPassword").value = "";
        defaultCategoryCheckboxes.forEach((checkboxId) => {
          const checkbox = document.getElementById(checkboxId);
          if (checkbox) checkbox.checked = true; // Reset to default checked
        });
        document.getElementById("customCategoriesContainer").innerHTML = ""; // Clear custom inputs
        customCategoryCounter = 0;
      }

      function copyInviteLink() {
        if (!currentGroup) return;
        const inviteLink = `모임 이름: ${currentGroup.name}\n비밀번호: ${currentGroup.password}\n(이 링크는 가상 링크이며, 실제 초대 기능은 구현되지 않았습니다.)`;

        // Use document.execCommand('copy') for broader compatibility in iframes
        const textarea = document.createElement("textarea");
        textarea.value = inviteLink;
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand("copy");
          showMessageBox(
            "링크 복사 완료",
            "모임 정보가 클립보드에 복사되었습니다!"
          );
        } catch (err) {
          showMessageBox(
            "복사 실패",
            "클립보드 복사에 실패했습니다. 수동으로 복사해주세요."
          );
        }
        document.body.removeChild(textarea);
      }

      // Function to render content for custom categories
      function renderCustomCategoryContent(categoryId) {
        const contentDiv = document.getElementById("content");
        const category = currentGroup.categories.find(
          (c) => c.id === categoryId
        );

        if (!category) {
          showMessageBox("오류", "카테고리를 찾을 수 없습니다.");
          return;
        }

        // For simplicity, custom categories will display a generic message and a placeholder for items
        // In a real application, this would involve more complex data structures and UI for each custom type
        contentDiv.innerHTML = `
                <div class="section-header">
                    <h2 class="section-title">${category.name}</h2>
                    <button class="btn btn-blue" onclick="openModal('customCategoryItemCreateModal')">새 ${category.name} 항목 추가</button>
                </div>
                <div id="${categoryId}List">
                    <p class="text-gray-600">아직 ${category.name} 항목이 없습니다.</p>
                    <p class="text-gray-500 text-sm mt-2">이것은 사용자 정의 카테고리입니다. 실제 데이터 및 기능은 추가 구현이 필요합니다.</p>
                </div>
            `;
        // You would typically have a modal and functions to add/view items for custom categories
        // e.g., openModal('customCategoryItemCreateModal', () => setupCustomCategoryItemModal(categoryId));
      }

      // --- Leave Group Functions ---
      let leaveGroupId = null; // Stores the ID of the group to be left

      function openLeaveGroupModal(groupId) {
        leaveGroupId = groupId;
        const group = mockData.groups.find((g) => g.id === groupId);
        if (!group) {
          showMessageBox("오류", "모임을 찾을 수 없습니다.");
          return;
        }
        document.getElementById(
          "leaveGroupModalTitle"
        ).textContent = `'${group.name}' 모임 나가기`;
        document.getElementById(
          "leaveGroupConfirmText"
        ).textContent = `정말 '${group.name}' 모임을 나가시겠습니까?`;
        document.getElementById("leaveQuietlyCheckbox").checked = false; // Reset checkbox state
        openModal("leaveGroupConfirmModal");
      }

      function confirmLeaveGroup() {
        if (!leaveGroupId) return;

        const leaveQuietly = document.getElementById(
          "leaveQuietlyCheckbox"
        ).checked;
        const groupIndex = mockData.groups.findIndex(
          (g) => g.id === leaveGroupId
        );

        if (groupIndex === -1) {
          showMessageBox("오류", "모임을 찾을 수 없습니다.");
          closeModal("leaveGroupConfirmModal");
          return;
        }

        const group = mockData.groups[group];

        // Remove current user from the group's members list
        group.members = group.members.filter(
          (memberId) => memberId !== mockData.currentUser.id
        );

        // If the group becomes empty, remove it (optional, based on desired behavior)
        if (group.members.length === 0) {
          mockData.groups.splice(groupIndex, 1);
          showMessageBox(
            "모임 탈퇴 완료",
            `'${group.name}' 모임에서 성공적으로 탈퇴했으며, 모임에 남은 멤버가 없어 모임이 삭제되었습니다.`
          );
        } else {
          if (leaveQuietly) {
            showMessageBox(
              "모임 탈퇴 완료",
              `'${group.name}' 모임에서 조용히 탈퇴했습니다.`
            );
          } else {
            showMessageBox(
              "모임 탈퇴 완료",
              `'${group.name}' 모임에서 탈퇴했습니다.`
            );
            // In a real app, you might notify other members here
          }
        }

        closeModal("leaveGroupConfirmModal");
        renderGroupList(); // Go back to group list
        leaveGroupId = null; // Reset
      }

      // --- Initial Load ---
      document.addEventListener("DOMContentLoaded", () => {
        renderGroupList();
      });
    </script>
  </body>
</html>
