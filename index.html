<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ëª¨ì„ ì„œë¹„ìŠ¤</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Pretendard Font CDN -->
    <link
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css"
      rel="stylesheet" />
    <style>
      body {
        font-family: "Pretendard", sans-serif; /* Changed font to Pretendard */
        background-color: #f0f2f5; /* Light gray background */
        color: #333;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
      }
      .container {
        background-color: #ffffff;
        border-radius: 1.5rem; /* More rounded corners */
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); /* Softer, larger shadow */
        width: 100%;
        max-width: 960px; /* Max width for desktop */
        margin: 2rem;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 80vh;
      }
      header {
        background-color: #4285f4; /* Google Blue */
        color: white;
        padding: 1.5rem 2rem;
        border-top-left-radius: 1.5rem;
        border-top-right-radius: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        font-size: 1.5rem;
        flex-wrap: wrap; /* Allow header content to wrap */
        gap: 1rem; /* Gap between header sections */
      }
      header .back-button {
        background: none;
        border: none;
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0.5rem 1rem;
        border-radius: 0.75rem;
        transition: background-color 0.2s ease-in-out;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      header .back-button:hover {
        background-color: rgba(255, 255, 255, 0.2);
      }
      header .header-title-container {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-shrink: 0; /* Prevent shrinking too much */
      }
      header .header-right-section {
        display: flex;
        align-items: center;
        gap: 0.5rem; /* Reduced gap for better fit */
        flex-wrap: wrap; /* Allow wrapping on smaller screens */
        justify-content: flex-end; /* Align to end when wrapped */
        flex-grow: 1; /* Allow it to take available space */
        min-width: 0; /* Allow content to shrink */
      }
      header .header-right-section .welcome-message {
        font-size: 1rem; /* Default smaller font for welcome message */
        white-space: normal; /* Allow wrapping on small screens */
        flex-shrink: 0; /* Prevent welcome message from shrinking */
        text-align: right; /* Align text to right within its space */
      }
      @media (min-width: 768px) {
        /* Adjust for larger screens */
        header .header-right-section {
          gap: 1rem; /* Restore larger gap on larger screens */
        }
        header .header-right-section .welcome-message {
          font-size: 1.25rem; /* Larger font on larger screens */
          white-space: nowrap; /* Keep on one line for larger screens */
        }
      }

      nav {
        background-color: #e8f0fe; /* Light blue for nav */
        padding: 0.5rem 2rem;
        display: flex;
        gap: 1rem;
        border-bottom: 1px solid #d2e3fc;
      }
      nav button {
        padding: 0.75rem 1.25rem;
        border-radius: 0.75rem;
        font-weight: 500;
        color: #4285f4;
        background-color: transparent;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
      }
      nav button.active {
        background-color: #4285f4;
        color: white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      nav button:hover:not(.active) {
        background-color: #d2e3fc;
      }
      .content {
        padding: 2rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        /* Added for smooth transitions */
        transition: opacity 0.3s ease-in-out;
      }
      /* Styles for fade-out and fade-in animations */
      .content.fade-out {
        opacity: 0;
      }
      .content.fade-in {
        opacity: 0; /* Start from invisible for fade-in */
      }

      .card {
        background-color: #ffffff;
        border-radius: 1rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: transform 0.2s ease-in-out;
        cursor: pointer;
        border: 1px solid #e0e0e0;
      }
      .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
      }
      .card-title {
        font-weight: 600;
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
        color: #1a73e8; /* Google Blue */
      }
      .card-subtitle {
        font-size: 0.9rem;
        color: #616161;
        margin-bottom: 0.75rem;
      }
      .card-text {
        font-size: 1rem;
        color: #424242;
        line-height: 1.5;
      }

      /* Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
      }
      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }
      .modal-content {
        background-color: #ffffff;
        padding: 2rem;
        border-radius: 1.5rem;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        width: 90%;
        max-width: 500px;
        /* Flexbox for internal layout to allow scrolling body */
        display: flex;
        flex-direction: column;
        max-height: 90vh; /* Limit height to enable scrolling */
        transform: translateY(-20px);
        opacity: 0;
        transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        position: relative; /* For close button positioning */
      }
      .modal-overlay.show .modal-content {
        transform: translateY(0);
        opacity: 1;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-shrink: 0; /* Prevent header from shrinking */
      }
      .modal-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1a73e8;
      }
      .modal-close-button {
        background: none;
        border: none;
        font-size: 2rem;
        color: #616161;
        cursor: pointer;
        transition: color 0.2s ease-in-out;
      }
      .modal-close-button:hover {
        color: #333;
      }
      .modal-body {
        flex-grow: 1; /* Allow body to take available space */
        overflow-y: auto; /* Enable vertical scrolling for body content */
        padding-right: 0.5rem; /* Add some padding for scrollbar */
        margin-right: -0.5rem; /* Counteract scrollbar padding for full width */
      }
      .modal-body label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #424242;
      }
      .modal-body input[type="text"],
      .modal-body input[type="date"],
      .modal-body input[type="time"],
      .modal-body input[type="number"],
      .modal-body textarea,
      .modal-body select {
        width: 100%;
        padding: 0.75rem;
        margin-bottom: 1rem;
        border: 1px solid #ccc;
        border-radius: 0.75rem;
        font-size: 1rem;
        box-sizing: border-box;
        transition: border-color 0.2s ease-in-out;
      }
      .modal-body input:focus,
      .modal-body textarea:focus,
      .modal-body select:focus {
        outline: none;
        border-color: #4285f4;
        box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
      }
      .modal-body textarea {
        min-height: 100px;
        resize: vertical;
      }
      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 1.5rem;
        flex-shrink: 0; /* Prevent footer from shrinking */
      }
      .modal-footer button {
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out,
          box-shadow 0.2s ease-in-out;
        border: none;
      }
      .modal-footer .btn-primary {
        background-color: #4285f4;
        color: white;
        box-shadow: 0 4px 10px rgba(66, 133, 244, 0.3);
      }
      .modal-footer .btn-primary:hover {
        background-color: #357ae8;
        box-shadow: 0 6px 15px rgba(66, 133, 244, 0.4);
      }
      .modal-footer .btn-secondary {
        background-color: #e0e0e0;
        color: #424242;
      }
      .modal-footer .btn-secondary:hover {
        background-color: #c0c0c0;
      }

      /* General Buttons */
      .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out,
          box-shadow 0.2s ease-in-out;
        border: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }
      .btn-blue {
        background-color: #4285f4;
        color: white;
        box-shadow: 0 4px 10px rgba(66, 133, 244, 0.3);
      }
      .btn-blue:hover {
        background-color: #357ae8;
        box-shadow: 0 6px 15px rgba(66, 133, 244, 0.4);
      }
      .btn-red {
        background-color: #ea4335; /* Google Red */
        color: white;
        box-shadow: 0 4px 10px rgba(234, 67, 53, 0.3);
      }
      .btn-red:hover {
        background-color: #d1392c;
        box-shadow: 0 6px 15px rgba(234, 67, 53, 0.4);
      }
      .btn-green {
        background-color: #34a853; /* Google Green */
        color: white;
        box-shadow: 0 4px 10px rgba(52, 168, 83, 0.3);
      }
      .btn-green:hover {
        background-color: #2c8b46;
        box-shadow: 0 6px 15px rgba(52, 168, 83, 0.4);
      }
      /* Modified .btn-outline for always visible white background */
      .btn-outline {
        background-color: #ffffff; /* Default white background */
        color: #4285f4; /* Blue text */
        border: 1px solid #4285f4; /* Blue border */
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
      }
      .btn-outline:hover {
        background-color: #f0f0f0; /* Slightly darker white/light gray on hover */
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); /* Slightly more prominent shadow on hover */
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #eee;
      }
      .section-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: #333;
      }
      .detail-item {
        background-color: #f8f9fa;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border: 1px solid #e0e0e0;
      }
      .detail-item h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1a73e8;
        margin-bottom: 0.5rem;
      }
      .detail-item p {
        font-size: 1rem;
        color: #424242;
        margin-bottom: 0.5rem;
        white-space: pre-wrap; /* Preserve whitespace and line breaks */
      }
      .detail-item ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .detail-item ul li {
        padding: 0.25rem 0;
        color: #424242;
      }
      .detail-item ul li strong {
        color: #333;
      }
      .detail-item .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.85rem;
        font-weight: 500;
        margin-left: 0.5rem;
      }
      .status-badge.possible {
        background-color: #e6ffe6;
        color: #34a853;
      }
      .status-badge.impossible {
        background-color: #ffe6e6;
        color: #ea4335;
      }
      .status-badge.pending {
        background-color: #fffbe6;
        color: #fbbc04;
      }
      .status-badge.paid {
        background-color: #e6ffe6;
        color: #34a853;
      }
      .status-badge.unpaid {
        background-color: #ffe6e6;
        color: #ea4335;
      }
      .status-badge.assigned {
        background-color: #e8f0fe;
        color: #4285f4;
      }
      .status-badge.unassigned {
        background-color: #f0f2f5;
        color: #616161;
      }

      .role-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }
      .role-item {
        background-color: #e8f0fe;
        padding: 1rem;
        border-radius: 0.75rem;
        text-align: center;
        font-size: 0.9rem;
        color: #4285f4;
        font-weight: 500;
        border: 1px solid #d2e3fc;
      }
      .role-item strong {
        display: block;
        font-size: 1.1rem;
        color: #1a73e8;
        margin-bottom: 0.25rem;
      }

      /* Travel Notice Specific Style (Notion Callout like) */
      .travel-notice-callout {
        background-color: #e6f7ff; /* Light blue background */
        border-left: 4px solid #1890ff; /* Blue left border */
        border-radius: 0.75rem;
        padding: 1rem 1.5rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        font-size: 1rem;
        color: #333;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }
      .travel-notice-callout .pin-icon {
        font-size: 1.5rem;
        line-height: 1;
        color: #1890ff; /* Blue icon */
      }
      .travel-notice-callout .notice-content-wrapper {
        flex-grow: 1;
      }
      .travel-notice-callout .notice-text {
        white-space: pre-wrap;
      }
      .travel-notice-callout .edit-button-container {
        flex-shrink: 0;
        margin-left: auto; /* Push to the right */
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .container {
          margin: 1rem;
          border-radius: 1rem;
        }
        header {
          padding: 1rem 1.5rem;
          font-size: 1.25rem;
          border-top-left-radius: 1rem;
          border-top-right-radius: 1rem;
          flex-direction: column; /* Stack items vertically on small screens */
          align-items: flex-start; /* Align to start when stacked */
          gap: 0.5rem; /* Smaller gap when stacked */
        }
        header .header-title-container {
          width: 100%; /* Take full width */
          justify-content: flex-start; /* Align title to start */
        }
        header .header-right-section {
          width: 100%; /* Take full width */
          justify-content: flex-start; /* Align right section to start when stacked */
          flex-wrap: wrap; /* Ensure buttons/text wrap if needed */
          gap: 0.5rem; /* Smaller gap for wrapped items */
        }
        header .header-right-section .welcome-message {
          font-size: 0.9rem; /* Even smaller font on very small screens */
          white-space: normal; /* Allow welcome message to wrap */
        }
        nav {
          flex-wrap: wrap;
          padding: 0.5rem 1.5rem;
        }
        nav button {
          flex-grow: 1;
          text-align: center;
          padding: 0.6rem 1rem;
          font-size: 0.9rem;
        }
        .content {
          padding: 1.5rem;
        }
        .card {
          padding: 1rem;
        }
        .card-title {
          font-size: 1.1rem;
        }
        .modal-content {
          padding: 1.5rem;
          border-radius: 1rem;
        }
        .modal-title {
          font-size: 1.5rem;
        }
        .section-title {
          font-size: 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <div id="app" class="container">
      <!-- Header will be dynamically loaded -->
      <!-- Navigation will be dynamically loaded -->
      <div id="content" class="content">
        <!-- Content will be dynamically loaded -->
      </div>
    </div>

    <!-- Modals moved outside the #app container to ensure they are always in DOM -->
    <!-- Group Create Modal -->
    <div id="groupCreateModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">ìƒˆ ëª¨ì„ ìƒì„±</h2>
          <button
            class="modal-close-button"
            onclick="closeModal('groupCreateModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <label for="newGroupName">ëª¨ì„ ì´ë¦„</label>
          <input
            type="text"
            id="newGroupName"
            placeholder="ì˜ˆ: ìš°í…Œì½” ë ˆë²¨1 ë¦¬ì‚¬ì¡°"
            required />

          <label for="newGroupPassword">ëª¨ì„ ë¹„ë°€ë²ˆí˜¸</label>
          <input
            type="password"
            id="newGroupPassword"
            placeholder="ëª¨ì„ì— ì°¸ì—¬í•  ë•Œ í•„ìš”í•©ë‹ˆë‹¤."
            required />

          <h3 class="font-semibold text-lg mt-4 mb-2 text-gray-700">
            ì¹´í…Œê³ ë¦¬ ì„ íƒ
          </h3>
          <div class="grid grid-cols-2 gap-2 mb-4">
            <label class="flex items-center">
              <input
                type="checkbox"
                id="category-meetings"
                value="meetings"
                checked
                class="mr-2" />
              ì•½ì†
            </label>
            <label class="flex items-center">
              <input
                type="checkbox"
                id="category-travels"
                value="travels"
                checked
                class="mr-2" />
              ì—¬í–‰
            </label>
            <label class="flex items-center">
              <input
                type="checkbox"
                id="category-birthdays"
                value="birthdays"
                checked
                class="mr-2" />
              ìƒì¼
            </label>
            <label class="flex items-center">
              <input
                type="checkbox"
                id="category-expenses"
                value="expenses"
                checked
                class="mr-2" />
              íšŒë¹„
            </label>
          </div>
          <div id="customCategoriesContainer">
            <!-- Custom categories will be added here -->
          </div>
          <button
            class="btn btn-outline w-full mt-2"
            onclick="addCustomCategoryInput()">
            + ì‚¬ìš©ì ì •ì˜ ì¹´í…Œê³ ë¦¬ ì¶”ê°€
          </button>
        </div>
        <div class="modal-footer">
          <button
            class="btn-secondary"
            onclick="closeModal('groupCreateModal')">
            ì·¨ì†Œ
          </button>
          <button class="btn-primary" onclick="createNewGroup()">
            ëª¨ì„ ìƒì„±
          </button>
        </div>
      </div>
    </div>

    <!-- Meeting Create Modal -->
    <div id="meetingCreateModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">ìƒˆ ì•½ì† ìƒì„±</h2>
          <button
            class="modal-close-button"
            onclick="closeModal('meetingCreateModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <label for="meetingName">ì•½ì† ì´ë¦„</label>
          <input
            type="text"
            id="meetingName"
            placeholder="ì˜ˆ: 311 ì •ê¸° ëª¨ì„"
            required />

          <label for="meetingDate">ë‚ ì§œ</label>
          <input type="date" id="meetingDate" required />

          <label for="meetingTime">æ—¶é—´</label>
          <input type="time" id="meetingTime" required />

          <label for="meetingPlace">ì¥ì†Œ</label>
          <input
            type="text"
            id="meetingPlace"
            placeholder="ì˜ˆ: ì˜¤ëª©êµ ê²½ì„±ì£¼ë§‰"
            required />

          <label for="meetingMemo">ë©”ëª¨ (ì„ íƒ ì‚¬í•­)</label>
          <textarea
            id="meetingMemo"
            rows="3"
            placeholder="ì¶”ê°€ ì„¤ëª…"></textarea>
        </div>
        <div class="modal-footer">
          <button
            class="btn-secondary"
            onclick="closeModal('meetingCreateModal')">
            ì·¨ì†Œ
          </button>
          <button class="btn-primary" onclick="createMeeting()">ì €ì¥</button>
        </div>
      </div>
    </div>

    <!-- Meeting Participate/Decline Modal -->
    <div id="meetingParticipateModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="participateModalTitle">ì•½ì† ì°¸ì—¬/ë¶ˆì°¸</h2>
          <button
            class="modal-close-button"
            onclick="closeModal('meetingParticipateModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <p id="participateMeetingName" class="text-lg font-semibold mb-4"></p>
          <label for="declineReason" class="hidden" id="declineReasonLabel"
            >ë¶ˆì°¸ ì‚¬ìœ </label
          >
          <textarea
            id="declineReason"
            rows="3"
            placeholder="ë¶ˆì°¸ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."
            class="hidden"></textarea>
        </div>
        <div class="modal-footer" id="participateModalFooter">
          <!-- Buttons will be dynamically managed -->
          <button
            class="btn-red"
            id="declineButton"
            onclick="showDeclineReasonInput()">
            ë¶ˆì°¸
          </button>
          <button
            class="btn-green"
            id="participateButton"
            onclick="handleMeetingParticipation('ê°€ëŠ¥')">
            ì°¸ì—¬
          </button>
          <button
            class="btn-primary hidden"
            id="confirmDeclineButton"
            onclick="handleMeetingParticipation('ë¶ˆì°¸')">
            í™•ì¸
          </button>
          <button
            class="btn-secondary hidden"
            id="cancelDeclineButton"
            onclick="hideDeclineReasonInput()">
            ì·¨ì†Œ
          </button>
        </div>
      </div>
    </div>

    <!-- Travel Create/Edit Form Modal (Renamed from travelCreateModal) -->
    <div id="travelFormModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="travelFormModalTitle">
            ìƒˆ ì—¬í–‰ ì¼ì • ìƒì„±
          </h2>
          <button
            class="modal-close-button"
            onclick="closeModal('travelFormModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <label for="travelName">ì—¬í–‰ ì œëª©</label>
          <input
            type="text"
            id="travelName"
            placeholder="ì˜ˆ: ë² íŠ¸ë‚¨ ë‹¤ë‚­"
            required />

          <label for="travelStartDate">ì‹œì‘ ë‚ ì§œ</label>
          <input type="date" id="travelStartDate" required />

          <label for="travelEndDate">ì¢…ë£Œ ë‚ ì§œ</label>
          <input type="date" id="travelEndDate" required />

          <label for="travelMemo">ë©”ëª¨ (ì„ íƒ ì‚¬í•­)</label>
          <textarea id="travelMemo" rows="3" placeholder="ì¶”ê°€ ì„¤ëª…"></textarea>

          <h3 class="font-semibold text-lg mt-4 mb-2 text-gray-700">
            ì—­í•  ë¶„ë‹´
          </h3>
          <div id="roleAssignmentContainer">
            <!-- Roles will be dynamically added here -->
          </div>
          <button class="btn btn-outline w-full mt-4" onclick="addRoleInput()">
            + ì—­í•  ì¶”ê°€
          </button>
          <button
            class="btn btn-blue w-full mt-2"
            onclick="randomlyAssignRoles()">
            ëœë¤ ë¶„ë°°
          </button>
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" onclick="closeModal('travelFormModal')">
            ì·¨ì†Œ
          </button>
          <button
            class="btn-primary"
            id="saveTravelFormButton"
            onclick="saveTravelForm(false)">
            ì €ì¥
          </button>
        </div>
      </div>
    </div>

    <!-- Travel Role Edit Content Modal (Existing for role content editing) -->
    <div id="travelRoleEditModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="travelRoleEditModalTitle">
            ì—­í•  ë‚´ìš© ìˆ˜ì •
          </h2>
          <button
            class="modal-close-button"
            onclick="closeModal('travelRoleEditModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <label for="travelRoleContent">å†…å®¹</label>
          <textarea
            id="travelRoleContent"
            rows="10"
            placeholder="ë‹´ë‹¹í•œ ì—­í• ì— ëŒ€í•œ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
        </div>
        <div class="modal-footer">
          <button
            class="btn-secondary"
            onclick="closeModal('travelRoleEditModal')">
            ì·¨ì†Œ
          </button>
          <button class="btn-primary" onclick="saveTravelRoleContent()">
            ì €ì¥
          </button>
        </div>
      </div>
    </div>

    <!-- Travel Notice Edit Modal -->
    <div id="travelNoticeEditModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">ì—¬í–‰ ê³µì§€ì‚¬í•­ ìˆ˜ì •</h2>
          <button
            class="modal-close-button"
            onclick="closeModal('travelNoticeEditModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <label for="travelNoticeContent">ê³µì§€ì‚¬í•­ ë‚´ìš©</label>
          <textarea
            id="travelNoticeContent"
            rows="5"
            placeholder="ê³µì§€ì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
        </div>
        <div class="modal-footer">
          <button
            class="btn-secondary"
            onclick="closeModal('travelNoticeEditModal')">
            ì·¨ì†Œ
          </button>
          <button class="btn-primary" onclick="saveTravelNoticeContent()">
            ì €ì¥
          </button>
        </div>
      </div>
    </div>

    <!-- Birthday Assign Modal -->
    <div id="birthdayAssignModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">ìƒì¼ ë‹´ë‹¹ì ì§€ì •</h2>
          <button
            class="modal-close-button"
            onclick="closeModal('birthdayAssignModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <p id="birthdayAssignInfo" class="text-lg font-semibold mb-4"></p>
          <p class="text-md text-gray-600">
            ì„ íƒëœ ë‹´ë‹¹ì: <strong id="assignedBirthdayPerson">ë¯¸ì§€ì •</strong>
          </p>
        </div>
        <div class="modal-footer">
          <button
            class="btn-secondary"
            onclick="closeModal('birthdayAssignModal')">
            ì·¨ì†Œ
          </button>
          <button class="btn-primary" onclick="assignBirthdayHandler()">
            ë‹´ë‹¹ì ì§€ì •
          </button>
        </div>
      </div>
    </div>

    <!-- Birthday Prepare Modal -->
    <div id="birthdayPrepareModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="birthdayPrepareModalTitle">
            ìƒì¼ ì¤€ë¹„ í˜„í™© ê³µìœ 
          </h2>
          <button
            class="modal-close-button"
            onclick="closeModal('birthdayPrepareModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <label for="birthdayPreparationContent">ì¤€ë¹„ í˜„í™©</label>
          <textarea
            id="birthdayPreparationContent"
            rows="10"
            placeholder="ì„ ë¬¼ í›„ë³´, ì¼€ì´í¬ ì˜µì…˜ ë“±ì„ ê³µìœ í•´ì£¼ì„¸ìš”."></textarea>
        </div>
        <div class="modal-footer">
          <button
            class="btn-secondary"
            onclick="closeModal('birthdayPrepareModal')">
            ì·¨ì†Œ
          </button>
          <button class="btn-primary" onclick="saveBirthdayPreparation()">
            ì €ì¥
          </button>
        </div>
      </div>
    </div>

    <!-- Expense Create Modal -->
    <div id="expenseCreateModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">ìƒˆ íšŒë¹„ í•­ëª© ìƒì„±</h2>
          <button
            class="modal-close-button"
            onclick="closeModal('expenseCreateModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <label for="expenseName">íšŒë¹„ í•­ëª© ì´ë¦„</label>
          <input
            type="text"
            id="expenseName"
            placeholder="ì˜ˆ: ì´ë²ˆ ì—¬í–‰ íšŒë¹„"
            required />

          <label for="expenseAmount">ê¸ˆì•¡ (ì›)</label>
          <input
            type="number"
            id="expenseAmount"
            placeholder="ì˜ˆ: 20000"
            required />

          <label for="expenseDeadline">ë§ˆê°ì¼</label>
          <input type="date" id="expenseDeadline" required />

          <label for="expensePenalty">ë²Œì¹™ (ì„ íƒ ì‚¬í•­)</label>
          <input
            type="text"
            id="expensePenalty"
            placeholder="ì˜ˆ: ë¯¸ë‚© ì‹œ ë‹¤ìŒ ì•½ì† ì»¤í”¼ ì‚¬ê¸°" />
        </div>
        <div class="modal-footer">
          <button
            class="btn-secondary"
            onclick="closeModal('expenseCreateModal')">
            ì·¨ì†Œ
          </button>
          <button class="btn-primary" onclick="createExpense()">ì €ì¥</button>
        </div>
      </div>
    </div>

    <!-- Leave Group Confirmation Modal -->
    <div id="leaveGroupConfirmModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="leaveGroupModalTitle">ëª¨ì„ ë‚˜ê°€ê¸°</h2>
          <button
            class="modal-close-button"
            onclick="closeModal('leaveGroupConfirmModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <p id="leaveGroupConfirmText" class="text-lg font-semibold mb-4">
            ì •ë§ ì´ ëª¨ì„ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?
          </p>
          <label class="flex items-center mt-4">
            <input type="checkbox" id="leaveQuietlyCheckbox" class="mr-2" />
            ì¡°ìš©íˆ ë‚˜ê°€ê¸°
          </label>
        </div>
        <div class="modal-footer">
          <button
            class="btn-secondary"
            onclick="closeModal('leaveGroupConfirmModal')">
            ì·¨ì†Œ
          </button>
          <button class="btn-red" onclick="confirmLeaveGroup()">ë‚˜ê°€ê¸°</button>
        </div>
      </div>
    </div>

    <!-- Message Box Modal (for alerts) -->
    <div id="messageBoxModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="messageBoxTitle">ì•Œë¦¼</h2>
          <button
            class="modal-close-button"
            onclick="closeModal('messageBoxModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <p id="messageBoxContent" class="text-lg text-gray-700"></p>
        </div>
        <div class="modal-footer">
          <button class="btn-primary" onclick="closeModal('messageBoxModal')">
            í™•ì¸
          </button>
        </div>
      </div>
    </div>

    <script>
      // Mock Data
      const mockData = {
        currentUser: {
          id: "user-hangseong-i",
          name: "í–‰ì„±ì´",
          birthday: "2002-07-01", // Changed to 2002
        },
        users: [
          { id: "user-soorin", name: "ê¹€ìˆ˜ë¦°", birthday: "2002-11-05" }, // Changed to 2002
          { id: "user-siwon", name: "ê¹€ì‹œì›", birthday: "2002-02-26" }, // Changed to 2002
          { id: "user-yujin", name: "ì´ìœ ì§„", birthday: "2002-10-30" }, // Changed to 2002
          { id: "user-boryeong", name: "ë‚¨ë³´ë ¹", birthday: "2002-03-17" }, // Changed to 2002
          { id: "user-hangseong-i", name: "í–‰ì„±ì´", birthday: "2002-08-20" }, // Changed to 2002, added birthday for testing
          { id: "user-gyeongmin", name: "ê³ ê²½ë¯¼", birthday: "2002-01-01" }, // Changed to 2002
          { id: "user-hyeyun", name: "í˜œìœ¤", birthday: "2002-01-02" }, // Changed to 2002
          { id: "user-jaeyi", name: "ì¬ì´", birthday: "2002-01-03" }, // Changed to 2002
          { id: "user-jisu", name: "ì§€ìˆ˜", birthday: "2002-01-04" }, // Changed to 2002
          // New users for 'ìš°í…Œì½” ë ˆë²¨1 ë¦¬ì‚¬ì¡°' (unchanged)
          { id: "user-may", name: "ë©”ì´", birthday: "1999-04-10" },
          { id: "user-minggom", name: "ë°ê³°", birthday: "1999-05-20" },
          { id: "user-pora", name: "í¬ë¼", birthday: "1999-07-25" },
          { id: "user-meonggu", name: "ë©êµ¬", birthday: "1999-08-15" },
          { id: "user-lisa", name: "ë¦¬ì‚¬", birthday: "1999-09-01" },
          { id: "user-dompu", name: "ë”í‘¸", birthday: "1999-10-10" },
          { id: "user-jensen", name: "ì  ìŠ¨", birthday: "1999-11-20" },
          { id: "user-popo", name: "í¬í¬", birthday: "1999-12-05" },
          { id: "user-jjanggu", name: "ì§±êµ¬", birthday: "1999-01-25" },
          { id: "user-gaion", name: "ê°€ì´ì˜¨", birthday: "1999-02-14" },
          { id: "user-flint", name: "í”Œë¦°íŠ¸", birthday: "1999-03-03" },
        ],
        groups: [
          {
            id: "group-311",
            name: "311",
            password: "311password", // Added password
            members: [
              "user-soorin",
              "user-siwon",
              "user-yujin",
              "user-boryeong",
              "user-hangseong-i",
              "user-gyeongmin",
              "user-hyeyun",
              "user-jaeyi",
              "user-jisu",
            ],
            categories: [
              // Default categories
              { id: "dashboard", name: "ëŒ€ì‹œë³´ë“œ", type: "system" },
              { id: "meetings", name: "ì•½ì†", type: "default" },
              { id: "travels", name: "ì—¬í–‰", type: "default" },
              { id: "birthdays", name: "ìƒì¼", type: "default" },
              { id: "expenses", name: "íšŒë¹„", type: "default" },
              { id: "members", name: "ë©¤ë²„", type: "system" }, // Added members category
            ],
            meetings: [
              {
                id: "meeting-1",
                name: "311 ì •ê¸° ëª¨ì„",
                date: "2025-07-05",
                time: "20:00",
                place: "ì˜¤ëª©êµ ê²½ì„±ì£¼ë§‰",
                memo: "",
                creator: "ê¹€ìˆ˜ë¦°",
                participants: [
                  { userId: "user-soorin", status: "ê°€ëŠ¥", reason: "" },
                  { userId: "user-boryeong", status: "ê°€ëŠ¥", reason: "" },
                  { userId: "user-hangseong-i", status: "ë¯¸ì •", reason: "" }, // Current user initial status
                ],
              },
              {
                id: "meeting-2",
                name: "ì—°ë§ íŒŒí‹°",
                date: "2025-12-28",
                time: "20:00",
                place: "í™ëŒ€ íŒŒí‹°ë£¸",
                memo: "",
                creator: "ê¹€ìˆ˜ë¦°",
                participants: [
                  { userId: "user-soorin", status: "ê°€ëŠ¥", reason: "" },
                  { userId: "user-boryeong", status: "ê°€ëŠ¥", reason: "" },
                  { userId: "user-siwon", status: "ê°€ëŠ¥", reason: "" },
                  { userId: "user-yujin", status: "ê°€ëŠ¥", reason: "" },
                  { userId: "user-hangseong-i", status: "ë¯¸ì •", reason: "" }, // Current user initial status
                ],
              },
            ],
            travels: [
              {
                id: "travel-1",
                name: "ë² íŠ¸ë‚¨ ë‹¤ë‚­",
                startDate: "2026-06-27", // Changed year to 2026
                endDate: "2026-07-01", // Changed year to 2026
                memo: "",
                notice:
                  "ì˜ˆì‚°ì€ ì¸ë‹¹ 40ì´ê³ , ë³¸ì¸ì´ ì‡¼í•‘í•  ë§Œí¼ ì¶”ê°€ì ìœ¼ë¡œ í™˜ì „í•´ì˜¤ê¸°", // Added notice
                roles: [
                  {
                    name: "ìˆ™ì†Œ",
                    assignedTo: ["user-soorin"],
                    content: `ğŸ¨ ë‹¤ë‚­ í˜¸í…” ì •ë¦¬\n\nğŸ“ë„¤ìŠ¤íƒ€í˜¸í…” 6/27~28 (1ë°•)\nhttps://maps.app.goo.gl/cDvcXLRYXCg6EBHJA?g_st=com.google.maps.preview.copy\nğŸ“ì½”ì§€ë‹¤ë‚­ ë¶€í‹°í¬ í˜¸í…” 6/28~30 (2ë°•)\nhttps://maps.app.goo.gl/zq9Q3Mt6SqVzhSBy8?g_st=com.google.maps.preview.copy\n\nâœ”ï¸í˜¸í…”ì€ 2ëª…ì”© ë°© 4ê°œ ì˜ˆì•½\nâœ”ï¸ë„¤ìŠ¤íƒ€ëŠ” í•´ì•ˆìª½, ì½”ì§€ë‹¤ë‚­ì€ ë„ì‹¬ìª½\nâœ”ï¸ì•„ê³ ë‹¤ë¡œ ì˜ˆì•½, ìºì‰¬ë°±ì€ ë“¤ì–´ì˜¤ëŠ”ë°ë¡œ í™˜ê¸‰ ì˜ˆì •`,
                  },
                  {
                    name: "ê´€ê´‘",
                    assignedTo: ["user-hangseong-i"],
                    content: `ğŸšì¸ì²œê³µí•­ê¹Œì§€ ê°€ëŠ” ì½œë²¤ğŸš\n\n1) ë‹¹ì‚°ì—­ì—ì„œ ì˜¤ì „ 2ì‹œ (ê¹€ì‹œì›, ê³ ê²½ë¯¼)\n2) ëª©ë™ 41íƒ€ì›Œì—ì„œ ì˜¤ì „ 2ì‹œ 10ë¶„ (ë‚¨ë³´ë ¹, í˜œìœ¤, ì¬ì´, ê¹€ìˆ˜ë¦°, ì§€ìˆ˜)\n3) ëª©ë™ê³ ì—ì„œ ì˜¤ì „ 2ì‹œ 20ë¶„ (ì´ìœ ì§„)\n\n*ì ˆëŒ€ ëŠ¦ì§€ ë§ê³  ì‹œê°„ ì—„ìˆ˜!! 2),3)ì—ì„œ íƒ€ëŠ” ì‚¬ëŒë“¤ì€ 5ë¶„ì”© ì¼ì° ì™€ì„œ ê¸°ë‹¤ë¦¬ì~!!\n\n* ê¸ˆì•¡: 175,000ì› (1ì¸ë‹¹ 21,875ì›)`,
                  },
                  { name: "ì¥ë³´ê¸°", assignedTo: ["user-yujin"], content: "" },
                  { name: "ì´ë¬´", assignedTo: ["user-siwon"], content: "" },
                  {
                    name: "ë§›ì§‘ ì°¾ê¸°",
                    assignedTo: ["user-boryeong"],
                    content: "",
                  },
                ],
              },
            ],
            birthdays: [
              {
                userId: "user-soorin",
                date: "11-05",
                assignedTo: null,
                preparation: "",
              },
              {
                userId: "user-siwon",
                date: "02-26",
                assignedTo: null,
                preparation: "",
              },
              {
                userId: "user-yujin",
                date: "10-30",
                assignedTo: null,
                preparation: "",
              },
              {
                userId: "user-boryeong",
                date: "03-17",
                assignedTo: null,
                preparation: "",
              },
              {
                userId: "user-hangseong-i",
                date: "08-20",
                assignedTo: null,
                preparation: "",
              }, // Added í–‰ì„±ì´'s birthday
            ],
            expenses: [
              {
                id: "expense-1",
                name: "ì •ê¸° íšŒë¹„",
                amount: 20000,
                deadline: "2025-07-31",
                penalty: "ë‹¤ìŒ ì•½ì† ì»¤í”¼ ì‚¬ê¸°",
                payers: [
                  { userId: "user-soorin", paid: true },
                  { userId: "user-boryeong", paid: true },
                  { userId: "user-hangseong-i", paid: false }, // Current user initial status
                ],
              },
            ],
            birthdayAssignmentHistory: [], // To track who has been assigned for birthdays
          },
          {
            id: "group-woowacourse-lisa",
            name: "ìš°í…Œì½” ë ˆë²¨1 ë¦¬ì‚¬ì¡°",
            password: "lisa_password", // Added password
            members: [
              "user-hangseong-i",
              "user-may",
              "user-minggom",
              "user-pora",
              "user-meonggu",
              "user-lisa",
              "user-dompu",
              "user-jensen",
              "user-popo",
              "user-jjanggu",
              "user-gaion",
              "user-flint",
            ],
            categories: [
              // Default categories
              { id: "dashboard", name: "ëŒ€ì‹œë³´ë“œ", type: "system" },
              { id: "meetings", name: "ì•½ì†", type: "default" },
              { id: "travels", name: "ì—¬í–‰", type: "default" },
              { id: "birthdays", name: "ìƒì¼", type: "default" },
              { id: "expenses", name: "íšŒë¹„", type: "default" },
              { id: "members", name: "ë©¤ë²„", type: "system" }, // Added members category
            ],
            meetings: [
              {
                id: "meeting-level3-dinner",
                name: "ë ˆë²¨3 íšŒì‹",
                date: "2025-07-15",
                time: "18:00",
                place: "ì ì‹¤ì—­",
                memo: "ë ˆë²¨3 ìš°ë¦¬ ìº í¼ìŠ¤ëŠ” í•¨ê»˜í•˜ì§€ ëª»í•´ë„ íšŒì‹ì€ í•¨ê»˜í•´ìš”.",
                creator: "ë”í‘¸",
                participants: [
                  { userId: "user-may", status: "ê°€ëŠ¥", reason: "" },
                  { userId: "user-minggom", status: "ê°€ëŠ¥", reason: "" },
                  { userId: "user-pora", status: "ê°€ëŠ¥", reason: "" },
                  { userId: "user-meonggu", status: "ê°€ëŠ¥", reason: "" },
                  {
                    userId: "user-lisa",
                    status: "ë¶ˆì°¸",
                    reason: "ëŒ€í•™ì› issue..",
                  },
                  { userId: "user-hangseong-i", status: "ë¯¸ì •", reason: "" }, // Current user
                  { userId: "user-dompu", status: "ê°€ëŠ¥", reason: "" }, // Creator
                  { userId: "user-jensen", status: "ë¯¸ì •", reason: "" },
                  { userId: "user-popo", status: "ë¯¸ì •", reason: "" },
                  { userId: "user-jjanggu", status: "ë¯¸ì •", reason: "" },
                  { userId: "user-gaion", status: "ë¯¸ì •", reason: "" },
                  { userId: "user-flint", status: "ë¯¸ì •", reason: "" },
                ],
              },
            ],
            travels: [
              {
                id: "travel-woowacourse-graduation",
                name: "ìš°í…Œì½” ì¡¸ì—… ì—¬í–‰",
                startDate: "2025-11-20",
                endDate: "2025-11-21",
                memo: "ìš°í…Œì½” ì¡¸ì—… ì¶•í•˜ ê¸°ë… ë¶€ì‚° ì—¬í–‰",
                notice: "ì—¬í–‰ ì¥ì†Œê°€ êµ­ë‚´ ë‹¤ë¥¸ ì§€ì—­ìœ¼ë¡œ ë°”ë€” ìˆ˜ ìˆìŠµë‹ˆë‹¤~", // Added notice
                roles: [
                  { name: "ìˆ™ì†Œ", assignedTo: ["user-minggom"], content: "" },
                  {
                    name: "ê´€ê´‘",
                    assignedTo: ["user-may"],
                    content:
                      "ë¡¯ë° ìì´ì–¸ì¸  vs í‚¤ì›€ íˆì–´ë¡œì¦ˆ ì•¼êµ¬ë¥¼ ë³´ëŸ¬ ê°‘ë‹ˆë‹¤",
                  },
                  { name: "ì¥ë³´ê¸°", assignedTo: ["user-jensen"], content: "" },
                  { name: "ì´ë¬´", assignedTo: ["user-jjanggu"], content: "" },
                  {
                    name: "ë§›ì§‘ ì°¾ê¸°",
                    assignedTo: ["user-meonggu", "user-pora"],
                    content: "",
                  }, // Multiple assignees
                ],
              },
            ],
            birthdays: [
              {
                userId: "user-pora",
                date: "07-25",
                assignedTo: "user-minggom",
                preparation:
                  "í¬ë¼ ìƒì¼ ğŸ¤™ğŸ½ ì½œê³ (ì½œë¯¸ê³ ìˆ˜) ì´ˆê³ (ì´ˆë”©ê³ ìˆ˜) ìƒì¼ ì¶•í•˜í•´ìš”",
              },
            ],
            expenses: [
              {
                id: "expense-dinner-settlement",
                name: "íšŒì‹ ì •ì‚°",
                amount: 20000,
                deadline: "2025-07-20",
                penalty: "ë¦´ìŠ¤ ì°ì–´ì„œ í¬ë£¨ìœ„í‚¤ì— ì˜¬ë¦¬ê¸°",
                payers: [
                  { userId: "user-hangseong-i", paid: true },
                  { userId: "user-may", paid: true },
                  { userId: "user-minggom", paid: true },
                  { userId: "user-pora", paid: true },
                  { userId: "user-meonggu", paid: true },
                  { userId: "user-lisa", paid: true },
                  { userId: "user-dompu", paid: true },
                  { userId: "user-jensen", paid: true },
                  { userId: "user-popo", paid: true },
                  { userId: "user-jjanggu", paid: true },
                  { userId: "user-gaion", paid: true },
                  { userId: "user-flint", paid: false }, // í”Œë¦°íŠ¸ ë¹¼ê³  ëª¨ë‘ ì œì¶œ
                ],
              },
            ],
            birthdayAssignmentHistory: [],
          },
        ],
      };

      // Global state variables
      let currentGroup = null;
      let currentTab = "dashboard"; // Default tab changed to dashboard
      let selectedMeetingId = null; // For meeting participation modal
      let selectedTravelId = null; // For travel form modal (for edit mode)
      let selectedTravelRoleName = null; // For travel role edit modal
      let selectedBirthdayUserId = null; // For birthday prepare modal
      let selectedExpenseId = null; // For expense submission

      // Global object to store last nag times for cooldown
      const lastNagTimes = {};
      const COOLDOWN_DURATION = 5 * 60 * 1000; // 5 minutes in milliseconds

      // Utility function to get user name by ID
      function getUserNameById(userId) {
        const user = mockData.users.find((u) => u.id === userId);
        return user ? user.name : "ì•Œ ìˆ˜ ì—†ìŒ";
      }

      // Utility function to get user ID by name
      function getUserIdByName(userName) {
        const user = mockData.users.find((u) => u.name === userName);
        return user ? user.id : null;
      }

      // Utility function to generate unique IDs
      function generateUniqueId(prefix) {
        return (
          prefix +
          "-" +
          Date.now() +
          "-" +
          Math.random().toString(36).substr(2, 9)
        );
      }

      // --- Modal Functions ---
      function openModal(modalId, callback = null) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.classList.add("show");
          if (callback) callback();
        }
      }

      function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.classList.remove("show");
        }
      }

      function showMessageBox(title, message) {
        document.getElementById("messageBoxTitle").textContent = title;
        document.getElementById("messageBoxContent").textContent = message;
        openModal("messageBoxModal");
      }

      // --- View Rendering Functions ---

      // Renders the initial group list page
      function renderGroupList() {
        const appDiv = document.getElementById("app");
        appDiv.innerHTML = `
                <header>
                    <h1>ëª¨ì„ ì„œë¹„ìŠ¤</h1>
                    <span class="text-xl">í™˜ì˜í•©ë‹ˆë‹¤, ${mockData.currentUser.name}ë‹˜!</span>
                </header>
                <div id="content" class="content fade-in">
                    <h2 class="section-title mb-6">ë‚´ ëª¨ì„</h2>
                    <div id="groupList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Group cards will be rendered here -->
                    </div>
                    <button class="btn btn-blue mt-6 w-full" onclick="openModal('groupCreateModal')">ìƒˆ ëª¨ì„ ìƒì„±</button>
                </div>
            `;

        const groupListDiv = document.getElementById("groupList");
        // Filter groups to only show those the current user is a member of
        const userGroups = mockData.groups.filter((group) =>
          group.members.includes(mockData.currentUser.id)
        );

        if (userGroups.length === 0) {
          groupListDiv.innerHTML =
            '<p class="text-gray-600">ì°¸ì—¬ ì¤‘ì¸ ëª¨ì„ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ëª¨ì„ì„ ìƒì„±í•˜ê±°ë‚˜ ì´ˆëŒ€ë°›ìœ¼ì„¸ìš”!</p>';
        } else {
          userGroups.forEach((group) => {
            const memberNames = group.members.map((id) => getUserNameById(id));
            const membersDisplay =
              memberNames.length > 5
                ? `${memberNames.slice(0, 5).join(", ")} ì™¸ ${
                    memberNames.length - 5
                  }ëª…`
                : memberNames.join(", ") || "ì—†ìŒ";

            const groupCard = document.createElement("div");
            groupCard.className = "card cursor-pointer";
            groupCard.innerHTML = `
                        <div class="card-title">${group.name}</div>
                        <div class="card-subtitle">ë©¤ë²„ ìˆ˜: ${group.members.length}ëª…</div>
                        <p class="card-text"><strong>ë©¤ë²„:</strong> ${membersDisplay}</p>
                        <p class="card-text">ì¹œêµ¬ë“¤ê³¼ì˜ ì•½ì†, ì—¬í–‰, ìƒì¼, íšŒë¹„ë¥¼ í•œ ê³³ì—ì„œ ê´€ë¦¬í•˜ì„¸ìš”!</p>
                    `;
            groupCard.onclick = () => selectGroup(group.id);
            groupListDiv.appendChild(groupCard);
          });
        }

        // Trigger fade-in for the initial content
        const contentDiv = document.getElementById("content");
        setTimeout(() => {
          contentDiv.classList.remove("fade-in");
        }, 10); // Small delay to ensure transition applies
      }

      // Selects a group and renders its detail page
      function selectGroup(groupId) {
        currentGroup = mockData.groups.find((g) => g.id === groupId);
        if (currentGroup) {
          // Set default tab to dashboard when entering a group
          currentTab = "dashboard";
          renderGroupDetail();
        } else {
          showMessageBox("ì˜¤ë¥˜", "ëª¨ì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
      }

      // Renders the group detail page with tabs
      function renderGroupDetail() {
        const appDiv = document.getElementById("app");
        let navButtonsHtml = "";
        currentGroup.categories.forEach((category) => {
          navButtonsHtml += `<button id="nav-${category.id}" onclick="changeTab('${category.id}')">`;
          switch (category.id) {
            case "dashboard":
              navButtonsHtml += "ğŸ“Š ëŒ€ì‹œë³´ë“œ";
              break;
            case "meetings":
              navButtonsHtml += "ğŸ—“ï¸ ì•½ì†";
              break;
            case "travels":
              navButtonsHtml += "âœˆï¸ ì—¬í–‰";
              break;
            case "birthdays":
              navButtonsHtml += "ğŸ ìƒì¼";
              break;
            case "expenses":
              navButtonsHtml += "ğŸ’° íšŒë¹„";
              break;
            case "members":
              navButtonsHtml += "ğŸ‘¥ ë©¤ë²„";
              break; // Added members tab
            default:
              navButtonsHtml += category.name; // For custom categories
          }
          navButtonsHtml += `</button>`;
        });

        appDiv.innerHTML = `
                <header>
                    <div class="header-title-container">
                        <button class="back-button" onclick="renderGroupList()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home">
                                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                <polyline points="9 22 9 12 15 12 15 22"/>
                            </svg>
                            í™ˆ
                        </button>
                        <h1>${currentGroup.name} ëª¨ì„</h1>
                    </div>
                    <div class="header-right-section">
                        <button class="btn btn-outline text-sm py-1 px-3 whitespace-nowrap" onclick="copyInviteLink()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07L10 6.58"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07L14 17.42"/></svg>
                            ì´ˆëŒ€ ë§í¬ ë³µì‚¬
                        </button>
                        <button class="btn btn-red text-sm py-1 px-3 whitespace-nowrap" onclick="openLeaveGroupModal('${currentGroup.id}')">ëª¨ì„ ë‚˜ê°€ê¸°</button>
                        <span class="welcome-message">í™˜ì˜í•©ë‹ˆë‹¤, ${mockData.currentUser.name}ë‹˜!</span>
                    </div>
                </header>
                <nav id="mainNav">
                    ${navButtonsHtml}
                </nav>
                <div id="content" class="content fade-in">
                    <!-- Tab content will be rendered here -->
                </div>
            `;
        changeTab(currentTab); // Render the initial tab content

        // Trigger fade-in for the group detail content
        const contentDiv = document.getElementById("content");
        setTimeout(() => {
          contentDiv.classList.remove("fade-in");
        }, 10); // Small delay to ensure transition applies
      }

      // Changes the active tab and renders its content with fade animation
      function changeTab(tabName) {
        currentTab = tabName;
        const navButtons = document.querySelectorAll("#mainNav button");
        navButtons.forEach((button) => {
          button.classList.remove("active");
        });
        const activeNavButton = document.getElementById(`nav-${tabName}`);
        if (activeNavButton) {
          activeNavButton.classList.add("active");
        }

        const contentDiv = document.getElementById("content");

        // Add fade-out effect
        contentDiv.classList.add("fade-out");

        // Use a small timeout to ensure fade-out transition starts before content replacement
        setTimeout(() => {
          // Clear previous content
          contentDiv.innerHTML = "";

          // Render new content based on the selected tab
          switch (tabName) {
            case "dashboard":
              renderDashboard();
              break;
            case "meetings":
              renderMeetings();
              break;
            case "travels":
              renderTravels();
              break;
            case "birthdays":
              renderBirthdays();
              break;
            case "expenses":
              renderExpenses();
              break;
            case "members": // New case for members tab
              renderMembers();
              break;
            default: // For custom categories
              renderCustomCategoryContent(tabName);
              break;
          }

          // Ensure new content starts invisible for fade-in
          contentDiv.classList.add("fade-in");

          // Force reflow for the newly rendered content
          void contentDiv.offsetWidth;

          // Remove fade-out and trigger fade-in
          contentDiv.classList.remove("fade-out");
          contentDiv.classList.remove("fade-in"); // This will trigger the transition to opacity: 1
        }, 300); // Match this timeout with the CSS transition duration (0.3s)
      }

      // --- Dashboard Tab Function ---
      function renderDashboard() {
        const contentDiv = document.getElementById("content");
        let dashboardHtml = `
                <h2 class="section-title">ğŸ“Š ëŒ€ì‹œë³´ë“œ</h2>
            `;

        // Normalize today's date to midnight for consistent comparisons
        const todayNormalized = new Date();
        todayNormalized.setHours(0, 0, 0, 0);

        // 5. My Pending Tasks (New Section - moved to top)
        let myPendingTasksHtml = "";
        const myUnrespondedMeetings = currentGroup.meetings.filter((m) => {
          const participant = m.participants.find(
            (p) => p.userId === mockData.currentUser.id
          );
          return participant && participant.status === "ë¯¸ì •";
        });

        const myUnfinishedTravelRoles = currentGroup.travels.flatMap((t) =>
          t.roles
            .filter(
              (r) =>
                r.assignedTo.includes(mockData.currentUser.id) &&
                r.content === ""
            )
            .map((r) => ({
              travelName: t.name,
              roleName: r.name,
              travelId: t.id,
            }))
        );

        const myUnpaidExpenses = currentGroup.expenses.filter((e) => {
          const payer = e.payers.find(
            (p) => p.userId === mockData.currentUser.id
          );
          return payer && !payer.paid;
        });

        if (
          myUnrespondedMeetings.length > 0 ||
          myUnfinishedTravelRoles.length > 0 ||
          myUnpaidExpenses.length > 0
        ) {
          myPendingTasksHtml += `
                    <div class="card md:col-span-2 mb-6"> <!-- Span full width on medium screens, added mb-6 for spacing -->
                        <div class="card-title">ğŸš¨ ë‚´ê°€ í•´ì•¼ í•  ì¼</div>
                        <ul class="list-disc pl-5 text-gray-700">
                `;
          myUnrespondedMeetings.forEach((m) => {
            myPendingTasksHtml += `<li>ì•½ì†: <strong>${m.name}</strong> ì°¸ì—¬ ì—¬ë¶€ ê²°ì • <button class="btn btn-outline text-xs py-1 px-2 ml-2" onclick="openMeetingParticipateModal('${m.id}')">ë°”ë¡œê°€ê¸°</button></li>`;
          });
          myUnfinishedTravelRoles.forEach((r) => {
            myPendingTasksHtml += `<li>ì—¬í–‰: <strong>${r.travelName}</strong>ì˜ <strong>${r.roleName}</strong> ì—…ë¬´ ì—…ë°ì´íŠ¸ <button class="btn btn-outline text-xs py-1 px-2 ml-2" onclick="openTravelRoleEditModal('${r.travelId}', '${r.roleName}')">ë°”ë¡œê°€ê¸°</button></li>`;
          });
          myUnpaidExpenses.forEach((e) => {
            myPendingTasksHtml += `<li>íšŒë¹„: <strong>${
              e.name
            }</strong> ${e.amount.toLocaleString()}ì› ë‚©ë¶€ <button class="btn btn-outline text-xs py-1 px-2 ml-2" onclick="viewExpenseDetails('${
              e.id
            }')">ë°”ë¡œê°€ê¸°</button></li>`;
          });
          myPendingTasksHtml += `
                        </ul>
                    </div>
                `;
        } else {
          myPendingTasksHtml += `
                    <div class="card md:col-span-2 mb-6"> <!-- Added mb-6 for spacing -->
                        <div class="card-title">âœ¨ ë‚´ê°€ í•´ì•¼ í•  ì¼</div>
                        <p class="card-text">í˜„ì¬ í•´ì•¼ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  ê²ƒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</p>
                    </div>
                `;
        }
        dashboardHtml += myPendingTasksHtml; // Insert pending tasks at the top

        dashboardHtml += `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">`; // Start new grid for other cards

        // 1. Upcoming Meetings Summary
        const upcomingMeetings = currentGroup.meetings
          .filter((m) => {
            const meetingDate = new Date(m.date);
            meetingDate.setHours(0, 0, 0, 0); // Normalize meeting date to midnight
            return meetingDate >= todayNormalized;
          })
          .sort((a, b) => new Date(a.date) - new Date(b.date))
          .slice(0, 3); // Show up to 3 upcoming meetings

        dashboardHtml += `
                <div class="card">
                    <div class="card-title">ğŸ—“ï¸ ë‹¤ê°€ì˜¤ëŠ” ì•½ì†</div>
                    ${
                      upcomingMeetings.length > 0
                        ? `
                        <ul class="list-disc pl-5 text-gray-700">
                            ${upcomingMeetings
                              .map(
                                (m) => `
                                <li><strong>${m.name}</strong>: ${m.date} ${m.time} (${m.place})</li>
                            `
                              )
                              .join("")}
                        </ul>
                    `
                        : `<p class="card-text">ë‹¤ê°€ì˜¤ëŠ” ì•½ì†ì´ ì—†ìŠµë‹ˆë‹¤.</p>`
                    }
                    <button class="btn btn-outline mt-4" onclick="changeTab('meetings')">ì•½ì† ì „ì²´ ë³´ê¸°</button>
                </div>
            `;

        // 2. Planned Travels Summary (Includes current and upcoming)
        const plannedTravels = currentGroup.travels
          .filter((t) => {
            const endDate = new Date(t.endDate);
            endDate.setHours(0, 0, 0, 0); // Normalize end date to midnight
            return endDate >= todayNormalized; // Travel is relevant if its end date is today or in the future
          })
          .sort((a, b) => {
            // Sort by start date, so the nearest upcoming or current travel appears first
            const startDateA = new Date(a.startDate);
            const startDateB = new Date(b.startDate);
            return startDateA - startDateB;
          })
          .slice(0, 1); // Show only the next relevant travel for brevity on dashboard

        dashboardHtml += `
                <div class="card">
                    <div class="card-title">âœˆï¸ ê³„íšëœ ì—¬í–‰</div>
                    ${
                      plannedTravels.length > 0
                        ? `
                        ${plannedTravels
                          .map(
                            (t) => `
                            <p class="card-subtitle">${t.name} (${
                              t.startDate
                            } ~ ${t.endDate})</p>
                            <p class="card-text">ì—­í• : ${t.roles
                              .map(
                                (r) =>
                                  `${r.name} (${r.assignedTo
                                    .map((id) => getUserNameById(id))
                                    .join(", ")})`
                              )
                              .join(", ")}</p>
                        `
                          )
                          .join('<hr class="my-4"/>')}
                    `
                        : `<p class="card-text">ê³„íšëœ ì—¬í–‰ì´ ì—†ìŠµë‹ˆë‹¤.</p>`
                    }
                    <button class="btn btn-outline mt-4" onclick="changeTab('travels')">ì—¬í–‰ ì „ì²´ ë³´ê¸°</button>
                </div>
            `;

        // 3. Upcoming Birthdays Summary
        const upcomingBirthdays = currentGroup.birthdays
          .filter((b) => {
            const bDateThisYear = new Date(
              `${todayNormalized.getFullYear()}-${b.date}`
            );
            // If birthday has passed this year, consider it for next year
            if (bDateThisYear < todayNormalized) {
              bDateThisYear.setFullYear(todayNormalized.getFullYear() + 1);
            }
            return bDateThisYear >= todayNormalized; // Only show birthdays that are today or in the future
          })
          .sort((a, b) => {
            const dateA = new Date(
              `${todayNormalized.getFullYear()}-${a.date}`
            );
            const dateB = new Date(
              `${todayNormalized.getFullYear()}-${b.date}`
            );
            if (dateA < todayNormalized)
              dateA.setFullYear(todayNormalized.getFullYear() + 1);
            if (dateB < todayNormalized)
              dateB.setFullYear(todayNormalized.getFullYear() + 1);
            return dateA - dateB;
          })
          .slice(0, 3); // Show up to 3 nearest birthdays

        dashboardHtml += `
                <div class="card">
                    <div class="card-title">ğŸ ë‹¤ê°€ì˜¤ëŠ” ìƒì¼</div>
                    ${
                      upcomingBirthdays.length > 0
                        ? `
                        <ul class="list-disc pl-5 text-gray-700">
                            ${upcomingBirthdays
                              .map(
                                (b) => `
                                <li><strong>${getUserNameById(
                                  b.userId
                                )}</strong>: ${b.date} (${
                                  b.assignedTo
                                    ? getUserNameById(b.assignedTo) + " ë‹´ë‹¹"
                                    : "ë‹´ë‹¹ì ë¯¸ì§€ì •"
                                })</li>
                            `
                              )
                              .join("")}
                        </ul>
                    `
                        : `<p class="card-text">ë‹¤ê°€ì˜¤ëŠ” ìƒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>`
                    }
                    <button class="btn btn-outline mt-4" onclick="changeTab('birthdays')">ìƒì¼ ì „ì²´ ë³´ê¸°</button>
                </div>
            `;

        // 4. Pending Expenses Summary
        const pendingExpenses = currentGroup.expenses.filter((e) => {
          const currentUserPayer = e.payers.find(
            (p) => p.userId === mockData.currentUser.id
          );
          return currentUserPayer && !currentUserPayer.paid;
        });

        dashboardHtml += `
                <div class="card">
                    <div class="card-title">ğŸ’° ë¯¸ë‚© íšŒë¹„</div>
                    ${
                      pendingExpenses.length > 0
                        ? `
                        <ul class="list-disc pl-5 text-gray-700">
                            ${pendingExpenses
                              .map(
                                (e) => `
                                <li><strong>${
                                  e.name
                                }</strong>: ${e.amount.toLocaleString()}ì› (ë§ˆê°ì¼: ${
                                  e.deadline
                                })</li>
                            `
                              )
                              .join("")}
                        </ul>
                    `
                        : `<p class="card-text">ë¯¸ë‚©ëœ íšŒë¹„ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`
                    }
                    <button class="btn btn-outline mt-4" onclick="changeTab('expenses')">íšŒë¹„ ì „ì²´ ë³´ê¸°</button>
                </div>
            `;

        dashboardHtml += `</div>`; // Close grid
        contentDiv.innerHTML = dashboardHtml;
      }

      // --- Members Tab Function ---
      function renderMembers() {
        const contentDiv = document.getElementById("content");
        let membersHtml = `
                <h2 class="section-title">ğŸ‘¥ ë©¤ë²„ ëª©ë¡</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-6">
            `;

        currentGroup.members.forEach((memberId) => {
          const userName = getUserNameById(memberId);
          const userBirthday =
            mockData.users.find((u) => u.id === memberId)?.birthday ||
            "ì •ë³´ ì—†ìŒ";
          membersHtml += `
                    <div class="card p-4 text-center">
                        <p class="font-semibold text-lg text-blue-700">${userName}</p>
                        <p class="text-gray-600 text-sm">ìƒì¼: ${userBirthday}</p>
                    </div>
                `;
        });

        membersHtml += `</div>`; // Close grid
        contentDiv.innerHTML = membersHtml;
      }

      // --- Meetings Tab Functions ---
      function renderMeetings() {
        const contentDiv = document.getElementById("content");
        contentDiv.innerHTML = `
                <div class="section-header">
                    <h2 class="section-title">ğŸ—“ï¸ ì•½ì† ëª©ë¡</h2>
                    <button class="btn btn-blue" onclick="openModal('meetingCreateModal')">ì•½ì† ìƒì„±</button>
                </div>
                <div id="meetingsList">
                    <!-- Meetings will be listed here -->
                </div>
            `;

        const meetingsListDiv = document.getElementById("meetingsList");
        if (currentGroup.meetings.length === 0) {
          meetingsListDiv.innerHTML =
            '<p class="text-gray-600">ì•„ì§ ë“±ë¡ëœ ì•½ì†ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        currentGroup.meetings.forEach((meeting) => {
          const userParticipation = meeting.participants.find(
            (p) => p.userId === mockData.currentUser.id
          );
          const statusText = userParticipation
            ? userParticipation.status
            : "ë¯¸ì •";
          const statusClass = {
            ê°€ëŠ¥: "possible",
            ë¶ˆì°¸: "impossible",
            ë¯¸ì •: "pending",
          }[statusText];

          const meetingCard = document.createElement("div");
          meetingCard.className = "card";
          let participantsHtml = "";
          currentGroup.members.forEach((memberId) => {
            const participant = meeting.participants.find(
              (p) => p.userId === memberId
            );
            const pStatus = participant ? participant.status : "ë¯¸ì •";
            const pReason =
              participant && pStatus === "ë¶ˆì°¸"
                ? ` (ì‚¬ìœ : ${participant.reason})`
                : ""; // Only show reason for 'ë¶ˆì°¸'
            const pStatusClass = {
              ê°€ëŠ¥: "possible",
              ë¶ˆì°¸: "impossible",
              ë¯¸ì •: "pending",
            }[pStatus];
            const nagKey = `nag-meeting-${meeting.id}-${memberId}`;
            const canNag =
              !lastNagTimes[nagKey] ||
              Date.now() - lastNagTimes[nagKey] > COOLDOWN_DURATION;
            const nagButtonHtml =
              pStatus === "ë¯¸ì •" && canNag
                ? `<button class="btn btn-outline text-xs py-1 px-2 ml-2" onclick="nagParticipant('${meeting.id}', '${memberId}')">ğŸ›ï¸ ì¬ì´‰</button>`
                : pStatus === "ë¯¸ì •" && !canNag
                ? `<button class="btn btn-outline text-xs py-1 px-2 ml-2 opacity-50 cursor-not-allowed" disabled>ğŸ›ï¸ ì¬ì´‰ (ì¿¨ë‹¤ìš´)</button>`
                : "";

            participantsHtml += `<li><strong>${getUserNameById(
              memberId
            )}</strong>: <span class="status-badge ${pStatusClass}">${pStatus}</span>${pReason}${nagButtonHtml}</li>`;
          });

          meetingCard.innerHTML = `
                    <div class="card-title">${meeting.name}</div>
                    <div class="card-subtitle">${meeting.date} ${
            meeting.time
          } | ${meeting.place}</div>
                    <p class="card-text">
                        ì°¸ì—¬ í˜„í™©: ${
                          meeting.participants
                            .filter((p) => p.status === "ê°€ëŠ¥")
                            .map((p) => getUserNameById(p.userId))
                            .join(", ") || "ì—†ìŒ"
                        }
                        <span class="status-badge ${statusClass}">ë‚´ ìƒíƒœ: ${statusText}</span>
                    </p>
                    <div class="flex gap-2 mt-4">
                        <button class="btn btn-outline" onclick="viewMeetingDetails('${
                          meeting.id
                        }')">ìƒì„¸ ë³´ê¸°</button>
                        <button class="btn btn-green" onclick="openMeetingParticipateModal('${
                          meeting.id
                        }')">ì°¸ì—¬/ë¶ˆì°¸</button>
                    </div>
                `;
          meetingsListDiv.appendChild(meetingCard);
        });
      }

      function viewMeetingDetails(meetingId) {
        const meeting = currentGroup.meetings.find((m) => m.id === meetingId);
        if (!meeting) {
          showMessageBox("ì˜¤ë¥˜", "ì•½ì†ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        let participantsHtml = "<ul>";
        currentGroup.members.forEach((memberId) => {
          const participant = meeting.participants.find(
            (p) => p.userId === memberId
          );
          const status = participant ? participant.status : "ë¯¸ì •";
          const reason =
            participant && status === "ë¶ˆì°¸"
              ? ` (ì‚¬ìœ : ${participant.reason})`
              : ""; // Only show reason for 'ë¶ˆì°¸'
          const statusClass = {
            ê°€ëŠ¥: "possible",
            ë¶ˆì°¸: "impossible",
            ë¯¸ì •: "pending",
          }[status];
          const nagKey = `nag-meeting-${meetingId}-${memberId}`;
          const canNag =
            !lastNagTimes[nagKey] ||
            Date.now() - lastNagTimes[nagKey] > COOLDOWN_DURATION;
          const nagButtonHtml =
            status === "ë¯¸ì •" && canNag
              ? `<button class="btn btn-outline text-xs py-1 px-2 ml-2" onclick="nagParticipant('${meetingId}', '${memberId}')">ğŸ›ï¸ ì¬ì´‰</button>`
              : status === "ë¯¸ì •" && !canNag
              ? `<button class="btn btn-outline text-xs py-1 px-2 ml-2 opacity-50 cursor-not-allowed" disabled>ğŸ›ï¸ ì¬ì´‰ (ì¿¨ë‹¤ìš´)</button>`
              : "";

          participantsHtml += `<li><strong>${getUserNameById(
            memberId
          )}</strong>: <span class="status-badge ${statusClass}">${status}</span>${reason}${nagButtonHtml}</li>`;
        });
        participantsHtml += "</ul>";

        const contentDiv = document.getElementById("content");
        contentDiv.innerHTML = `
                <div class="section-header">
                    <h2 class="section-title">ğŸ—“ï¸ ${meeting.name} ìƒì„¸</h2>
                    <button class="btn btn-outline" onclick="changeTab('meetings')">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                </div>
                <div class="detail-item">
                    <h3>ì•½ì† ì •ë³´</h3>
                    <p><strong>ë‚ ì§œ:</strong> ${meeting.date}</p>
                    <p><strong>ì‹œê°„:</strong> ${meeting.time}</p>
                    <p><strong>ì¥ì†Œ:</strong> ${meeting.place}</p>
                    <p><strong>ìƒì„±ì:</strong> ${meeting.creator}</p>
                    <p><strong>ë©”ëª¨:</strong> ${meeting.memo || "ì—†ìŒ"}</p>
                </div>
                <div class="detail-item">
                    <h3>ì°¸ì—¬ í˜„í™©</h3>
                    ${participantsHtml}
                </div>
                <div class="flex gap-2 mt-4">
                    <button class="btn btn-green" onclick="openMeetingParticipateModal('${
                      meeting.id
                    }')">ë‚´ ì°¸ì—¬ ìƒíƒœ ë³€ê²½</button>
                </div>
            `;
      }

      function createMeeting() {
        const name = document.getElementById("meetingName").value;
        const date = document.getElementById("meetingDate").value;
        const time = document.getElementById("meetingTime").value;
        const place = document.getElementById("meetingPlace").value;
        const memo = document.getElementById("meetingMemo").value;

        if (!name || !date || !time || !place) {
          showMessageBox(
            "í•„ìˆ˜ ì •ë³´ ëˆ„ë½",
            "ì•½ì† ì´ë¦„, ë‚ ì§œ, ì‹œê°„, ì¥ì†ŒëŠ” í•„ìˆ˜ ì…ë ¥ ì‚¬í•­ì…ë‹ˆë‹¤."
          );
          return;
        }

        const newMeeting = {
          id: generateUniqueId("meeting"),
          name,
          date,
          time,
          place,
          memo,
          creator: mockData.currentUser.name,
          participants: currentGroup.members.map((userId) => ({
            userId: userId,
            status: userId === mockData.currentUser.id ? "ê°€ëŠ¥" : "ë¯¸ì •", // Default current user to 'ê°€ëŠ¥'
            reason: "",
          })),
        };

        currentGroup.meetings.push(newMeeting);
        closeModal("meetingCreateModal");
        showMessageBox("ì„±ê³µ", "ìƒˆ ì•½ì†ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
        renderMeetings();
      }

      function openMeetingParticipateModal(meetingId) {
        selectedMeetingId = meetingId;
        const meeting = currentGroup.meetings.find((m) => m.id === meetingId);
        if (!meeting) {
          showMessageBox("ì˜¤ë¥˜", "ì•½ì†ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // Ensure all elements exist before trying to access them
        const participateModalTitle = document.getElementById(
          "participateModalTitle"
        );
        const participateMeetingName = document.getElementById(
          "participateMeetingName"
        );
        const declineReasonLabel =
          document.getElementById("declineReasonLabel");
        const declineReasonTextarea = document.getElementById("declineReason");
        const declineButton = document.getElementById("declineButton");
        const participateButton = document.getElementById("participateButton");
        const confirmDeclineButton = document.getElementById(
          "confirmDeclineButton"
        );
        const cancelDeclineButton = document.getElementById(
          "cancelDeclineButton"
        );

        if (
          !participateModalTitle ||
          !participateMeetingName ||
          !declineReasonLabel ||
          !declineReasonTextarea ||
          !declineButton ||
          !participateButton ||
          !confirmDeclineButton ||
          !cancelDeclineButton
        ) {
          showMessageBox(
            "ì˜¤ë¥˜",
            "ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”."
          );
          return;
        }

        participateModalTitle.textContent = `"${meeting.name}" ì•½ì† ì°¸ì—¬/ë¶ˆì°¸`;
        participateMeetingName.textContent = `"${meeting.name}" ì•½ì†ì— ëŒ€í•œ ì°¸ì—¬ ì—¬ë¶€`;

        // Reset modal state
        declineReasonLabel.classList.add("hidden");
        declineReasonTextarea.classList.add("hidden");
        declineReasonTextarea.value = "";

        declineButton.classList.remove("hidden");
        participateButton.classList.remove("hidden");
        confirmDeclineButton.classList.add("hidden");
        cancelDeclineButton.classList.add("hidden");

        openModal("meetingParticipateModal");
      }

      // New function to show decline reason input
      function showDeclineReasonInput() {
        const declineReasonLabel =
          document.getElementById("declineReasonLabel");
        const declineReasonTextarea = document.getElementById("declineReason");
        const declineButton = document.getElementById("declineButton");
        const participateButton = document.getElementById("participateButton");
        const confirmDeclineButton = document.getElementById(
          "confirmDeclineButton"
        );
        const cancelDeclineButton = document.getElementById(
          "cancelDeclineButton"
        );

        declineReasonLabel.classList.remove("hidden");
        declineReasonTextarea.classList.remove("hidden");

        declineButton.classList.add("hidden");
        participateButton.classList.add("hidden");
        confirmDeclineButton.classList.remove("hidden");
        cancelDeclineButton.classList.remove("hidden");
      }

      // New function to hide decline reason input (if user cancels)
      function hideDeclineReasonInput() {
        const declineReasonLabel =
          document.getElementById("declineReasonLabel");
        const declineReasonTextarea = document.getElementById("declineReason");
        const declineButton = document.getElementById("declineButton");
        const participateButton = document.getElementById("participateButton");
        const confirmDeclineButton = document.getElementById(
          "confirmDeclineButton"
        );
        const cancelDeclineButton = document.getElementById(
          "cancelDeclineButton"
        );

        declineReasonLabel.classList.add("hidden");
        declineReasonTextarea.classList.add("hidden");
        declineReasonTextarea.value = ""; // Clear input

        declineButton.classList.remove("hidden");
        participateButton.classList.remove("hidden");
        confirmDeclineButton.classList.add("hidden");
        cancelDeclineButton.classList.add("hidden");
      }

      function handleMeetingParticipation(status) {
        if (!selectedMeetingId) return;

        const meeting = currentGroup.meetings.find(
          (m) => m.id === selectedMeetingId
        );
        if (!meeting) return;

        let currentUserParticipation = meeting.participants.find(
          (p) => p.userId === mockData.currentUser.id
        );

        if (!currentUserParticipation) {
          currentUserParticipation = {
            userId: mockData.currentUser.id,
            status: "ë¯¸ì •",
            reason: "",
          };
          meeting.participants.push(currentUserParticipation);
        }

        currentUserParticipation.status = status;
        if (status === "ë¶ˆì°¸") {
          const reason = document.getElementById("declineReason").value;
          if (!reason) {
            showMessageBox("í•„ìˆ˜ ì…ë ¥", "ë¶ˆì°¸ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
          }
          currentUserParticipation.reason = reason;
        } else {
          currentUserParticipation.reason = "";
        }

        closeModal("meetingParticipateModal");
        showMessageBox(
          "ì„±ê³µ",
          `ì•½ì† ì°¸ì—¬ ìƒíƒœê°€ "${status}"ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`
        );
        renderMeetings(); // Re-render to reflect changes
        selectedMeetingId = null; // Clear selected ID
      }

      // --- Travels Tab Functions ---
      function renderTravels() {
        const contentDiv = document.getElementById("content");
        contentDiv.innerHTML = `
                <div class="section-header">
                    <h2 class="section-title">âœˆï¸ ì—¬í–‰ ëª©ë¡</h2>
                    <button class="btn btn-blue" onclick="openTravelFormModal()">ì—¬í–‰ ì¼ì • ìƒì„±</button>
                </div>
                <div id="travelsList">
                    <!-- Travels will be listed here -->
                </div>
            `;

        const travelsListDiv = document.getElementById("travelsList");
        if (currentGroup.travels.length === 0) {
          travelsListDiv.innerHTML =
            '<p class="text-gray-600">ì•„ì§ ë“±ë¡ëœ ì—¬í–‰ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        currentGroup.travels.forEach((travel) => {
          // Display multiple assignees for roles
          let rolesSummary = travel.roles
            .map((role) => {
              const assignedNames = role.assignedTo
                .map((id) => getUserNameById(id))
                .join(", ");
              return `${role.name} - ${assignedNames || "ë¯¸ì§€ì •"}`;
            })
            .join(" / ");

          if (rolesSummary.length > 100) {
            // Truncate for display
            rolesSummary = rolesSummary.substring(0, 97) + "...";
          }

          const travelCard = document.createElement("div");
          travelCard.className = "card";
          travelCard.innerHTML = `
                    <div class="card-title">${travel.name}</div>
                    <div class="card-subtitle">${travel.startDate} ~ ${travel.endDate}</div>
                    <p class="card-text">ì—­í•  ë¶„ë‹´: ${rolesSummary}</p>
                    <div class="flex gap-2 mt-4">
                        <button class="btn btn-outline" onclick="viewTravelDetails('${travel.id}')">ìƒì„¸ ë³´ê¸°</button>
                    </div>
                `;
          travelsListDiv.appendChild(travelCard);
        });
      }

      function viewTravelDetails(travelId) {
        const travel = currentGroup.travels.find((t) => t.id === travelId);
        if (!travel) {
          showMessageBox("ì˜¤ë¥˜", "ì—¬í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const currentUserRole = travel.roles.find((role) =>
          role.assignedTo.includes(mockData.currentUser.id)
        ); // Check if current user is assigned to any role
        const editButtonHtml = currentUserRole
          ? `<button class="btn btn-blue" onclick="openTravelRoleEditModal('${travel.id}', '${currentUserRole.name}')">ë‚´ ì—­í•  ë‚´ìš© ìˆ˜ì •</button>`
          : "";

        const noticeHtml = travel.notice
          ? `
                <div class="travel-notice-callout">
                    <span class="pin-icon">ğŸ“Œ</span>
                    <div class="notice-content-wrapper">
                        <p class="font-semibold mb-1">ê³µì§€ì‚¬í•­</p>
                        <p class="notice-text">${travel.notice.replace(
                          /\n/g,
                          "<br>"
                        )}</p>
                    </div>
                    <div class="edit-button-container">
                        <button class="btn btn-outline text-sm py-1 px-3" onclick="openTravelNoticeEditModal('${
                          travel.id
                        }')">ìˆ˜ì •</button>
                    </div>
                </div>
            `
          : `
                <div class="travel-notice-callout">
                    <span class="pin-icon">ğŸ“Œ</span>
                    <div class="notice-content-wrapper">
                        <p class="font-semibold mb-1">ê³µì§€ì‚¬í•­</p>
                        <p class="notice-text">ì•„ì§ ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                    <div class="edit-button-container">
                        <button class="btn btn-outline text-sm py-1 px-3" onclick="openTravelNoticeEditModal('${travel.id}')">ë“±ë¡</button>
                    </div>
                </div>
            `;

        let rolesHtml = '<div class="role-grid">';
        travel.roles.forEach((role) => {
          const assignedNames =
            role.assignedTo.map((id) => getUserNameById(id)).join(", ") ||
            "ë¯¸ì§€ì •";
          const nagKey = `nag-travel-role-${travel.id}-${role.name}`;
          const canNag =
            !lastNagTimes[nagKey] ||
            Date.now() - lastNagTimes[nagKey] > COOLDOWN_DURATION;
          const nagButtonHtml =
            role.content === "" && role.assignedTo.length > 0 && canNag // Nag if content is empty AND someone is assigned
              ? `<button class="btn btn-outline text-xs py-1 px-2 ml-2" onclick="nagRole('${
                  travel.id
                }', '${role.name}', '${role.assignedTo.join(
                  ","
                )}')">ğŸ›ï¸ ì¬ì´‰</button>`
              : role.content === "" && role.assignedTo.length > 0 && !canNag
              ? `<button class="btn btn-outline text-xs py-1 px-2 ml-2 opacity-50 cursor-not-allowed" disabled>ğŸ›ï¸ ì¬ì´‰ (ì¿¨ë‹¤ìš´)</button>`
              : "";

          rolesHtml += `
                    <div class="role-item">
                        <strong>${role.name}</strong>
                        <span>${assignedNames}${nagButtonHtml}</span>
                    </div>
                `;
        });
        rolesHtml += "</div>";

        const contentDiv = document.getElementById("content");
        contentDiv.innerHTML = `
                <div class="section-header">
                    <h2 class="section-title">âœˆï¸ ${travel.name} ìƒì„¸</h2>
                    <button class="btn btn-blue" onclick="openTravelFormModal('${
                      travel.id
                    }')">ì—¬í–‰ ìˆ˜ì •</button> <!-- Changed button text -->
                    <button class="btn btn-outline" onclick="changeTab('travels')">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                </div>
                ${noticeHtml}
                <div class="detail-item">
                    <h3>ì—¬í–‰ ì •ë³´</h3>
                    <p><strong>ê¸°ê°„:</strong> ${travel.startDate} ~ ${
          travel.endDate
        }</p>
                    <p><strong>ë©”ëª¨:</strong> ${travel.memo || "ì—†ìŒ"}</p>
                </div>
                <div class="detail-item">
                    <h3>ì—­í•  ë¶„ë‹´ í˜„í™©</h3>
                    ${rolesHtml}
                </div>
                <div class="detail-item mt-4">
                    <h3>ì¤€ë¹„ í˜„í™©íŒ</h3>
                    ${travel.roles
                      .map(
                        (role) => `
                        <div class="mb-4 p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                            <h4 class="font-semibold text-lg text-blue-700">${
                              role.name
                            } (${
                          role.assignedTo
                            .map((id) => getUserNameById(id))
                            .join(", ") || "ë¯¸ì§€ì •"
                        })</h4>
                            <p class="text-gray-700 mt-2">${
                              role.content
                                ? role.content.replace(/\n/g, "<br>")
                                : "ì•„ì§ ì¤€ë¹„ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."
                            }</p>
                        </div>
                    `
                      )
                      .join("")}
                </div>
                <div class="flex gap-2 mt-4">
                    ${editButtonHtml}
                </div>
            `;
      }

      // Renamed from openTravelCreateModal to handle both create and edit
      function openTravelFormModal(travelId = null) {
        selectedTravelId = travelId; // Store travelId for edit mode

        const travelFormModalTitle = document.getElementById(
          "travelFormModalTitle"
        );
        const saveTravelFormButton = document.getElementById(
          "saveTravelFormButton"
        );
        const travelNameInput = document.getElementById("travelName");
        const travelStartDateInput = document.getElementById("travelStartDate");
        const travelEndDateInput = document.getElementById("travelEndDate");
        const travelMemoInput = document.getElementById("travelMemo");
        const roleAssignmentContainer = document.getElementById(
          "roleAssignmentContainer"
        );

        // Reset form and role inputs
        travelNameInput.value = "";
        travelStartDateInput.value = "";
        travelEndDateInput.value = "";
        travelMemoInput.value = "";
        roleAssignmentContainer.innerHTML = "";
        roleInputCounter = 0; // Reset counter for new inputs

        if (travelId) {
          // Edit mode
          const travel = currentGroup.travels.find((t) => t.id === travelId);
          if (travel) {
            travelFormModalTitle.textContent = "ì—¬í–‰ ìˆ˜ì •"; // Changed title
            saveTravelFormButton.onclick = () => saveTravelForm(true); // Set to edit mode
            travelNameInput.value = travel.name;
            travelStartDateInput.value = travel.startDate;
            travelEndDateInput.value = travel.endDate;
            travelMemoInput.value = travel.memo;
            travel.roles.forEach((role) => {
              addRoleInput(role.name, role.assignedTo); // Populate existing roles
            });
          } else {
            showMessageBox("ì˜¤ë¥˜", "ìˆ˜ì •í•  ì—¬í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }
        } else {
          // Create mode
          travelFormModalTitle.textContent = "ìƒˆ ì—¬í–‰ ì¼ì • ìƒì„±";
          saveTravelFormButton.onclick = () => saveTravelForm(false); // Set to create mode
          addRoleInput(); // Add initial empty role input for new creation
        }
        openModal("travelFormModal");
      }

      let roleInputCounter = 0;
      function addRoleInput(roleName = "", assignedToIds = []) {
        // assignedToIds is now an array
        const container = document.getElementById("roleAssignmentContainer");
        const newRoleIndex = roleInputCounter++;

        const roleDiv = document.createElement("div");
        roleDiv.className = "flex items-center gap-2 mb-2";
        // Add 'multiple' attribute to the select
        roleDiv.innerHTML = `
                <input type="text" id="roleName-${newRoleIndex}" placeholder="ì—­í•  ì´ë¦„ (ì˜ˆ: ìˆ™ì†Œ)" class="flex-1" value="${roleName}">
                <select id="roleAssignee-${newRoleIndex}" class="flex-1 p-2 border rounded-lg" multiple size="3">
                    <option value="">ë‹´ë‹¹ì ì„ íƒ (Ctrl/Cmd + í´ë¦­ìœ¼ë¡œ ë‹¤ì¤‘ ì„ íƒ)</option>
                    ${currentGroup.members
                      .map((memberId) => {
                        const userName = getUserNameById(memberId);
                        const isSelected = assignedToIds.includes(memberId)
                          ? "selected"
                          : "";
                        return `<option value="${memberId}" ${isSelected}>${userName}</option>`;
                      })
                      .join("")}
                </select>
                <button class="btn btn-red px-3 py-2 text-sm" onclick="this.parentNode.remove()">ì‚­ì œ</button>
            `;
        container.appendChild(roleDiv);
      }

      // Function to handle random assignment
      function randomlyAssignRoles() {
        const allMembers = [...currentGroup.members]; // Get all members of the current group
        const shuffledMembers = allMembers.sort(() => Math.random() - 0.5); // Shuffle members
        const roleInputs = document.querySelectorAll(
          "#roleAssignmentContainer .flex.items-center.gap-2.mb-2"
        );

        if (roleInputs.length === 0) {
          showMessageBox(
            "ì˜¤ë¥˜",
            "ì—­í• ì´ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¨¼ì € ì—­í• ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”."
          );
          return;
        }

        // Clear existing selections in all role selects
        roleInputs.forEach((roleDiv) => {
          const selectElement = roleDiv.querySelector("select");
          if (selectElement) {
            Array.from(selectElement.options).forEach((option) => {
              option.selected = false;
            });
          }
        });

        let memberIndex = 0;
        // Distribute members to roles in a round-robin fashion
        for (let i = 0; i < roleInputs.length; i++) {
          const roleDiv = roleInputs[i];
          const selectElement = roleDiv.querySelector("select");
          if (!selectElement) continue;

          // Assign at least one member if available
          if (memberIndex < shuffledMembers.length) {
            const memberToAssign = shuffledMembers[memberIndex];
            Array.from(selectElement.options).forEach((option) => {
              if (option.value === memberToAssign) {
                option.selected = true;
              }
            });
            memberIndex++;
          }
        }

        // If there are still unassigned members, distribute them to roles that have capacity
        // This is a simplified approach; a more robust one might consider role "capacity"
        while (memberIndex < shuffledMembers.length) {
          for (let i = 0; i < roleInputs.length; i++) {
            if (memberIndex >= shuffledMembers.length) break;

            const roleDiv = roleInputs[i];
            const selectElement = roleDiv.querySelector("select");
            if (!selectElement) continue;

            const memberToAssign = shuffledMembers[memberIndex];
            Array.from(selectElement.options).forEach((option) => {
              if (option.value === memberToAssign) {
                option.selected = true;
              }
            });
            memberIndex++;
          }
        }
        showMessageBox(
          "ëœë¤ ë¶„ë°° ì™„ë£Œ",
          "ëª¨ë“  ë©¤ë²„ê°€ ì—­í• ì— ëœë¤ìœ¼ë¡œ ë¶„ë°°ë˜ì—ˆìŠµë‹ˆë‹¤."
        );
      }

      // Renamed from createTravel to handle both create and update
      function saveTravelForm(isEditMode) {
        const name = document.getElementById("travelName").value;
        const startDate = document.getElementById("travelStartDate").value;
        const endDate = document.getElementById("travelEndDate").value;
        const memo = document.getElementById("travelMemo").value;

        // Fixed validation logic for endDate
        if (!name || !startDate || !endDate) {
          showMessageBox(
            "í•„ìˆ˜ ì •ë³´ ëˆ„ë½",
            "ì—¬í–‰ ì œëª©, ì‹œì‘ ë‚ ì§œ, ì¢…ë£Œ ë‚ ì§œëŠ” í•„ìˆ˜ ì…ë ¥ ì‚¬í•­ì…ë‹ˆë‹¤."
          );
          return;
        }

        const roles = [];
        const roleInputElements = document.querySelectorAll(
          "#roleAssignmentContainer .flex.items-center.gap-2.mb-2"
        );
        roleInputElements.forEach((roleDiv) => {
          const roleNameInput = roleDiv.querySelector('input[type="text"]');
          const roleAssigneeSelect = roleDiv.querySelector("select");
          if (roleNameInput && roleAssigneeSelect) {
            const roleName = roleNameInput.value.trim();
            // Get all selected options for multi-select
            const assignedToIds = Array.from(
              roleAssigneeSelect.selectedOptions
            ).map((option) => option.value);

            if (roleName) {
              // Role name is mandatory
              roles.push({
                name: roleName,
                assignedTo: assignedToIds,
                content: "",
              });
            }
          }
        });

        if (roles.length === 0) {
          showMessageBox(
            "ì—­í•  ë¶„ë‹´ ëˆ„ë½",
            "ìµœì†Œ í•˜ë‚˜ ì´ìƒì˜ ì—­í• ì„ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤."
          );
          return;
        }

        if (isEditMode) {
          const travel = currentGroup.travels.find(
            (t) => t.id === selectedTravelId
          );
          if (travel) {
            travel.name = name;
            travel.startDate = startDate;
            travel.endDate = endDate;
            travel.memo = memo;
            // Preserve existing content for roles if they still exist
            const updatedRoles = roles.map((newRole) => {
              const existingRole = travel.roles.find(
                (oldRole) => oldRole.name === newRole.name
              );
              return {
                ...newRole,
                content: existingRole ? existingRole.content : "", // Keep old content if role name matches
              };
            });
            travel.roles = updatedRoles;
            showMessageBox("ì„±ê³µ", "ì—¬í–‰ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); // Changed message
          }
        } else {
          const newTravel = {
            id: generateUniqueId("travel"),
            name,
            startDate,
            endDate,
            memo,
            notice: "", // Initialize with empty notice
            roles,
          };
          currentGroup.travels.push(newTravel);
          showMessageBox("ì„±ê³µ", "ìƒˆ ì—¬í–‰ ì¼ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        closeModal("travelFormModal");
        renderTravels(); // Re-render to reflect changes
        selectedTravelId = null; // Clear selected ID
      }

      function openTravelRoleEditModal(travelId, roleName) {
        selectedTravelId = travelId;
        selectedTravelRoleName = roleName;

        const travel = currentGroup.travels.find((t) => t.id === travelId);
        if (travel) {
          // Find the specific role for the current user
          const role = travel.roles.find(
            (r) =>
              r.name === roleName &&
              r.assignedTo.includes(mockData.currentUser.id)
          );
          if (role) {
            document.getElementById(
              "travelRoleEditModalTitle"
            ).textContent = `${travel.name} - ${roleName} ì—­í•  ë‚´ìš© ìˆ˜ì •`;
            document.getElementById("travelRoleContent").value = role.content;
            openModal("travelRoleEditModal");
          } else {
            showMessageBox(
              "ê¶Œí•œ ì—†ìŒ",
              "ì´ ì—­í• ì˜ ë‹´ë‹¹ìê°€ ì•„ë‹ˆê±°ë‚˜ ì—­í• ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            );
          }
        }
      }

      function saveTravelRoleContent() {
        const travel = currentGroup.travels.find(
          (t) => t.id === selectedTravelId
        );
        if (travel) {
          // Find the specific role for the current user
          const role = travel.roles.find(
            (r) =>
              r.name === selectedTravelRoleName &&
              r.assignedTo.includes(mockData.currentUser.id)
          );
          if (role) {
            role.content = document.getElementById("travelRoleContent").value;
            closeModal("travelRoleEditModal");
            showMessageBox("ì„±ê³µ", "ì—­í•  ë‚´ìš©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            viewTravelDetails(selectedTravelId); // Re-render details to show updated notice
          }
        }
      }

      // --- Travel Notice Functions ---
      function openTravelNoticeEditModal(travelId) {
        selectedTravelId = travelId;
        const travel = currentGroup.travels.find((t) => t.id === travelId);
        if (travel) {
          document.getElementById("travelNoticeContent").value =
            travel.notice || "";
          openModal("travelNoticeEditModal");
        } else {
          showMessageBox("ì˜¤ë¥˜", "ì—¬í–‰ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
      }

      function saveTravelNoticeContent() {
        const travel = currentGroup.travels.find(
          (t) => t.id === selectedTravelId
        );
        if (travel) {
          travel.notice = document.getElementById("travelNoticeContent").value;
          closeModal("travelNoticeEditModal");
          showMessageBox("ì„±ê³µ", "ê³µì§€ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
          viewTravelDetails(selectedTravelId); // Re-render details to show updated notice
        }
      }

      // --- Birthdays Tab Functions ---
      function renderBirthdays() {
        const contentDiv = document.getElementById("content");
        contentDiv.innerHTML = `
                <div class="section-header">
                    <h2 class="section-title">ğŸ ìƒì¼ ëª©ë¡</h2>
                    <button class="btn btn-blue" onclick="openBirthdayAssignModal()">ìƒì¼ ë‹´ë‹¹ì ì§€ì •</button>
                </div>
                <div id="birthdaysList">
                    <!-- Birthdays will be listed here -->
                </div>
            `;

        const birthdaysListDiv = document.getElementById("birthdaysList");
        if (currentGroup.birthdays.length === 0) {
          birthdaysListDiv.innerHTML =
            '<p class="text-gray-600">ì•„ì§ ë“±ë¡ëœ ìƒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        // Sort birthdays by upcoming date
        const sortedBirthdays = [...currentGroup.birthdays].sort((a, b) => {
          const today = new Date();
          const currentYear = today.getFullYear();

          const dateA = new Date(`${currentYear}-${a.date}`);
          const dateB = new Date(`${currentYear}-${b.date}`);

          // If birthday has passed this year, consider it for next year
          if (dateA < today) dateA.setFullYear(today.getFullYear() + 1);
          if (dateB < today) dateB.setFullYear(today.getFullYear() + 1);

          return dateA - dateB;
        });

        sortedBirthdays.forEach((birthday) => {
          const userName = getUserNameById(birthday.userId);
          const assignedToName = birthday.assignedTo
            ? getUserNameById(birthday.assignedTo)
            : "ë¯¸ì§€ì •";
          const statusClass = birthday.assignedTo ? "assigned" : "unassigned";

          const birthdayCard = document.createElement("div");
          birthdayCard.className = "card";
          birthdayCard.innerHTML = `
                    <div class="card-title">${userName}ì˜ ìƒì¼</div>
                    <div class="card-subtitle">ë‚ ì§œ: ${birthday.date}</div>
                    <p class="card-text">
                        ë‹´ë‹¹ì: <span class="status-badge ${statusClass}">${assignedToName}</span>
                    </p>
                    <div class="flex gap-2 mt-4">
                        <button class="btn btn-outline" onclick="viewBirthdayDetails('${
                          birthday.userId
                        }')">ìƒì„¸ ë³´ê¸°</button>
                        ${
                          birthday.assignedTo === mockData.currentUser.id &&
                          birthday.userId !== mockData.currentUser.id
                            ? `<button class="btn btn-green" onclick="openBirthdayPrepareModal('${birthday.userId}')">ì¤€ë¹„ í˜„í™© ê³µìœ </button>`
                            : ""
                        }
                    </div>
                `;
          birthdaysListDiv.appendChild(birthdayCard);
        });
      }

      function viewBirthdayDetails(userId) {
        const birthday = currentGroup.birthdays.find(
          (b) => b.userId === userId
        );
        if (!birthday) {
          showMessageBox("ì˜¤ë¥˜", "ìƒì¼ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // If the current user is the birthday person, prevent viewing details
        if (userId === mockData.currentUser.id) {
          showMessageBox(
            "ì ‘ê·¼ ì œí•œ",
            "ìì‹ ì˜ ìƒì¼ ì¤€ë¹„ í˜„í™©ì€ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          );
          changeTab("birthdays"); // Go back to the birthdays list
          return;
        }

        const userName = getUserNameById(birthday.userId);
        const assignedToName = birthday.assignedTo
          ? getUserNameById(birthday.assignedTo)
          : "ë¯¸ì§€ì •";
        const statusClass = birthday.assignedTo ? "assigned" : "unassigned";

        const contentDiv = document.getElementById("content");
        contentDiv.innerHTML = `
                <div class="section-header">
                    <h2 class="section-title">ğŸ ${userName}ì˜ ìƒì¼ ìƒì„¸</h2>
                    <button class="btn btn-outline" onclick="changeTab('birthdays')">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                </div>
                <div class="detail-item">
                    <h3>ìƒì¼ ì •ë³´</h3>
                    <p><strong>ì´ë¦„:</strong> ${userName}</p>
                    <p><strong>ë‚ ì§œ:</strong> ${birthday.date}</p>
                    <p><strong>ë‹´ë‹¹ì:</strong> <span class="status-badge ${statusClass}">${assignedToName}</span></p>
                </div>
                <div class="detail-item mt-4">
                    <h3>ì¤€ë¹„ í˜„í™©</h3>
                    <p>${
                      birthday.preparation
                        ? birthday.preparation.replace(/\n/g, "<br>")
                        : "ì•„ì§ ì¤€ë¹„ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."
                    }</p>
                </div>
                <div class="flex gap-2 mt-4">
                    ${
                      birthday.assignedTo === mockData.currentUser.id &&
                      birthday.userId !== mockData.currentUser.id
                        ? `<button class="btn btn-green" onclick="openBirthdayPrepareModal('${birthday.userId}')">ì¤€ë¹„ í˜„í™© ê³µìœ </button>`
                        : ""
                    }
                </div>
            `;
      }

      function openBirthdayAssignModal() {
        // Find the next upcoming birthday that doesn't have an assigned person yet
        const unassignedBirthdays = currentGroup.birthdays.filter(
          (b) => !b.assignedTo
        );

        if (unassignedBirthdays.length === 0) {
          // If all birthdays have been assigned, reset the assignment history for a new cycle
          // The current user (í–‰ì„±ì´) is excluded from being assigned their own birthday.
          // So, the number of assignable members is `currentGroup.members.length - 1`.
          const assignableMembersCount = currentGroup.members.length - 1;
          if (
            currentGroup.birthdayAssignmentHistory.length >=
            assignableMembersCount
          ) {
            currentGroup.birthdayAssignmentHistory = [];
            showMessageBox(
              "ì•Œë¦¼",
              "ëª¨ë“  ìƒì¼ ë‹´ë‹¹ì ì§€ì •ì´ ì™„ë£Œë˜ì–´, ìƒˆë¡œìš´ ë‹´ë‹¹ì ì§€ì • ì£¼ê¸°ê°€ ì‹œì‘ë©ë‹ˆë‹¤!"
            );
          } else {
            showMessageBox(
              "ì•Œë¦¼",
              "ëª¨ë“  ìƒì¼ ë‹´ë‹¹ìê°€ ì§€ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ë‹´ë‹¹ì ì§€ì •ì€ ë‹¤ìŒ ì£¼ê¸°ì— ê°€ëŠ¥í•©ë‹ˆë‹¤."
            );
            return;
          }
        }

        const sortedUnassignedBirthdays = [...unassignedBirthdays].sort(
          (a, b) => {
            const today = new Date();
            const currentYear = today.getFullYear();

            const dateA = new Date(`${currentYear}-${a.date}`);
            const dateB = new Date(`${currentYear}-${b.date}`);

            // If birthday has passed this year, consider it for next year
            if (dateA < today) dateA.setFullYear(today.getFullYear() + 1);
            if (dateB < today) dateB.setFullYear(today.getFullYear() + 1);

            return dateA - dateB;
          }
        );

        const nextBirthday = sortedUnassignedBirthdays[0];

        if (!nextBirthday) {
          showMessageBox("ì•Œë¦¼", "í˜„ì¬ ì§€ì •í•  ìˆ˜ ìˆëŠ” ìƒì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        selectedBirthdayUserId = nextBirthday.userId;
        document.getElementById(
          "birthdayAssignInfo"
        ).textContent = `ë‹¤ìŒ ìƒì¼: ${getUserNameById(nextBirthday.userId)} (${
          nextBirthday.date
        })`;
        document.getElementById("assignedBirthdayPerson").textContent =
          "ë¯¸ì§€ì •"; // Reset display

        openModal("birthdayAssignModal");
      }

      function assignBirthdayHandler() {
        if (!selectedBirthdayUserId) {
          showMessageBox("ì˜¤ë¥˜", "ìƒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }

        const birthdayToAssign = currentGroup.birthdays.find(
          (b) => b.userId === selectedBirthdayUserId
        );
        if (!birthdayToAssign) return;

        const potentialAssignees = currentGroup.members.filter(
          (memberId) =>
            memberId !== birthdayToAssign.userId && // Exclude the birthday person
            !currentGroup.birthdayAssignmentHistory.includes(memberId) // Exclude those already assigned in this cycle
        );

        if (potentialAssignees.length === 0) {
          // If all eligible members have been assigned in this cycle, reset history and try again
          currentGroup.birthdayAssignmentHistory = [];
          showMessageBox(
            "ì•Œë¦¼",
            "ëª¨ë“  ì¹œêµ¬ê°€ í•œ ë²ˆì”© ìƒì¼ ë‹´ë‹¹ì„ í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ë‹´ë‹¹ì ì§€ì • ì£¼ê¸°ê°€ ì‹œì‘ë©ë‹ˆë‹¤!"
          );
          // After resetting history, try to assign again. This handles the case where all members *except* the birthday person have been assigned.
          // We need to re-filter potential assignees after resetting history.
          const newPotentialAssignees = currentGroup.members.filter(
            (memberId) =>
              memberId !== birthdayToAssign.userId &&
              !currentGroup.birthdayAssignmentHistory.includes(memberId)
          );
          if (newPotentialAssignees.length === 0) {
            showMessageBox(
              "ì•Œë¦¼",
              "í˜„ì¬ ë‹´ë‹¹ìë¡œ ì§€ì •í•  ìˆ˜ ìˆëŠ” ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  ì¹œêµ¬ê°€ ì´ë¯¸ ë‹´ë‹¹í–ˆìŠµë‹ˆë‹¤."
            );
            closeModal("birthdayAssignModal");
            return;
          }
          const randomIndex = Math.floor(
            Math.random() * newPotentialAssignees.length
          );
          const assignedUserId = newPotentialAssignees[randomIndex];
          birthdayToAssign.assignedTo = assignedUserId;
          currentGroup.birthdayAssignmentHistory.push(assignedUserId);
          document.getElementById("assignedBirthdayPerson").textContent =
            getUserNameById(assignedUserId);
          closeModal("birthdayAssignModal");
          showMessageBox(
            "ì„±ê³µ",
            `${getUserNameById(
              birthdayToAssign.userId
            )}ì˜ ìƒì¼ ë‹´ë‹¹ìë¡œ ${getUserNameById(
              assignedUserId
            )}ë‹˜ì´ ì§€ì •ë˜ì—ˆìŠµë‹ˆë‹¤. (ìƒˆ ì£¼ê¸° ì‹œì‘)`
          );
          renderBirthdays();
          selectedBirthdayUserId = null;
          return;
        }

        const randomIndex = Math.floor(
          Math.random() * potentialAssignees.length
        );
        const assignedUserId = potentialAssignees[randomIndex];

        birthdayToAssign.assignedTo = assignedUserId;
        currentGroup.birthdayAssignmentHistory.push(assignedUserId); // Add to history for this cycle

        document.getElementById("assignedBirthdayPerson").textContent =
          getUserNameById(assignedUserId);
        closeModal("birthdayAssignModal");
        showMessageBox(
          "ì„±ê³µ",
          `${getUserNameById(
            birthdayToAssign.userId
          )}ì˜ ìƒì¼ ë‹´ë‹¹ìë¡œ ${getUserNameById(
            assignedUserId
          )}ë‹˜ì´ ì§€ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`
        );
        renderBirthdays();
        selectedBirthdayUserId = null;
      }

      function openBirthdayPrepareModal(userId) {
        selectedBirthdayUserId = userId;
        const birthday = currentGroup.birthdays.find(
          (b) => b.userId === userId
        );
        if (birthday && birthday.assignedTo === mockData.currentUser.id) {
          document.getElementById(
            "birthdayPrepareModalTitle"
          ).textContent = `${getUserNameById(userId)} ìƒì¼ ì¤€ë¹„ í˜„í™© ê³µìœ `;
          document.getElementById("birthdayPreparationContent").value =
            birthday.preparation;
          openModal("birthdayPrepareModal");
        } else {
          showMessageBox(
            "ê¶Œí•œ ì—†ìŒ",
            "ì´ ìƒì¼ì˜ ë‹´ë‹¹ìê°€ ì•„ë‹ˆê±°ë‚˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          );
        }
      }

      function saveBirthdayPreparation() {
        const birthday = currentGroup.birthdays.find(
          (b) => b.userId === selectedBirthdayUserId
        );
        if (birthday && birthday.assignedTo === mockData.currentUser.id) {
          birthday.preparation = document.getElementById(
            "birthdayPreparationContent"
          ).value;
          closeModal("birthdayPrepareModal");
          showMessageBox("ì„±ê³µ", "ìƒì¼ ì¤€ë¹„ í˜„í™©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
          viewBirthdayDetails(selectedBirthdayUserId); // Re-render details
        }
      }

      // --- Expenses Tab Functions ---
      function renderExpenses() {
        const contentDiv = document.getElementById("content");
        contentDiv.innerHTML = `
                <div class="section-header">
                    <h2 class="section-title">ğŸ’° íšŒë¹„ ëª©ë¡</h2>
                    <button class="btn btn-blue" onclick="openModal('expenseCreateModal')">íšŒë¹„ í•­ëª© ìƒì„±</button>
                </div>
                <div id="expensesList">
                    <!-- Expenses will be listed here -->
                </div>
            `;

        const expensesListDiv = document.getElementById("expensesList");
        if (currentGroup.expenses.length === 0) {
          expensesListDiv.innerHTML =
            '<p class="text-gray-600">ì•„ì§ ë“±ë¡ëœ íšŒë¹„ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        currentGroup.expenses.forEach((expense) => {
          const currentUserPaid = expense.payers.find(
            (p) => p.userId === mockData.currentUser.id
          )?.paid;
          const paidStatusText = currentUserPaid ? "ì œì¶œ ì™„ë£Œ" : "ë¯¸ì œì¶œ";
          const paidStatusClass = currentUserPaid ? "paid" : "unpaid";

          const expenseCard = document.createElement("div");
          expenseCard.className = "card";
          let payersHtml = "";
          currentGroup.members.forEach((memberId) => {
            const payer = expense.payers.find((p) => p.userId === memberId);
            const pPaidStatus = payer ? payer.paid : false;
            const pStatusText = pPaidStatus ? "ì œì¶œ ì™„ë£Œ" : "ë¯¸ì œì¶œ";
            const pStatusClass = pPaidStatus ? "paid" : "unpaid";
            const nagKey = `nag-expense-${expense.id}-${memberId}`;
            const canNag =
              !lastNagTimes[nagKey] ||
              Date.Now() - lastNagTimes[nagKey] > COOLDOWN_DURATION;
            const nagButtonHtml =
              !pPaidStatus && canNag
                ? `<button class="btn btn-outline text-xs py-1 px-2 ml-2" onclick="nagPayer('${expense.id}', '${memberId}')">ğŸ›ï¸ ì¬ì´‰</button>`
                : !pPaidStatus && !canNag
                ? `<button class="btn btn-outline text-xs py-1 px-2 ml-2 opacity-50 cursor-not-allowed" disabled>ğŸ›ï¸ ì¬ì´‰ (ì¿¨ë‹¤ìš´)</button>`
                : "";
            payersHtml += `<li><strong>${getUserNameById(
              memberId
            )}</strong>: <span class="status-badge ${pStatusClass}">${pStatusText}</span>${nagButtonHtml}</li>`;
          });

          expenseCard.innerHTML = `
                    <div class="card-title">${expense.name}</div>
                    <div class="card-subtitle">ê¸ˆì•¡: ${expense.amount.toLocaleString()}ì› | ë§ˆê°ì¼: ${
            expense.deadline
          }</div>
                    <p class="card-text">
                        ë‚´ ìƒíƒœ: <span class="status-badge ${paidStatusClass}">${paidStatusText}</span>
                    </p>
                    <div class="flex gap-2 mt-4">
                        <button class="btn btn-outline" onclick="viewExpenseDetails('${
                          expense.id
                        }')">ìƒì„¸ ë³´ê¸°</button>
                        ${
                          !currentUserPaid
                            ? `<button class="btn btn-green" onclick="markExpensePaid('${expense.id}')">ì œì¶œ ì™„ë£Œ</button>`
                            : ""
                        }
                    </div>
                `;
          expensesListDiv.appendChild(expenseCard);
        });
      }

      function viewExpenseDetails(expenseId) {
        const expense = currentGroup.expenses.find((e) => e.id === expenseId);
        if (!expense) {
          showMessageBox("ì˜¤ë¥˜", "íšŒë¹„ í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        let payersHtml = "<ul>";
        currentGroup.members.forEach((memberId) => {
          const payer = expense.payers.find((p) => p.userId === memberId);
          const paidStatus = payer ? payer.paid : false; // Default to false if not found
          const statusText = paidStatus ? "ì œì¶œ ì™„ë£Œ" : "ë¯¸ì œì¶œ"; // Defined statusText here
          const statusClass = paidStatus ? "paid" : "unpaid";
          const nagKey = `nag-expense-${expense.id}-${memberId}`;
          const canNag =
            !lastNagTimes[nagKey] ||
            Date.now() - lastNagTimes[nagKey] > COOLDOWN_DURATION;
          const nagButtonHtml =
            !paidStatus && canNag
              ? `<button class="btn btn-outline text-xs py-1 px-2 ml-2" onclick="nagPayer('${expense.id}', '${memberId}')">ğŸ›ï¸ ì¬ì´‰</button>`
              : !paidStatus && !canNag
              ? `<button class="btn btn-outline text-xs py-1 px-2 ml-2 opacity-50 cursor-not-allowed" disabled>ğŸ›ï¸ ì¬ì´‰ (ì¿¨ë‹¤ìš´)</button>`
              : "";
          payersHtml += `<li><strong>${getUserNameById(
            memberId
          )}</strong>: <span class="status-badge ${statusClass}">${statusText}</span>${nagButtonHtml}</li>`; // Used statusText
        });
        payersHtml += "</ul>";

        const currentUserPaid = expense.payers.find(
          (p) => p.userId === mockData.currentUser.id
        )?.paid;
        const markPaidButtonHtml = !currentUserPaid
          ? `<button class="btn btn-green" onclick="markExpensePaid('${expense.id}')">ì œì¶œ ì™„ë£Œ</button>`
          : "";

        const contentDiv = document.getElementById("content");
        contentDiv.innerHTML = `
                <div class="section-header">
                    <h2 class="section-title">ğŸ’° ${expense.name} ìƒì„¸</h2>
                    <button class="btn btn-outline" onclick="changeTab('expenses')">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                </div>
                <div class="detail-item">
                    <h3>íšŒë¹„ ì •ë³´</h3>
                    <p><strong>ê¸ˆì•¡:</strong> ${expense.amount.toLocaleString()}ì›</p>
                    <p><strong>ë§ˆê°ì¼:</strong> ${expense.deadline}</p>
                    <p><strong>ë²Œì¹™:</strong> ${expense.penalty || "ì—†ìŒ"}</p>
                </div>
                <div class="detail-item">
                    <h3>ì œì¶œ í˜„í™©</h3>
                    ${payersHtml}
                </div>
                <div class="flex gap-2 mt-4">
                    ${markPaidButtonHtml}
                </div>
            `;
      }

      function createExpense() {
        const name = document.getElementById("expenseName").value;
        const amount = parseInt(document.getElementById("expenseAmount").value);
        const deadline = document.getElementById("expenseDeadline").value;
        const penalty = document.getElementById("expensePenalty").value;

        if (!name || isNaN(amount) || !deadline) {
          showMessageBox(
            "í•„ìˆ˜ ì •ë³´ ëˆ„ë½",
            "íšŒë¹„ í•­ëª© ì´ë¦„, ê¸ˆì•¡, ë§ˆê°ì¼ì€ í•„ìˆ˜ ì…ë ¥ ì‚¬í•­ì…ë‹ˆë‹¤."
          );
          return;
        }

        const newExpense = {
          id: generateUniqueId("expense"),
          name,
          amount,
          deadline,
          penalty,
          payers: currentGroup.members.map((userId) => ({
            userId: userId,
            paid: false,
          })),
        };

        // Set current user as paid by default if they are the creator or if it's a new expense they create.
        // For simplicity, let's assume they are not automatically paid on creation unless specified.
        // The scenario implies "ê¹€ìˆ˜ë¦°ì´ íšŒë¹„ í•­ëª© ìƒì„±" í›„ "ê¹€ì‹œì›ì´ ì œì¶œ ì™„ë£Œ" ì´ë¯€ë¡œ, ìƒì„± ì‹œì—ëŠ” ëª¨ë‘ ë¯¸ë‚©ìœ¼ë¡œ ë‘¡ë‹ˆë‹¤.

        currentGroup.expenses.push(newExpense);
        closeModal("expenseCreateModal");
        showMessageBox("ì„±ê³µ", "ìƒˆ íšŒë¹„ í•­ëª©ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
        renderExpenses();
      }

      function markExpensePaid(expenseId) {
        const expense = currentGroup.expenses.find((e) => e.id === expenseId);
        if (expense) {
          let payer = expense.payers.find(
            (p) => p.userId === mockData.currentUser.id
          );
          if (!payer) {
            payer = { userId: mockData.currentUser.id, paid: false };
            expense.payers.push(payer);
          }
          payer.paid = true;
          showMessageBox("ì„±ê³µ", "íšŒë¹„ ì œì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
          renderExpenses(); // Re-render to reflect changes
        }
      }

      // --- Nag Functions ---
      function nagParticipant(meetingId, userId) {
        const nagKey = `nag-meeting-${meetingId}-${userId}`;
        if (Date.now() - (lastNagTimes[nagKey] || 0) < COOLDOWN_DURATION) {
          showMessageBox("ì•Œë¦¼", "ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. (5ë¶„ ì¿¨ë‹¤ìš´)");
          return;
        }
        lastNagTimes[nagKey] = Date.now();
        const userName = getUserNameById(userId);
        const meeting = currentGroup.meetings.find((m) => m.id === meetingId);
        showMessageBox(
          "ì¬ì´‰ ì™„ë£Œ",
          `ğŸ›ï¸ ${userName}ë‹˜ì—ê²Œ "${meeting.name}" ì•½ì† ì°¸ì—¬ë¥¼ ì¬ì´‰í–ˆìŠµë‹ˆë‹¤.`
        );
        // Re-render to update button state (disabled)
        if (currentTab === "meetings") {
          // Only re-render if on the meetings tab
          renderMeetings();
        } else if (document.getElementById("meetingDetailsView")) {
          // If on detail view
          viewMeetingDetails(meetingId);
        }
      }

      function nagRole(travelId, roleName, assignedToIdsString) {
        // assignedToIdsString is comma-separated
        const assignedToIds = assignedToIdsString.split(",");
        const nagKey = `nag-travel-role-${travelId}-${roleName}`;
        if (Date.now() - (lastNagTimes[nagKey] || 0) < COOLDOWN_DURATION) {
          showMessageBox("ì•Œë¦¼", "ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. (5ë¶„ ì¿¨ë‹¤ìš´)");
          return;
        }
        lastNagTimes[nagKey] = Date.now();
        const travel = currentGroup.travels.find((t) => t.id === travelId);
        const assignedNames = assignedToIds
          .map((id) => getUserNameById(id))
          .join(", ");
        showMessageBox(
          "ì¬ì´‰ ì™„ë£Œ",
          `ğŸ›ï¸ ${assignedNames}ë‹˜ì—ê²Œ "${travel.name}" ì—¬í–‰ì˜ "${roleName}" ì—…ë¬´ë¥¼ ì¬ì´‰í–ˆìŠµë‹ˆë‹¤.`
        );
        // Re-render to update button state (disabled)
        if (currentTab === "travels") {
          // Only re-render if on the travels tab
          viewTravelDetails(travelId);
        }
      }

      function nagPayer(expenseId, userId) {
        const nagKey = `nag-expense-${expenseId}-${userId}`;
        if (Date.now() - (lastNagTimes[nagKey] || 0) < COOLDOWN_DURATION) {
          showMessageBox("ì•Œë¦¼", "ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. (5ë¶„ ì¿¨ë‹¤ìš´)");
          return;
        }
        lastNagTimes[nagKey] = Date.now();
        const userName = getUserNameById(userId);
        const expense = currentGroup.expenses.find((e) => e.id === expenseId);
        showMessageBox(
          "ì¬ì´‰ ì™„ë£Œ",
          `ğŸ›ï¸ ${userName}ë‹˜ì—ê²Œ "${expense.name}" íšŒë¹„ ì œì¶œì„ ì¬ì´‰í–ˆìŠµë‹ˆë‹¤.`
        );
        // Re-render to update button state (disabled)
        if (currentTab === "expenses") {
          // Only re-render if on the expenses tab
          renderExpenses();
        } else if (document.getElementById("expenseDetailsView")) {
          // If on detail view
          viewExpenseDetails(expenseId);
        }
      }

      // --- New Group Functions ---
      let customCategoryCounter = 0; // To ensure unique IDs for custom category inputs
      function addCustomCategoryInput() {
        const container = document.getElementById("customCategoriesContainer");
        const newIndex = customCategoryCounter++;
        const div = document.createElement("div");
        div.className = "flex items-center gap-2 mb-2";
        div.innerHTML = `
                <input type="text" id="customCategoryName-${newIndex}" placeholder="ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„ (ì˜ˆ: ë§ˆë¼í†¤)" class="flex-1" required>
                <button class="btn btn-red px-3 py-2 text-sm" onclick="this.parentNode.remove()">ì‚­ì œ</button>
            `;
        container.appendChild(div);
      }

      function createNewGroup() {
        const newGroupName = document.getElementById("newGroupName").value;
        const newGroupPassword =
          document.getElementById("newGroupPassword").value;

        if (!newGroupName || !newGroupPassword) {
          showMessageBox(
            "í•„ìˆ˜ ì •ë³´ ëˆ„ë½",
            "ëª¨ì„ ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ëŠ” í•„ìˆ˜ ì…ë ¥ ì‚¬í•­ì…ë‹ˆë‹¤."
          );
          return;
        }

        // Get selected default categories
        const selectedCategories = [];
        const defaultCategoryCheckboxes = [
          "category-meetings",
          "category-travels",
          "category-birthdays",
          "category-expenses",
        ];
        selectedCategories.push({
          id: "dashboard",
          name: "ëŒ€ì‹œë³´ë“œ",
          type: "system",
        }); // Dashboard is always included
        selectedCategories.push({
          id: "members",
          name: "ë©¤ë²„",
          type: "system",
        }); // Members is always included
        defaultCategoryCheckboxes.forEach((checkboxId) => {
          const checkbox = document.getElementById(checkboxId);
          if (checkbox && checkbox.checked) {
            selectedCategories.push({
              id: checkbox.value,
              name: checkbox.labels[0].textContent.trim(),
              type: "default",
            });
          }
        });

        // Get custom categories
        for (let i = 0; i < customCategoryCounter; i++) {
          const customCategoryInput = document.getElementById(
            `customCategoryName-${i}`
          );
          if (customCategoryInput && customCategoryInput.value.trim() !== "") {
            const customName = customCategoryInput.value.trim();
            const customId = customName.replace(/\s+/g, "-").toLowerCase(); // Simple ID generation
            selectedCategories.push({
              id: customId,
              name: customName,
              type: "custom",
            });
          }
        }

        if (selectedCategories.length === 2) {
          // Only dashboard and members selected
          showMessageBox(
            "ì¹´í…Œê³ ë¦¬ ì„ íƒ",
            "ìµœì†Œ í•˜ë‚˜ ì´ìƒì˜ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤."
          );
          return;
        }

        const newGroup = {
          id: generateUniqueId("group"),
          name: newGroupName,
          password: newGroupPassword,
          members: [mockData.currentUser.id], // Creator is the first member
          categories: selectedCategories,
          meetings: [],
          travels: [],
          birthdays: [],
          expenses: [],
          birthdayAssignmentHistory: [],
          // Custom category data will be added dynamically if needed
        };

        // Initialize data structures for selected categories
        selectedCategories.forEach((cat) => {
          if (cat.type === "default" || cat.type === "custom") {
            // For simplicity, custom categories will also be initialized as empty arrays
            // More complex logic would be needed here to define their specific data structure
            if (!newGroup[cat.id]) {
              newGroup[cat.id] = [];
            }
          }
        });

        mockData.groups.push(newGroup);
        closeModal("groupCreateModal");
        showMessageBox(
          "ëª¨ì„ ìƒì„± ì™„ë£Œ",
          `'${newGroupName}' ëª¨ì„ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`
        );
        renderGroupList(); // Re-render group list to show new group
        // Reset modal inputs
        document.getElementById("newGroupName").value = "";
        document.getElementById("newGroupPassword").value = "";
        defaultCategoryCheckboxes.forEach((checkboxId) => {
          const checkbox = document.getElementById(checkboxId);
          if (checkbox) checkbox.checked = true; // Reset to default checked
        });
        document.getElementById("customCategoriesContainer").innerHTML = ""; // Clear custom inputs
        customCategoryCounter = 0;
      }

      function copyInviteLink() {
        if (!currentGroup) return;
        const inviteLink = `ëª¨ì„ ì´ë¦„: ${currentGroup.name}\në¹„ë°€ë²ˆí˜¸: ${currentGroup.password}\n(ì´ ë§í¬ëŠ” ê°€ìƒ ë§í¬ì´ë©°, ì‹¤ì œ ì´ˆëŒ€ ê¸°ëŠ¥ì€ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.)`;

        // Use document.execCommand('copy') for broader compatibility in iframes
        const textarea = document.createElement("textarea");
        textarea.value = inviteLink;
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand("copy");
          showMessageBox(
            "ë§í¬ ë³µì‚¬ ì™„ë£Œ",
            "ëª¨ì„ ì •ë³´ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
          );
        } catch (err) {
          showMessageBox(
            "ë³µì‚¬ ì‹¤íŒ¨",
            "í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”."
          );
        }
        document.body.removeChild(textarea);
      }

      // Function to render content for custom categories
      function renderCustomCategoryContent(categoryId) {
        const contentDiv = document.getElementById("content");
        const category = currentGroup.categories.find(
          (c) => c.id === categoryId
        );

        if (!category) {
          showMessageBox("ì˜¤ë¥˜", "ì¹´í…Œê³ ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // For simplicity, custom categories will display a generic message and a placeholder for items
        // In a real application, this would involve more complex data structures and UI for each custom type
        contentDiv.innerHTML = `
                <div class="section-header">
                    <h2 class="section-title">${category.name}</h2>
                    <button class="btn btn-blue" onclick="openModal('customCategoryItemCreateModal')">ìƒˆ ${category.name} í•­ëª© ì¶”ê°€</button>
                </div>
                <div id="${categoryId}List">
                    <p class="text-gray-600">ì•„ì§ ${category.name} í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p class="text-gray-500 text-sm mt-2">ì´ê²ƒì€ ì‚¬ìš©ì ì •ì˜ ì¹´í…Œê³ ë¦¬ì…ë‹ˆë‹¤. ì‹¤ì œ ë°ì´í„° ë° ê¸°ëŠ¥ì€ ì¶”ê°€ êµ¬í˜„ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                </div>
            `;
        // You would typically have a modal and functions to add/view items for custom categories
        // e.g., openModal('customCategoryItemCreateModal', () => setupCustomCategoryItemModal(categoryId));
      }

      // --- Leave Group Functions ---
      let leaveGroupId = null; // Stores the ID of the group to be left

      function openLeaveGroupModal(groupId) {
        leaveGroupId = groupId;
        const group = mockData.groups.find((g) => g.id === groupId);
        if (!group) {
          showMessageBox("ì˜¤ë¥˜", "ëª¨ì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        document.getElementById(
          "leaveGroupModalTitle"
        ).textContent = `'${group.name}' ëª¨ì„ ë‚˜ê°€ê¸°`;
        document.getElementById(
          "leaveGroupConfirmText"
        ).textContent = `ì •ë§ '${group.name}' ëª¨ì„ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?`;
        document.getElementById("leaveQuietlyCheckbox").checked = false; // Reset checkbox state
        openModal("leaveGroupConfirmModal");
      }

      function confirmLeaveGroup() {
        if (!leaveGroupId) return;

        const leaveQuietly = document.getElementById(
          "leaveQuietlyCheckbox"
        ).checked;
        const groupIndex = mockData.groups.findIndex(
          (g) => g.id === leaveGroupId
        );

        if (groupIndex === -1) {
          showMessageBox("ì˜¤ë¥˜", "ëª¨ì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          closeModal("leaveGroupConfirmModal");
          return;
        }

        const group = mockData.groups[group];

        // Remove current user from the group's members list
        group.members = group.members.filter(
          (memberId) => memberId !== mockData.currentUser.id
        );

        // If the group becomes empty, remove it (optional, based on desired behavior)
        if (group.members.length === 0) {
          mockData.groups.splice(groupIndex, 1);
          showMessageBox(
            "ëª¨ì„ íƒˆí‡´ ì™„ë£Œ",
            `'${group.name}' ëª¨ì„ì—ì„œ ì„±ê³µì ìœ¼ë¡œ íƒˆí‡´í–ˆìœ¼ë©°, ëª¨ì„ì— ë‚¨ì€ ë©¤ë²„ê°€ ì—†ì–´ ëª¨ì„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`
          );
        } else {
          if (leaveQuietly) {
            showMessageBox(
              "ëª¨ì„ íƒˆí‡´ ì™„ë£Œ",
              `'${group.name}' ëª¨ì„ì—ì„œ ì¡°ìš©íˆ íƒˆí‡´í–ˆìŠµë‹ˆë‹¤.`
            );
          } else {
            showMessageBox(
              "ëª¨ì„ íƒˆí‡´ ì™„ë£Œ",
              `'${group.name}' ëª¨ì„ì—ì„œ íƒˆí‡´í–ˆìŠµë‹ˆë‹¤.`
            );
            // In a real app, you might notify other members here
          }
        }

        closeModal("leaveGroupConfirmModal");
        renderGroupList(); // Go back to group list
        leaveGroupId = null; // Reset
      }

      // --- Initial Load ---
      document.addEventListener("DOMContentLoaded", () => {
        renderGroupList();
      });
    </script>
  </body>
</html>
